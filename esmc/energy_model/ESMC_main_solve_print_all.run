################################################################################
################################################################################                                                    
##																			  ##
##                     			SETTING PROBLEM								  ##                                                    
##																			  ##
################################################################################
################################################################################

# Load standard model
model ESMC_model_AMPL.mod;

# Load standard data
data reg_14TD.dat; # TDs depending data
data indep.dat # not TDs depending data, not REGIONS depending data
data reg_demands.dat   # not TDs depending data, but REGIONS depending data
data reg_resources.dat
data reg_technologies.dat
data reg_storage_power_to_energy.dat
data reg_misc.dat
data reg_exch.dat

#solution solution.sol;


################################################################################
################################################################################                                                    
##																			  ##
##                      	SOLVER OPTIONS       							  ##                                                    
##																			  ##
################################################################################
################################################################################

option solver cplex;


option show_stats 3; # show statistics
option times 1; # show time
option gentimes 1; # show time
option presolve 200;

option log_file 'output/log.txt';   #write the log in a .txt file. Create the file before running.

option cplex_options $cplex_options 'timelimit 129600 '; 
option cplex_options $cplex_options 'baropt predual=-1 barstart=4 crossover=0';
option cplex_options $cplex_options 'bardisplay=1';
option cplex_options $cplex_options 'display=2';
option cplex_options $cplex_options 'prestats=1';


#option cplex_options $cplex_options 'aggregate=-1';
#option cplex_options $cplex_options 'prereduce=1';
#option cplex_options  'mipdisplay 5 mipinterval 1000';
#option cplex_options $cplex_options 'mipgap 0.01 ';
#option cplex_options $cplex_options 'scale=1';
#option cplex_options $cplex_options 'netopt=2';
#option reset_initial_guesses 1;
#option dual_initial_guesses 0;
#option send_statuses 0;

# Saving and starting from last solution. Starting from last solution is not very efficient.
# 
#option cplex_options $cplex_options 'startsol ./output/solution.sol '; # to read previously existing file
#option cplex_options $cplex_options 'endsol ./output/solution.sol '; # to write file 


################################################################################
################################################################################                                                    
##																			  ##
##                      	RUN & SAVE PATH      							  ##                                                    
##																			  ##
################################################################################
################################################################################


param PathName symbolic default "output";
param filePath symbolic default "";
param fileExt symbolic default ".txt";

		#let re_share_primary := 0.5;

		print PathName;
		
		print "gwp_limit_overall", gwp_limit_overall;
		
		print "Number of TDs", last(TYPICAL_DAYS);		
		

		solve;
		
		print "TotalGWP_global", sum{c in REGIONS} (TotalGWP[c]);
		print "GWP_op_global", sum{c in REGIONS, r in RESOURCES} (GWP_op[c,r]);
		print "CO2_net_global", sum{c in REGIONS, r in RESOURCES} (CO2_net[c,r]);
		print "TotalCost_global", sum{c in REGIONS} (TotalCost[c]);
		
		display solve_result;
		display solve_result_num;
		display _solve_elapsed_time;

		## Saving sets and parameters to output file

		option times 0; # show time
		option gentimes 0; # show time

		
		if solve_result = "limit" # To avoid post treatment error
		then print "TIME OUT"; 
		else {
		
			################################################################################
			################################################################################                                                    
			##																			  ##
			##                     			SAVING RESULTS								  ##                                                    
			##																			  ##
			################################################################################
			################################################################################
			## Saving sets and parameters to output file
			option show_stats 0; # show statistics
			option times 0; # show time
			option gentimes 0; # show time
			
			
			###############################################################################                                                    
			#																			  #
			#                     			  LOCAL SYSTEMS    							  #                                                    
			#																			  #
			###############################################################################
			
			
			for {c in REGIONS}{
				#########################################
				#				Year summary			#
				#########################################
				
				#------------------------------------------
				## Print cost breakdown to txt file.
				#------------------------------------------
				print ("--------------SAVING COST  " & c & " -----------");
				printf "%s\t%s\t%s\t%s\n", "Name","C_inv [M€/y]","C_maint [M€/y]","C_op [M€/y]" > ( PathName & "/cost_breakdown_" & c & ".txt"); 
				for {i in TECHNOLOGIES union RESOURCES}{if i in TECHNOLOGIES
				then
						printf "%s\t%.6f\t%.6f\t%.6f\n", i, tau [c,i] * C_inv [c,i], C_maint [c,i], 0 > ( PathName & "/cost_breakdown_" & c & ".txt"); 
				else
						printf "%s\t%.6f\t%.6f\t%.6f\n", i, 0, 0, C_op[c,i] > ( PathName & "/cost_breakdown_" & c & ".txt");
				}
				for {i in EXCHANGE_NETWORK_R}{
					printf "%s%s\t%.6f\t%.6f\t%.6f\n", "Exch network ", i, C_exch_network [c,i], 0, 0 > ( PathName & "/cost_breakdown_" & c & ".txt");
				}
				printf "%s\t%.6f\t%.6f\t%.6f", "Total [M€/y]", sum{i in TECHNOLOGIES} (tau [c,i] * C_inv [c,i]) + sum{i in EXCHANGE_NETWORK_R} C_exch_network [c,i], sum{i in TECHNOLOGIES} C_maint [c,i], sum{i in RESOURCES} C_op[c,i] > ( PathName & "/cost_breakdown_" & c & ".txt");
				

				#------------------------------------------
				## Print GWP breakdown
				#------------------------------------------
				print ("--------------SAVING GWP  " & c & " -----------");

				printf "%s\t%s\t%s\n", "Name", "GWP_constr [kt_CO2eq/y]", "GWP_op [kt_CO2eq/y]", "CO2_net [ktCO2eq/y]" > ( PathName & "/gwp_breakdown_" & c & ".txt");  
				for {i in TECHNOLOGIES union RESOURCES}{if i in TECHNOLOGIES
				then
						printf "%s\t%.6f\t%.6f\t%.6f\n", i, GWP_constr [c,i] / lifetime [c,i], 0, 0 > ( PathName & "/gwp_breakdown_" & c & ".txt"); 
				else
						printf "%s\t%.6f\t%.6f\t%.6f\n", i, 0, GWP_op [c,i], CO2_net [c,i] > ( PathName & "/gwp_breakdown_" & c & ".txt");
						
				}
				
				printf "%s\t%.6f\t%.6f", "Total [ktCO2-eq/y]", sum{i in TECHNOLOGIES} (GWP_constr [c,i] / lifetime [c,i]), sum{i in RESOURCES} GWP_op [c,i] > ( PathName & "/gwp_breakdown_" & c & ".txt"); 


				#------------------------------------------
				## Print losses to txt file
				#------------------------------------------
				print ("--------------SAVING losses  " & c & " -----------");
				
				printf "EUD\tLosses [GWh/y]" > ( PathName & "/losses_" & c & ".txt"); 
				for {i in END_USES_TYPES}{
						printf "\n%s\t%.3f", i, sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t] }(Network_losses [c,i,h,td] )  > ( PathName & "/losses_" & c & ".txt"); 
				}

				#------------------------------------------
				## Print ASSETS to txt file
				#------------------------------------------
				print ("--------------SAVING ASSETS  " & c & " -----------");
				printf "TECHNOLOGIES\tc_inv\tc_maint\tlifetime\tf_min\tf\tf_max\tfmin_perc\tf_perc\tfmax_perc\tc_p_actual\tc_p\ttau\tgwp_constr" > ( PathName & "/Assets_" & c & ".txt"); 
				printf "\nUNITS\t[Meuro/GW]\t[Meuro/(GW*y)]\t[y]\t[GW or GWh]\t[GW or GWh]\t[GW or GWh]\t[0-1]\t[0-1]\t[0-1]\t[0-1]\t[0-1]\t[-]\t[ktCO2-eq./GW or GWh]" > ( PathName & "/Assets_" & c & ".txt"); 
				for {i in END_USES_TYPES, tech in TECHNOLOGIES_OF_END_USES_TYPE[i]}{
					printf "\n%s\t%f\t%f\t%f\t%f\t%f\t%f\t%f\t%f\t%f\t%f\t%f\t%f\t%f",tech,
							C_inv[c,tech],C_maint[c,tech],lifetime[c,tech],f_min[c,tech],F[c,tech],f_max[c,tech],
							fmin_perc[c,tech],if sum {j2 in 
			TECHNOLOGIES_OF_END_USES_TYPE[i], t2 in PERIODS, h2 in HOUR_OF_PERIOD[t2], td2 in TYPICAL_DAY_OF_PERIOD[t2]} (F_t [c,j2, h2, 
			td2] ) > 0 then sum {t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((F_t [c,tech,h,td] ) / sum {j2 in 
			TECHNOLOGIES_OF_END_USES_TYPE[i], t2 in PERIODS, h2 in HOUR_OF_PERIOD[t2], td2 in TYPICAL_DAY_OF_PERIOD[t2]} (F_t [c,j2, h2, 
			td2] )) else 0,
							fmax_perc[c,tech],if F[c,tech] >0 then sum {t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((F_t [c,tech,h,td]) / (8760* F[c,tech])) else 0,c_p[c,tech],tau[c,tech],GWP_constr[c,tech] > ( PathName & "/Assets_" & c & ".txt"); 
				}
				for {tech in STORAGE_TECH union INFRASTRUCTURE}{
					printf "\n%s\t%f\t%f\t%f\t%f\t%f\t%f\t%f\t%f\t%f\t%f\t%f\t%f\t%f",tech,
							C_inv[c,tech],C_maint[c,tech],lifetime[c,tech],f_min[c,tech],F[c,tech],f_max[c,tech],
							fmin_perc[c,tech],
							-1,
							fmax_perc[c,tech],c_p[c,tech],c_p[c,tech],tau[c,tech],GWP_constr[c,tech] > ( PathName & "/Assets_" & c & ".txt"); 
				}
				
				#------------------------------------------
				# YEARLY BALANCE
				#------------------------------------------
				print ("--------- SAVING Yearly balances  " & c & " --------");

				printf "Tech" > ( PathName & "/YearBalance_" & c & ".txt");
				for {l in LAYERS}{
					printf "\t%s",l > ( PathName & "/YearBalance_" & c & ".txt");
				}
				for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{
					printf "\n%s", i > ( PathName & "/YearBalance_" & c & ".txt");
					for {l in LAYERS}{if i in TECHNOLOGIES
					then 
						printf "\t%f", sum {t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										layers_in_out[i, l] * F_t [c, i, h, td] > ( PathName & "/YearBalance_" & c & ".txt");
					else
						printf "\t%f", sum {t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										layers_in_out[i, l] * (R_t_local[c, i, h, td] + R_t_import[c, i, h, td] - (1 + exchange_losses[i]) * R_t_export[c, i, h, td] + R_t_exterior[c, i, h, td]) > ( PathName & "/YearBalance_" & c & ".txt");
					}
				}
				for {j in STORAGE_TECH}{
					printf "\n%s", j > ( PathName & "/YearBalance_" & c & ".txt");
					for {l in LAYERS}{
						printf "\t%f", sum {t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										(Storage_out [c, j, l, h, td] - Storage_in [c, j, l, h, td]) > ( PathName & "/YearBalance_" & c & ".txt");
					}
				}
				printf "\nEND_USES_DEMAND" > ( PathName & "/YearBalance_" & c & ".txt");
				for {l in LAYERS}{
					printf "\t%f", sum {t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
									End_uses [c, l, h, td] > ( PathName & "/YearBalance_" & c & ".txt");
				}

				#------------------------------------------
				# Exchanges balance printing
				#------------------------------------------
				print ("--------- SAVING Exchanges balance  " & c & " --------");

				
				printf "RESOURCES" > (PathName & "/exch_" & c & ".txt");
				for {c2 in REGIONS}{
					printf "\t%s", c2 > (PathName & "/exch_" & c & ".txt");
				}
				
				for{i in RESOURCES}{
					printf "\n%s", i > (PathName & "/exch_" & c & ".txt");
					for{c2 in REGIONS}{
						printf "\t%.6f", sum {t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (Exch_imp[c,c2,i,h,td] - Exch_exp[c,c2,i,h,td]) > (PathName & "/exch_" & c & ".txt");
					}
				}
				

				#------------------------------------------
				# Resources balance
				#------------------------------------------
				print ("--------- SAVING Resources balances  " & c & " --------");

				
				printf "RESOURCES" > (PathName & "/resources_" & c & ".txt");
				printf "\tR_t_local\tR_t_exterior\tR_t_import\tR_t_export" > (PathName & "/resources_" & c & ".txt");
				for{i in RESOURCES}{
					printf "\n%s", i  > (PathName & "/resources_" & c & ".txt");
					printf "\t%.6f\t%.6f\t%.6f\t%.6f", sum {t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} R_t_local[c, i, h, td], sum {t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} R_t_exterior[c, i, h, td],
					sum {t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} R_t_import[c, i, h, td], sum {t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} R_t_export[c, i, h, td] > (PathName & "/resources_" & c & ".txt");
			
				}
				



				#########################################
				#			YEAR HOURLY DATA			#
				#########################################


				#------------------------------------------
				#    STORAGE distribution CURVES
				#------------------------------------------
				print ("--------------SAVING elec Storage YEAR  " & c & " -----------");
				 # storage curves
				printf "Period\tHourofPeriod\tTD" > ( PathName & "/hourly_data_year" & "/Distri_E_stored_" & c & ".txt");
				for {i in STORAGE_TECH diff STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"] diff STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DECEN"]}{
					printf "\t%s", i > ( PathName & "/hourly_data_year" & "/Distri_E_stored_" & c & ".txt");
				}
				for {i in STORAGE_TECH diff STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"] diff STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DECEN"]}{
					printf "\t%s_in" ,{l in LAYERS: storage_eff_in  [i,l] > 0} i > ( PathName & "/hourly_data_year" & "/Distri_E_stored_" & c & ".txt");
					printf "\t%s_out",{l in LAYERS: storage_eff_out [i,l] > 0} i > ( PathName & "/hourly_data_year" & "/Distri_E_stored_" & c & ".txt");
				}
				for {t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}{
					printf "\n%d\t%d\t%d",t,h,td  > ( PathName & "/hourly_data_year" & "/Distri_E_stored_" & c & ".txt");
					for {i in STORAGE_TECH diff STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"] diff STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DECEN"]}{
						printf "\t%f", Storage_level[c, i, t] > ( PathName & "/hourly_data_year" & "/Distri_E_stored_" & c & ".txt");
					}
					for {i in STORAGE_TECH diff STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"] diff STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DECEN"]}{
						printf "\t%f", (sum {l in LAYERS: storage_eff_in [i,l] > 0}
										-(Storage_in [c, i, l, h, td] * storage_eff_in [i, l]))
								> ( PathName & "/hourly_data_year" & "/Distri_E_stored_" & c & ".txt");
						printf "\t%f", (sum {l in LAYERS: storage_eff_in [i,l] > 0}
										(Storage_out [c,i, l, h, td] / storage_eff_out [i, l]))
								> ( PathName & "/hourly_data_year" & "/Distri_E_stored_" & c & ".txt");
						
					}
				}

				print ("--------------SAVING TS Storage YEAR  " & c & " -----------");

				# storage curves
				printf "Period\tHourofPeriod\tTD" > ( PathName & "/hourly_data_year" & "/Distri_TS_" & c & ".txt");
				for {i in STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"] union STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DECEN"]}{
					printf "\t%s", i > ( PathName & "/hourly_data_year" & "/Distri_TS_" & c & ".txt");
				}
				for {i in STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"] union STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DECEN"]}{
					printf "\t%s_in" ,{l in LAYERS: storage_eff_in  [i,l] > 0} i > ( PathName & "/hourly_data_year" & "/Distri_TS_" & c & ".txt");
					printf "\t%s_out",{l in LAYERS: storage_eff_out [i,l] > 0} i > ( PathName & "/hourly_data_year" & "/Distri_TS_" & c & ".txt");
				}
				for {t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}{
					printf "\n%d\t%d\t%d",t,h,td  > ( PathName & "/hourly_data_year" & "/Distri_TS_" & c & ".txt");
					for {i in STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"] union STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DECEN"]}{
						printf "\t%f", Storage_level[c, i, t] > ( PathName & "/hourly_data_year" & "/Distri_TS_" & c & ".txt");
					}
					for {i in STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"] union STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DECEN"]}{
						printf "\t%f", (sum {l in LAYERS: storage_eff_in [i,l] > 0}
										-(Storage_in [c, i, l, h, td] * storage_eff_in [i, l]))
								> ( PathName & "/hourly_data_year" & "/Distri_TS_" & c & ".txt");
						printf "\t%f", (sum {l in LAYERS: storage_eff_in [i,l] > 0}
										(Storage_out [c, i, l, h, td] / storage_eff_out [i, l]))
								> ( PathName & "/hourly_data_year" & "/Distri_TS_" & c & ".txt");
						
					}
				}

				
				#########################################
				#			TD HOURLY DATA				#
				#########################################
				
				# not printing storage as we need t in PERIODS for storage level

				#------------------------------------------
				# LAYERS FLUXES
				#------------------------------------------
				print ("--------------SAVING Elec Layer TD " & c & " -----------");

				printf "Td\tTime" > ( PathName & "/hourly_data_TD" & "/ElecLayers_" & c & ".txt");
				for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH }{
					printf "\t%s",i > ( PathName & "/hourly_data_TD" & "/ElecLayers_" & c & ".txt");
				}
				for {j in STORAGE_TECH }{
					printf "\t%s_Pin",j > ( PathName & "/hourly_data_TD" & "/ElecLayers_" & c & ".txt");
					printf "\t%s_Pout",j > ( PathName & "/hourly_data_TD" & "/ElecLayers_" & c & ".txt");
				}
				printf "\tEND_USE" > ( PathName & "/hourly_data_TD" & "/ElecLayers_" & c & ".txt");

				for {td in TYPICAL_DAYS, h in HOURS}{
					printf "\n%d\t%d",td,h   > ( PathName & "/hourly_data_TD" & "/ElecLayers_" & c & ".txt");
					for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{if i in TECHNOLOGIES
					then
							printf "\t%f",(layers_in_out[i, "ELECTRICITY"] * F_t [c, i, h, td]) > ( PathName & "/hourly_data_TD" & "/ElecLayers_" & c & ".txt");
					else
							printf "\t%f",(layers_in_out[i, "ELECTRICITY"] * (R_t_local[c, i, h, td] + R_t_import[c, i, h, td] - (1 + exchange_losses[i]) * R_t_export[c, i, h, td] + R_t_exterior[c, i, h, td])) > ( PathName & "/hourly_data_TD" & "/ElecLayers_" & c & ".txt");
					}
					for {j in STORAGE_TECH}{
						printf "\t%f",(-Storage_in [c, j, "ELECTRICITY", h, td]) > ( PathName & "/hourly_data_TD" & "/ElecLayers_" & c & ".txt");
						printf "\t%f", (Storage_out [c, j, "ELECTRICITY", h, td]) > ( PathName & "/hourly_data_TD" & "/ElecLayers_" & c & ".txt");
					}
					printf "\t%f", -End_uses [c, "ELECTRICITY", h, td]  > ( PathName & "/hourly_data_TD" & "/ElecLayers_" & c & ".txt");
				}

				print ("--------------SAVING LT Layer TD " & c & " -----------");

				printf "Td\tTime" > ( PathName & "/hourly_data_TD" & "/LTLayers_" & c & ".txt");
				for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH }{
					printf "\t%s",i > ( PathName & "/hourly_data_TD" & "/LTLayers_" & c & ".txt");
				}
				for {j in STORAGE_TECH }{
					printf "\t%s_Pin",j > ( PathName & "/hourly_data_TD" & "/LTLayers_" & c & ".txt");
					printf "\t%s_Pout",j > ( PathName & "/hourly_data_TD" & "/LTLayers_" & c & ".txt");
				}
				printf "\tEND_USE" > ( PathName & "/hourly_data_TD" & "/LTLayers_" & c & ".txt");

				for {td in TYPICAL_DAYS, h in HOURS}{
					printf "\n%d\t%d",td,h   > ( PathName & "/hourly_data_TD" & "/LTLayers_" & c & ".txt");
					for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH }{if i in TECHNOLOGIES
					then 
						printf "\t%f",(sum {l in END_USES_TYPES_OF_CATEGORY["HEAT_LOW_T"]} (layers_in_out[i, l] * F_t [c, i, h, td])) > ( PathName & "/hourly_data_TD" & "/LTLayers_" & c & ".txt");
					else
						printf "\t%f",(sum {l in END_USES_TYPES_OF_CATEGORY["HEAT_LOW_T"]} (layers_in_out[i, l] * (R_t_local[c, i, h, td] + R_t_import[c, i, h, td] - (1 + exchange_losses[i]) * R_t_export[c, i, h, td] + R_t_exterior[c, i, h, td]))) > ( PathName & "/hourly_data_TD" & "/LTLayers_" & c & ".txt");
					}
					for {j in STORAGE_TECH }{
						printf "\t%f",sum {l in END_USES_TYPES_OF_CATEGORY["HEAT_LOW_T"]}(-Storage_in [c, j, l, h, td]) > ( PathName & "/hourly_data_TD" & "/LTLayers_" & c & ".txt");
						printf "\t%f",sum {l in END_USES_TYPES_OF_CATEGORY["HEAT_LOW_T"]} (Storage_out [c, j, l, h, td]) > ( PathName & "/hourly_data_TD" & "/LTLayers_" & c & ".txt");
					}
					printf "\t%f", sum {l in END_USES_TYPES_OF_CATEGORY["HEAT_LOW_T"]} (-End_uses [c, l, h, td])  > ( PathName & "/hourly_data_TD" & "/LTLayers_" & c & ".txt");
				}

				print ("--------------SAVING HT Layer TD " & c & " -----------");

				printf "Td\tTime" > ( PathName & "/hourly_data_TD" & "/HTLayers_" & c & ".txt");
				for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH }{
					printf "\t%s",i > ( PathName & "/hourly_data_TD" & "/HTLayers_" & c & ".txt");
				}
				for {j in STORAGE_TECH }{
					printf "\t%s_Pin",j > ( PathName & "/hourly_data_TD" & "/HTLayers_" & c & ".txt");
					printf "\t%s_Pout",j > ( PathName & "/hourly_data_TD" & "/HTLayers_" & c & ".txt");
				}
				printf "\tEND_USE" > ( PathName & "/hourly_data_TD" & "/HTLayers_" & c & ".txt");

				for {td in TYPICAL_DAYS, h in HOURS}{
					printf "\n%d\t%d",td,h   > ( PathName & "/hourly_data_TD" & "/HTLayers_" & c & ".txt");
					for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH }{if i in TECHNOLOGIES
					then 
						printf "\t%f",(layers_in_out[i, "HEAT_HIGH_T"] * F_t [c, i, h, td]) > ( PathName & "/hourly_data_TD" & "/HTLayers_" & c & ".txt");
					else
						printf "\t%f",(layers_in_out[i, "HEAT_HIGH_T"] * (R_t_local[c, i, h, td] + R_t_import[c, i, h, td] - (1 + exchange_losses[i]) * R_t_export[c, i, h, td] + R_t_exterior[c, i, h, td])) > ( PathName & "/hourly_data_TD" & "/HTLayers_" & c & ".txt");
					}
					for {j in STORAGE_TECH }{
						printf "\t%f",(-Storage_in [c, j, "HEAT_HIGH_T", h, td]) > ( PathName & "/hourly_data_TD" & "/HTLayers_" & c & ".txt");
						printf "\t%f", (Storage_out [c, j, "HEAT_HIGH_T", h, td]) > ( PathName & "/hourly_data_TD" & "/HTLayers_" & c & ".txt");
					}
					printf "\t%f", -End_uses [c, "HEAT_HIGH_T", h, td]  > ( PathName & "/hourly_data_TD" & "/HTLayers_" & c & ".txt");
				}

				print ("--------------SAVING PASSANGER Layer TD " & c & " -----------");

				printf "Td\tTime" > ( PathName & "/hourly_data_TD" & "/PASSANGERSLayers_" & c & ".txt");
				for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{
					printf "\t%s",i > ( PathName & "/hourly_data_TD" & "/PASSANGERSLayers_" & c & ".txt");
				}
				for {j in STORAGE_TECH }{
					printf "\t%s_Pin",j > ( PathName & "/hourly_data_TD" & "/PASSANGERSLayers_" & c & ".txt");
					printf "\t%s_Pout",j > ( PathName & "/hourly_data_TD" & "/PASSANGERSLayers_" & c & ".txt");
				}
				printf "\tEND_USE" > ( PathName & "/hourly_data_TD" & "/PASSANGERSLayers_" & c & ".txt");

				for {td in TYPICAL_DAYS, h in HOURS}{
					printf "\n%d\t%d",td,h   > ( PathName & "/hourly_data_TD" & "/PASSANGERSLayers_" & c & ".txt");
					for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{if i in TECHNOLOGIES
					then 
						printf "\t%f",(sum {l in END_USES_TYPES_OF_CATEGORY["MOBILITY_PASSENGER"]} (layers_in_out[i, l] * F_t [c, i, h, td])) > 
				( PathName & "/hourly_data_TD" & "/PASSANGERSLayers_" & c & ".txt");
				else
						printf "\t%f",(sum {l in END_USES_TYPES_OF_CATEGORY["MOBILITY_PASSENGER"]} (layers_in_out[i, l] * (R_t_local[c, i, h, td] + R_t_import[c, i, h, td] - (1 + exchange_losses[i]) * R_t_export[c, i, h, td] + R_t_exterior[c, i, h, td]))) > 
				( PathName & "/hourly_data_TD" & "/PASSANGERSLayers_" & c & ".txt");
					}
					for {j in STORAGE_TECH }{
						printf "\t%f",sum {l in END_USES_TYPES_OF_CATEGORY["MOBILITY_PASSENGER"]}(-Storage_in [c, j, l, h, td]) > ( PathName & "/hourly_data_TD" & "/PASSANGERSLayers_" & c & ".txt");
						printf "\t%f",sum {l in END_USES_TYPES_OF_CATEGORY["MOBILITY_PASSENGER"]}(-Storage_out[c, j, l, h, td]) > ( PathName & "/hourly_data_TD" & "/PASSANGERSLayers_" & c & ".txt");
					}
					printf "\t%f", sum {l in END_USES_TYPES_OF_CATEGORY["MOBILITY_PASSENGER"]} (-End_uses [c, l, h, td] ) > ( PathName & "/hourly_data_TD" & "/PASSANGERSLayers_" & c & ".txt");
				}

				print ("--------------SAVING FREIGHT Layer TD " & c & " -----------");

				printf "Td\tTime" > ( PathName & "/hourly_data_TD" & "/FREIGHTLayers_" & c & ".txt");
				for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{
					printf "\t%s",i > ( PathName & "/hourly_data_TD" & "/FREIGHTLayers_" & c & ".txt");
				}
				for {j in STORAGE_TECH }{
					printf "\t%s_Pin",j > ( PathName & "/hourly_data_TD" & "/FREIGHTLayers_" & c & ".txt");
					printf "\t%s_Pout",j > ( PathName & "/hourly_data_TD" & "/FREIGHTLayers_" & c & ".txt");
				}
				printf "\tEND_USE" > ( PathName & "/hourly_data_TD" & "/FREIGHTLayers_" & c & ".txt");

				for {td in TYPICAL_DAYS, h in HOURS}{
					printf "\n%d\t%d",td,h   > ( PathName & "/hourly_data_TD" & "/FREIGHTLayers_" & c & ".txt");
					for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{if i in TECHNOLOGIES
					then 
						printf "\t%f",(sum {l in END_USES_TYPES_OF_CATEGORY["MOBILITY_FREIGHT"]} (layers_in_out[i, l] * F_t [c, i, h, td])) > 
				( PathName & "/hourly_data_TD" & "/FREIGHTLayers_" & c & ".txt");
				else
						printf "\t%f",(sum {l in END_USES_TYPES_OF_CATEGORY["MOBILITY_FREIGHT"]} (layers_in_out[i, l] * (R_t_local[c, i, h, td] + R_t_import[c, i, h, td] - (1 + exchange_losses[i]) * R_t_export[c, i, h, td] + R_t_exterior[c, i, h, td]))) > 
				( PathName & "/hourly_data_TD" & "/FREIGHTLayers_" & c & ".txt");
					}
					for {j in STORAGE_TECH }{
						printf "\t%f",sum {l in END_USES_TYPES_OF_CATEGORY["MOBILITY_FREIGHT"]}(-Storage_in [c, j, l, h, td]) > ( PathName & "/hourly_data_TD" & "/FREIGHTLayers_" & c & ".txt");
						printf "\t%f",sum {l in END_USES_TYPES_OF_CATEGORY["MOBILITY_FREIGHT"]}(-Storage_out[c, j, l, h, td]) > ( PathName & "/hourly_data_TD" & "/FREIGHTLayers_" & c & ".txt");
					}
					printf "\t%f", sum {l in END_USES_TYPES_OF_CATEGORY["MOBILITY_FREIGHT"]} (-End_uses [c, l, h, td] )  > ( PathName & "/hourly_data_TD" & "/FREIGHTLayers_" & c & ".txt");
				}
				
				
				print ("--------------SAVING Cooling Layer TD " & c & " -----------");

				printf "Td\tTime" > ( PathName & "/hourly_data_TD" & "/CoolingLayers_" & c & ".txt");
				for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH }{
					printf "\t%s",i > ( PathName & "/hourly_data_TD" & "/CoolingLayers_" & c & ".txt");
				}
				for {j in STORAGE_TECH }{
					printf "\t%s_Pin",j > ( PathName & "/hourly_data_TD" & "/CoolingLayers_" & c & ".txt");
					printf "\t%s_Pout",j > ( PathName & "/hourly_data_TD" & "/CoolingLayers_" & c & ".txt");
				}
				printf "\tEND_USE" > ( PathName & "/hourly_data_TD" & "/CoolingLayers_" & c & ".txt");

				for {td in TYPICAL_DAYS, h in HOURS}{
					printf "\n%d\t%d",td,h   > ( PathName & "/hourly_data_TD" & "/CoolingLayers_" & c & ".txt");
					for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{if i in TECHNOLOGIES
					then
							printf "\t%f",(layers_in_out[i, "SPACE_COOLING"] * F_t [c, i, h, td]) > ( PathName & "/hourly_data_TD" & "/CoolingLayers_" & c & ".txt");
					else
							printf "\t%f",(layers_in_out[i, "SPACE_COOLING"] * (R_t_local[c, i, h, td] + R_t_import[c, i, h, td] - (1 + exchange_losses[i]) * R_t_export[c, i, h, td] + R_t_exterior[c, i, h, td])) > ( PathName & "/hourly_data_TD" & "/CoolingLayers_" & c & ".txt");
					}
					for {j in STORAGE_TECH}{
						printf "\t%f",(-Storage_in [c, j, "SPACE_COOLING", h, td]) > ( PathName & "/hourly_data_TD" & "/CoolingLayers_" & c & ".txt");
						printf "\t%f", (Storage_out [c, j, "SPACE_COOLING", h, td]) > ( PathName & "/hourly_data_TD" & "/CoolingLayers_" & c & ".txt");
					}
					printf "\t%f", -End_uses [c, "SPACE_COOLING", h, td]  > ( PathName & "/hourly_data_TD" & "/CoolingLayers_" & c & ".txt");
				}


				print ("--------------SAVING H2Layer TD " & c & " -----------");

				printf "Td\tTime" > ( PathName & "/hourly_data_TD" & "/H2Layers_" & c & ".txt");
				for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{
					printf "\t%s",i > ( PathName & "/hourly_data_TD" & "/H2Layers_" & c & ".txt");
				}
				for {j in STORAGE_TECH }{
					printf "\t%s_Pin",j > ( PathName & "/hourly_data_TD" & "/H2Layers_" & c & ".txt");
					printf "\t%s_Pout",j > ( PathName & "/hourly_data_TD" & "/H2Layers_" & c & ".txt");
				}
				printf "\tEND_USE" > ( PathName & "/hourly_data_TD" & "/H2Layers_" & c & ".txt");

				for {td in TYPICAL_DAYS, h in HOURS}{
					printf "\n%d\t%d",td,h   > ( PathName & "/hourly_data_TD" & "/H2Layers_" & c & ".txt");
					for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{if i in TECHNOLOGIES
					then 
						printf "\t%f",(layers_in_out[i, "H2"] * F_t [c, i, h, td]) > ( PathName & "/hourly_data_TD" & "/H2Layers_" & c & ".txt");
					else
						printf "\t%f",(layers_in_out[i, "H2"] * (R_t_local[c, i, h, td] + R_t_import[c, i, h, td] - (1 + exchange_losses[i]) * R_t_export[c, i, h, td] + R_t_exterior[c, i, h, td])) > ( PathName & "/hourly_data_TD" & "/H2Layers_" & c & ".txt");
						
					}
					for {j in STORAGE_TECH }{
						printf "\t%f",(-Storage_in [c, j, "H2", h, td]) > ( PathName & "/hourly_data_TD" & "/H2Layers_" & c & ".txt");
						printf "\t%f", (Storage_out [c, j, "H2", h, td]) > ( PathName & "/hourly_data_TD" & "/H2Layers_" & c & ".txt");
					}
					printf "\t%f", -End_uses [c, "H2", h, td]  > ( PathName & "/hourly_data_TD" & "/H2Layers_" & c & ".txt");
				}
				
				
				print ("--------------SAVING NGLayer TD " & c & " -----------");

				printf "Td\tTime" > ( PathName & "/hourly_data_TD" & "/NGLayers_" & c & ".txt");
				for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{
					printf "\t%s",i > ( PathName & "/hourly_data_TD" & "/NGLayers_" & c & ".txt");
				}
				for {j in STORAGE_TECH }{
					printf "\t%s_Pin",j > ( PathName & "/hourly_data_TD" & "/NGLayers_" & c & ".txt");
					printf "\t%s_Pout",j > ( PathName & "/hourly_data_TD" & "/NGLayers_" & c & ".txt");
				}
				printf "\tEND_USE" > ( PathName & "/hourly_data_TD" & "/NGLayers_" & c & ".txt");

				for {td in TYPICAL_DAYS, h in HOURS}{
					printf "\n%d\t%d",td,h   > ( PathName & "/hourly_data_TD" & "/NGLayers_" & c & ".txt");
					for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{if i in TECHNOLOGIES
					then 
						printf "\t%f",(layers_in_out[i, "GAS"] * F_t [c, i, h, td]) > ( PathName & "/hourly_data_TD" & "/NGLayers_" & c & ".txt");
					else
						printf "\t%f",(layers_in_out[i, "GAS"] * (R_t_local[c, i, h, td] + R_t_import[c, i, h, td] - (1 + exchange_losses[i]) * R_t_export[c, i, h, td] + R_t_exterior[c, i, h, td])) > ( PathName & "/hourly_data_TD" & "/NGLayers_" & c & ".txt");
						
					}
					for {j in STORAGE_TECH }{
						printf "\t%f",(-Storage_in [c, j, "GAS", h, td]) > ( PathName & "/hourly_data_TD" & "/NGLayers_" & c & ".txt");
						printf "\t%f", (Storage_out [c, j, "GAS", h, td]) > ( PathName & "/hourly_data_TD" & "/NGLayers_" & c & ".txt");
					}
					printf "\t%f", -End_uses [c, "GAS", h, td]  > ( PathName & "/hourly_data_TD" & "/NGLayers_" & c & ".txt");
				}
				
				
				print ("--------------SAVING METHANOLLayer TD " & c & " -----------");

				printf "Td\tTime" > ( PathName & "/hourly_data_TD" & "/METHANOLLayers_" & c & ".txt");
				for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{
					printf "\t%s",i > ( PathName & "/hourly_data_TD" & "/METHANOLLayers_" & c & ".txt");
				}
				for {j in STORAGE_TECH }{
					printf "\t%s_Pin",j > ( PathName & "/hourly_data_TD" & "/METHANOLLayers_" & c & ".txt");
					printf "\t%s_Pout",j > ( PathName & "/hourly_data_TD" & "/METHANOLLayers_" & c & ".txt");
				}
				printf "\tEND_USE" > ( PathName & "/hourly_data_TD" & "/METHANOLLayers_" & c & ".txt");

				for {td in TYPICAL_DAYS, h in HOURS}{
					printf "\n%d\t%d",td,h   > ( PathName & "/hourly_data_TD" & "/METHANOLLayers_" & c & ".txt");
					for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{if i in TECHNOLOGIES
					then 
						printf "\t%f",(layers_in_out[i, "METHANOL"] * F_t [c, i, h, td]) > ( PathName & "/hourly_data_TD" & "/METHANOLLayers_" & c & ".txt");
					else
						printf "\t%f",(layers_in_out[i, "METHANOL"] * (R_t_local[c, i, h, td] + R_t_import[c, i, h, td] - (1 + exchange_losses[i]) * R_t_export[c, i, h, td] + R_t_exterior[c, i, h, td])) > ( PathName & "/hourly_data_TD" & "/METHANOLLayers_" & c & ".txt");
						
					}
					for {j in STORAGE_TECH }{
						printf "\t%f",(-Storage_in [c, j, "METHANOL", h, td]) > ( PathName & "/hourly_data_TD" & "/METHANOLLayers_" & c & ".txt");
						printf "\t%f", (Storage_out [c, j, "METHANOL", h, td]) > ( PathName & "/hourly_data_TD" & "/METHANOLLayers_" & c & ".txt");
					}
					printf "\t%f", -End_uses [c, "METHANOL", h, td]  > ( PathName & "/hourly_data_TD" & "/METHANOLLayers_" & c & ".txt");
				}


				print ("--------------SAVING AMMONIALayer TD " & c & " -----------");

				printf "Td\tTime" > ( PathName & "/hourly_data_TD" & "/AMMONIALayers_" & c & ".txt");
				for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{
					printf "\t%s",i > ( PathName & "/hourly_data_TD" & "/AMMONIALayers_" & c & ".txt");
				}
				for {j in STORAGE_TECH }{
					printf "\t%s_Pin",j > ( PathName & "/hourly_data_TD" & "/AMMONIALayers_" & c & ".txt");
					printf "\t%s_Pout",j > ( PathName & "/hourly_data_TD" & "/AMMONIALayers_" & c & ".txt");
				}
				printf "\tEND_USE" > ( PathName & "/hourly_data_TD" & "/AMMONIALayers_" & c & ".txt");

				for {td in TYPICAL_DAYS, h in HOURS}{
					printf "\n%d\t%d",td,h   > ( PathName & "/hourly_data_TD" & "/AMMONIALayers_" & c & ".txt");
					for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{if i in TECHNOLOGIES
					then 
						printf "\t%f",(layers_in_out[i, "AMMONIA"] * F_t [c, i, h, td]) > ( PathName & "/hourly_data_TD" & "/AMMONIALayers_" & c & ".txt");
					else
						printf "\t%f",(layers_in_out[i, "AMMONIA"] * (R_t_local[c, i, h, td] + R_t_import[c, i, h, td] - (1 + exchange_losses[i]) * R_t_export[c, i, h, td] + R_t_exterior[c, i, h, td])) > ( PathName & "/hourly_data_TD" & "/AMMONIALayers_" & c & ".txt");
						
					}
					for {j in STORAGE_TECH }{
						printf "\t%f",(-Storage_in [c, j, "AMMONIA", h, td]) > ( PathName & "/hourly_data_TD" & "/AMMONIALayers_" & c & ".txt");
						printf "\t%f", (Storage_out [c, j, "AMMONIA", h, td]) > ( PathName & "/hourly_data_TD" & "/AMMONIALayers_" & c & ".txt");
					}
					printf "\t%f", -End_uses [c, "AMMONIA", h, td]  > ( PathName & "/hourly_data_TD" & "/AMMONIALayers_" & c & ".txt");
				}
				


				#------------------------------------------
				# Exchanges printing
				#------------------------------------------
				print ("--------- SAVING Exchanges TD " & c & " --------");
				
				printf "Unit\t[GW]" > (PathName & "/hourly_data_TD" & "/exch_" & c & ".txt");
				for {i in RESOURCES}{
					for {c2 in REGIONS}{
						printf "\t%s", i > (PathName & "/hourly_data_TD" & "/exch_" & c & ".txt");
					}
				}
				printf "\n" > (PathName & "/hourly_data_TD" & "/exch_" & c & ".txt");
				printf "Td\tTime" > (PathName & "/hourly_data_TD" & "/exch_" & c & ".txt");
				for {i in RESOURCES}{
				for {c2 in REGIONS}{
						printf "\t%s", c2 > (PathName & "/hourly_data_TD" & "/exch_" & c & ".txt");
				}
				}
				for {td in TYPICAL_DAYS, h in HOURS}{
					printf "\n%d\t%d",td,h   > (PathName & "/hourly_data_TD" & "/exch_" & c & ".txt");
					for {i in RESOURCES}{
						for {c2 in REGIONS}{
							printf "\t%.6f", Exch_imp[c,c2,i,h,td] - Exch_exp[c,c2,i,h,td] > (PathName & "/hourly_data_TD" & "/exch_" & c & ".txt");
						}
					}	
				}

				#------------------------------------------
				# Resources balance
				#------------------------------------------
				print ("--------- SAVING Resources balance TD " & c & " --------");
				
				printf "Unit\t[GW]" > (PathName & "/hourly_data_TD" & "/resources_" & c & ".txt");
				for {i in RESOURCES}{
						printf "\t%s\t%s\t%s\t%s", i, i, i, i > (PathName & "/hourly_data_TD" & "/resources_" & c & ".txt");
				}
				printf "\n" > (PathName & "/hourly_data_TD" & "/resources_" & c & ".txt");
				printf "Td\tTime" > (PathName & "/hourly_data_TD" & "/resources_" & c & ".txt");
				for {i in RESOURCES}{
						printf "\tR_t_local\tR_t_exterior\tR_t_import\tR_t_export" > (PathName & "/hourly_data_TD" & "/resources_" & c & ".txt");
				}
				for {td in TYPICAL_DAYS, h in HOURS}{
					printf "\n%d\t%d",td,h   > (PathName & "/hourly_data_TD" & "/resources_" & c & ".txt");
					for {i in RESOURCES}{
						printf "\t%.6f\t%.6f\t%.6f\t%.6f", R_t_local[c, i, h, td], R_t_exterior[c, i, h, td], R_t_import[c, i, h, td], R_t_export[c, i, h, td] > (PathName & "/hourly_data_TD" & "/resources_" & c & ".txt");
					}
				}

		
		
			####################################################################################################################################
			
		
			}
			
			###############################################################################                                                    
			#																			  #
			#                     			 OVERALL SYSTEM  							  #                                                    
			#																			  #
			###############################################################################
		
        	#------------------------------------------
        	## Print Transfer capacities to txt file.
        	#------------------------------------------
        	print ("--------------SAVING Transfer capacities-----------");
        	let filePath := (PathName & "/Transfer_capacities" & fileExt);
        	for {i in EXCHANGE_NETWORK_R}{
                printf "%s",i > (filePath);
                for {c in REGIONS}{
                    printf "\t%s",c > (filePath);
                }
                for {c1 in REGIONS}{
                    printf "\n%s",c1 > (filePath);
                    for {c2 in REGIONS}{
                        printf "\t%.6f",Transfer_capacity[c1,c2,i] > (filePath);
                    }
                }
                printf "\n\n" > (filePath);
        	}
        
        	#------------------------------------------
        	## Print Used TC to txt file.
        	#------------------------------------------
        	print ("--------------SAVING Used TC-----------");
        	let filePath := (PathName & "/Transfer_capacities_used" & fileExt);
        	for {i in EXCHANGE_NETWORK_R}{
                printf "%s",i > (filePath);
                for {c1 in REGIONS}{
                    printf "\t%s",c1 > (filePath);
                }
                for {c2 in REGIONS}{
                    printf "\n%s",c2 > (filePath);
                    for {c1 in REGIONS}{
                        printf "\t%.6f",max {h in HOURS, td in TYPICAL_DAYS} Exch_exp[c1,c2,i,h,td] > (filePath);
                    }
                }
                printf "\n\n" > (filePath);
            }
        
        	#------------------------------------------
        	## Print Total transfers to txt file.
        	#------------------------------------------
        	print ("--------------SAVING Total transfers-----------");
        	let filePath := (PathName & "/Transfers" & fileExt);
        	for {i in EXCHANGE_NETWORK_R}{
                printf "%s",i > (filePath);
                for {c1 in REGIONS}{
                    printf "\t%s",c1 > (filePath);
                }
                for {c2 in REGIONS}{
                    printf "\n%s",c2 > (filePath);
                    for {c1 in REGIONS}{
                        printf "\t%.6f",sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}  (Exch_exp[c1,c2,i,h,td])/1000 > (filePath);
                    }
                }
                printf "\n\n" > (filePath);
            }
        	for {i in RESOURCES diff NOEXCHANGES diff EXCHANGE_NETWORK_R}{
                printf "%s",i > (filePath);
                for {c1 in REGIONS}{
                    printf "\t%s",c1 > (filePath);
                }
                for {c2 in REGIONS}{
                    printf "\n%s",c2 > (filePath);
                    for {c1 in REGIONS}{
                        printf "\t%.6f",sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}  (Exch_exp[c1,c2,i,h,td])/1000 > (filePath);
                    }
                }
                printf "\n\n" > (filePath);
            }

			#########################################
			#				Year summary			#
			#########################################
			
			#------------------------------------------
			## Print cost breakdown to txt file.
			#------------------------------------------
			print "--------------SAVING COST ALL -----------";
			printf "%s\t%s\t%s\t%s\n", "Name","C_inv [M€/y]","C_maint [M€/y]","C_op [M€/y]" > ( PathName & "/cost_breakdown_" & "ALL" & ".txt"); 
			for {i in TECHNOLOGIES union RESOURCES}{if i in TECHNOLOGIES
			then
					printf "%s\t%.6f\t%.6f\t%.6f\n", i, sum{c in REGIONS} (tau [c,i] * C_inv [c,i]), sum{c in REGIONS} (C_maint [c,i]), 0 > ( PathName & "/cost_breakdown_" & "ALL" & ".txt"); 
			else
					printf "%s\t%.6f\t%.6f\t%.6f\n", i, 0, 0, sum{c in REGIONS} (C_op[c,i]) > ( PathName & "/cost_breakdown_" & "ALL" & ".txt"); ;
			}
			for {i in EXCHANGE_NETWORK_R}{
				printf "%s%s\t%.6f\t%.6f\t%.6f\n", "Exch network ", i, sum{c in REGIONS} C_exch_network [c,i], 0, 0 > ( PathName & "/cost_breakdown_" & "ALL" & ".txt");
			}
			printf "%s\t%.6f\t%.6f\t%.6f", "Total [M€/y]", sum{c in REGIONS, i in TECHNOLOGIES} (tau [c,i] * C_inv [c,i]) + sum{c in REGIONS, i in EXCHANGE_NETWORK_R} C_exch_network [c,i], sum{c in REGIONS, i in TECHNOLOGIES} C_maint [c,i], sum{c in REGIONS, i in RESOURCES} C_op[c,i] > ( PathName & "/cost_breakdown_" & "ALL" & ".txt");
				


			#------------------------------------------
			## Print GWP breakdown
			#------------------------------------------
			print "--------------SAVING GWP ALL -----------";

			printf "%s\t%s\t%s\n", "Name", "GWP_constr [kt_CO2eq/y]", "GWP_op [kt_CO2eq/y]" > ( PathName & "/gwp_breakdown_" & "ALL" & ".txt");  
			for {i in TECHNOLOGIES union RESOURCES}{if i in TECHNOLOGIES
			then
					printf "%s\t%.6f\t%.6f\n", i, sum{c in REGIONS} (GWP_constr [c,i] / lifetime [c,i]), 0 > ( PathName & "/gwp_breakdown_" & "ALL" & ".txt"); 
			else
					printf "%s\t%.6f\t%.6f\n", i, 0, sum{c in REGIONS} (GWP_op [c,i]) > ( PathName & "/gwp_breakdown_" & "ALL" & ".txt"); 
			}
			printf "%s\t%.6f\t%.6f", "Total [ktCO2-eq/y]", sum{c in REGIONS, i in TECHNOLOGIES} (GWP_constr [c,i] / lifetime [c,i]), sum{c in REGIONS, i in RESOURCES} GWP_op [c,i]  > ( PathName & "/gwp_breakdown_" & "ALL" & ".txt"); 

			#------------------------------------------
			## Print losses to txt file
			#------------------------------------------
			print "--------------SAVING losses ALL -----------";

			printf "EUD\tLosses [GWh/y]" > ( PathName & "/losses_" & "ALL" & ".txt"); 
			for {i in END_USES_TYPES}{
					printf "\n%s\t%.3f", i, sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t] }(Network_losses [c,i,h,td] )  > ( PathName & "/losses_" & "ALL" & ".txt"); 
			}

			#------------------------------------------
			## Print ASSETS to txt file  (/!\ without tau)
			#------------------------------------------
			print "--------------SAVING ASSETS ALL -----------";
			printf "TECHNOLOGIES\tc_inv\tc_maint\tlifetime\tf_min\tf\tf_max\tfmin_perc\tf_perc\tfmax_perc\tc_p_actual\tc_p\tgwp_constr" > ( PathName & "/Assets_" & "ALL" & ".txt"); 
			printf "\nUNITS\t[Meuro/GW]\t[Meuro/GW]\t[y]\t[GW or GWh]\t[GW or GWh]\t[GW or GWh]\t[0-1]\t[0-1]\t[0-1]\t[0-1]\t[0-1]\t[ktCO2-eq./GW or GWh]" > ( PathName & "/Assets_" & "ALL" & ".txt"); 
			for {i in END_USES_TYPES, tech in TECHNOLOGIES_OF_END_USES_TYPE[i]}{
				printf "\n%s\t%f\t%f\t%f\t%f\t%f\t%f\t%f\t%f\t%f\t%f\t%f\t%f",tech,
						sum{c in REGIONS} (C_inv[c,tech]), sum{c in REGIONS} (C_maint[c,tech]), sum{c in REGIONS}(lifetime[c,tech])/card(REGIONS), sum{c in REGIONS} (f_min[c,tech]),
						sum{c in REGIONS}(F[c,tech]), sum{c in REGIONS} (f_max[c,tech]),
						if sum {c2 in REGIONS, j2 in TECHNOLOGIES_OF_END_USES_TYPE[i], t2 in PERIODS, h2 in HOUR_OF_PERIOD[t2], td2 in TYPICAL_DAY_OF_PERIOD[t2]} (F_t [c2,j2, h2,td2] ) > 0 then sum {c in REGIONS} (fmin_perc[c,tech]*sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (F_t [c,tech,h,td]))/ sum {c2 in REGIONS, j2 in 
						TECHNOLOGIES_OF_END_USES_TYPE[i], t2 in PERIODS, h2 in HOUR_OF_PERIOD[t2], td2 in TYPICAL_DAY_OF_PERIOD[t2]} (F_t [c2,j2, h2,td2] ) else 0,
						if sum {c2 in REGIONS, j2 in TECHNOLOGIES_OF_END_USES_TYPE[i], t2 in PERIODS, h2 in HOUR_OF_PERIOD[t2], td2 in TYPICAL_DAY_OF_PERIOD[t2]} (F_t [c2,j2, h2, td2]) > 0 then sum {c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (F_t [c,tech,h,td]) / sum {c2 in REGIONS, j2 in
						TECHNOLOGIES_OF_END_USES_TYPE[i], t2 in PERIODS, h2 in HOUR_OF_PERIOD[t2], td2 in TYPICAL_DAY_OF_PERIOD[t2]} (F_t [c2,j2, h2, td2] ) else 0,
						if sum {c2 in REGIONS, j2 in TECHNOLOGIES_OF_END_USES_TYPE[i], t2 in PERIODS, h2 in HOUR_OF_PERIOD[t2], td2 in TYPICAL_DAY_OF_PERIOD[t2]} (F_t [c2,j2, h2, td2]) > 0 then sum {c in REGIONS} (fmax_perc[c,tech]*sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (F_t [c,tech,h,td]))/ sum {c2 in REGIONS, j2 in 
						TECHNOLOGIES_OF_END_USES_TYPE[i], t2 in PERIODS, h2 in HOUR_OF_PERIOD[t2], td2 in TYPICAL_DAY_OF_PERIOD[t2]} (F_t [c2,j2, h2, td2]) else 0,
						if (sum{c in REGIONS} (F[c,tech]))>0 then sum {c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (F_t [c,tech,h,td]) / (sum{c2 in REGIONS} (F[c2,tech])*8760) else 0,
						sum{c in REGIONS} (c_p[c,tech])/card(REGIONS), sum{c in REGIONS} (GWP_constr[c,tech]) > ( PathName & "/Assets_" & "ALL" & ".txt"); 
			}
			for {tech in STORAGE_TECH union INFRASTRUCTURE}{
				printf "\n%s\t%f\t%f\t%f\t%f\t%f\t%f\t%f\t%f\t%f\t%f\t%f\t%f",tech,
						sum{c in REGIONS} (C_inv[c,tech]), sum{c in REGIONS} (C_maint[c,tech]), sum{c in REGIONS}(lifetime[c,tech])/card(REGIONS), sum{c in REGIONS} (f_min[c,tech]), sum{c in REGIONS} (F[c,tech]),
						sum{c in REGIONS} (f_max[c,tech]), 0, -1, 1, 1, 1, sum{c in REGIONS} (GWP_constr[c,tech]) > ( PathName & "/Assets_" & "ALL" & ".txt"); 
			}
			
			
			#------------------------------------------
			# YEARLY BALANCE
			#------------------------------------------
			print "--------- SAVING Yearly balances ALL --------";

			printf "Tech" > ( PathName & "/YearBalance_" & "ALL" & ".txt");
			for {l in LAYERS}{
				printf "\t%s",l > ( PathName & "/YearBalance_" & "ALL" & ".txt");
			}
			for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{
				printf "\n%s", i > ( PathName & "/YearBalance_" & "ALL" & ".txt");
				for {l in LAYERS}{if i in TECHNOLOGIES
				then 
					printf "\t%f", sum {c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
									layers_in_out[i, l] * F_t [c, i, h, td] > ( PathName & "/YearBalance_" & "ALL" & ".txt");
				else
					printf "\t%f", sum {c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
									layers_in_out[i, l] * (R_t_local[c, i, h, td] + R_t_import[c, i, h, td] - (1 + exchange_losses[i]) * R_t_export[c, i, h, td] + R_t_exterior[c, i, h, td]) > ( PathName & "/YearBalance_" & "ALL" & ".txt");
				}
			}
			for {j in STORAGE_TECH}{
				printf "\n%s", j > ( PathName & "/YearBalance_" & "ALL" & ".txt");
				for {l in LAYERS}{
					printf "\t%f", sum {c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
									(Storage_out [c, j, l, h, td] - Storage_in [c, j, l, h, td]) > ( PathName & "/YearBalance_" & "ALL" & ".txt");
				}
			}
			printf "\nEND_USES_DEMAND" > ( PathName & "/YearBalance_" & "ALL" & ".txt");
			for {l in LAYERS}{
				printf "\t%f", sum {c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
								End_uses [c, l, h, td] > ( PathName & "/YearBalance_" & "ALL" & ".txt");
			}
			
			
			#------------------------------------------
			# Exchanges losses balance printing
			#------------------------------------------
			print ("--------- SAVING Exchanges losses balance ALL --------");
			
			printf "RESOURCES" > (PathName & "/exch_losses.txt");
			for{c in REGIONS}{
				printf "\t%s", c > (PathName & "/exch_losses.txt");
			}
			for {i in RESOURCES}{
				printf "\n%s", i > (PathName & "/exch_losses.txt");
				for {c in REGIONS}{
					printf "\t%.6f", sum {t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
								(R_t_export [c, i, h, td]*exchange_losses[i]) > (PathName & "/exch_losses.txt");
				}
			}
			
			
			#------------------------------------------
			# Resources balance
			#------------------------------------------
			print ("--------- SAVING Resources balance ALL --------");
			
			printf "RESOURCES" > (PathName & "/resources_ALL.txt");
			printf "\tR_t_local\tR_t_exterior" > (PathName & "/resources_ALL.txt");
			for {i in RESOURCES}{
				printf "\n%s\t%.6f\t%.6f", i, sum {c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} R_t_local[c, i, h, td],
				sum {c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} R_t_exterior[c, i, h, td] > (PathName & "/resources_ALL.txt");
			}
			

			#########################################
			#			YEAR HOURLY DATA			#
			#########################################
			
			#------------------------------------------
			#    STORAGE distribution CURVES
			#------------------------------------------
			print "--------------SAVING elec Storage YEAR ALL -----------";
			# storage curves
			printf "Period\tHourofPeriod\tTD" > ( PathName & "/hourly_data_year" & "/Distri_E_stored_" & "ALL" & ".txt");
			for {i in STORAGE_TECH diff STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"] diff STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DECEN"]}{
				printf "\t%s", i > ( PathName & "/hourly_data_year" & "/Distri_E_stored_" & "ALL" & ".txt");
			}
			for {i in STORAGE_TECH diff STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"] diff STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DECEN"]}{
				printf "\t%s_in" ,{l in LAYERS: storage_eff_in  [i,l] > 0} i > ( PathName & "/hourly_data_year" & "/Distri_E_stored_" & "ALL" & ".txt");
				printf "\t%s_out",{l in LAYERS: storage_eff_out [i,l] > 0} i > ( PathName & "/hourly_data_year" & "/Distri_E_stored_" & "ALL" & ".txt");
			}
			for {t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}{
				printf "\n%d\t%d\t%d",t,h,td  > ( PathName & "/hourly_data_year" & "/Distri_E_stored_" & "ALL" & ".txt");
				for {i in STORAGE_TECH diff STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"] diff STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DECEN"]}{
					printf "\t%f", sum{c in REGIONS} (Storage_level[c, i, t]) > ( PathName & "/hourly_data_year" & "/Distri_E_stored_" & "ALL" & ".txt");
				}
				for {i in STORAGE_TECH diff STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"] diff STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DECEN"]}{
					printf "\t%f", (sum {c in REGIONS, l in LAYERS: storage_eff_in [i,l] > 0}
									-(Storage_in [c, i, l, h, td] * storage_eff_in [i, l]))
							> ( PathName & "/hourly_data_year" & "/Distri_E_stored_" & "ALL" & ".txt");
					printf "\t%f", (sum {c in REGIONS, l in LAYERS: storage_eff_in [i,l] > 0}
									(Storage_out [c,i, l, h, td] / storage_eff_out [i, l]))
							> ( PathName & "/hourly_data_year" & "/Distri_E_stored_" & "ALL" & ".txt");
					
				}
			}

			print "--------------SAVING TS Storage YEAR ALL -----------";

			# storage curves
			printf "Period\tHourofPeriod\tTD" > ( PathName & "/hourly_data_year" & "/Distri_TS_" & "ALL" & ".txt");
			for {i in STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"] union STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DECEN"]}{
				printf "\t%s", i > ( PathName & "/hourly_data_year" & "/Distri_TS_" & "ALL" & ".txt");
			}
			for {i in STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"] union STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DECEN"]}{
				printf "\t%s_in" ,{l in LAYERS: storage_eff_in  [i,l] > 0} i > ( PathName & "/hourly_data_year" & "/Distri_TS_" & "ALL" & ".txt");
				printf "\t%s_out",{l in LAYERS: storage_eff_out [i,l] > 0} i > ( PathName & "/hourly_data_year" & "/Distri_TS_" & "ALL" & ".txt");
			}
			for {t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}{
				printf "\n%d\t%d\t%d",t,h,td  > ( PathName & "/hourly_data_year" & "/Distri_TS_" & "ALL" & ".txt");
				for {i in STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"] union STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DECEN"]}{
					printf "\t%f", sum{c in REGIONS} (Storage_level[c, i, t]) > ( PathName & "/hourly_data_year" & "/Distri_TS_" & "ALL" & ".txt");
				}
				for {i in STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"] union STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DECEN"]}{
					printf "\t%f", (sum {c in REGIONS, l in LAYERS: storage_eff_in [i,l] > 0}
									-(Storage_in [c, i, l, h, td] * storage_eff_in [i, l]))
							> ( PathName & "/hourly_data_year" & "/Distri_TS_" & "ALL" & ".txt");
					printf "\t%f", (sum {c in REGIONS, l in LAYERS: storage_eff_in [i,l] > 0}
									(Storage_out [c, i, l, h, td] / storage_eff_out [i, l]))
							> ( PathName & "/hourly_data_year" & "/Distri_TS_" & "ALL" & ".txt");
					
				}
			}		
			
				
			
			#########################################
			#			TD HOURLY DATA				#
			#########################################
			
			# not printing storage as we need t in PERIODS for storage level
			

			#------------------------------------------
			# LAYERS FLUXES
			#------------------------------------------
			print "--------------SAVING Elec Layer TD ALL -----------";

			printf "Td\tTime" > ( PathName & "/hourly_data_TD" & "/ElecLayers_" & "ALL" & ".txt");
			for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH }{
				printf "\t%s",i > ( PathName & "/hourly_data_TD" & "/ElecLayers_" & "ALL" & ".txt");
			}
			for {j in STORAGE_TECH }{
				printf "\t%s_Pin",j > ( PathName & "/hourly_data_TD" & "/ElecLayers_" & "ALL" & ".txt");
				printf "\t%s_Pout",j > ( PathName & "/hourly_data_TD" & "/ElecLayers_" & "ALL" & ".txt");
			}
			printf "\tEND_USE" > ( PathName & "/hourly_data_TD" & "/ElecLayers_" & "ALL" & ".txt");

			for {td in TYPICAL_DAYS, h in HOURS}{
				printf "\n%d\t%d",td,h   > ( PathName & "/hourly_data_TD" & "/ElecLayers_" & "ALL" & ".txt");
				for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{if i in TECHNOLOGIES
				then
						printf "\t%f", sum{c in REGIONS} (layers_in_out[i, "ELECTRICITY"] * F_t [c, i, h, td]) > ( PathName & "/hourly_data_TD" & "/ElecLayers_" & "ALL" & ".txt");
				else
						printf "\t%f", sum{c in REGIONS} (layers_in_out[i, "ELECTRICITY"] * (R_t_local[c, i, h, td] + R_t_import[c, i, h, td] - (1 + exchange_losses[i]) * R_t_export[c, i, h, td] + R_t_exterior[c, i, h, td])) > ( PathName & "/hourly_data_TD" & "/ElecLayers_" & "ALL" & ".txt");
				}
				for {j in STORAGE_TECH}{
					printf "\t%f", sum{c in REGIONS} (-Storage_in [c, j, "ELECTRICITY", h, td]) > ( PathName & "/hourly_data_TD" & "/ElecLayers_" & "ALL" & ".txt");
					printf "\t%f", sum{c in REGIONS} (Storage_out [c, j, "ELECTRICITY", h, td]) > ( PathName & "/hourly_data_TD" & "/ElecLayers_" & "ALL" & ".txt");
				}
				printf "\t%f", sum{c in REGIONS} (-End_uses [c, "ELECTRICITY", h, td])  > ( PathName & "/hourly_data_TD" & "/ElecLayers_" & "ALL" & ".txt");
			}

			print "--------------SAVING LT Layer TD ALL -----------";

			printf "Td\tTime" > ( PathName & "/hourly_data_TD" & "/LTLayers_" & "ALL" & ".txt");
			for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH }{
				printf "\t%s",i > ( PathName & "/hourly_data_TD" & "/LTLayers_" & "ALL" & ".txt");
			}
			for {j in STORAGE_TECH }{
				printf "\t%s_Pin",j > ( PathName & "/hourly_data_TD" & "/LTLayers_" & "ALL" & ".txt");
				printf "\t%s_Pout",j > ( PathName & "/hourly_data_TD" & "/LTLayers_" & "ALL" & ".txt");
			}
			printf "\tEND_USE" > ( PathName & "/hourly_data_TD" & "/LTLayers_" & "ALL" & ".txt");

			for {td in TYPICAL_DAYS, h in HOURS}{
				printf "\n%d\t%d",td,h   > ( PathName & "/hourly_data_TD" & "/LTLayers_" & "ALL" & ".txt");
				for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH }{if i in TECHNOLOGIES
				then 
					printf "\t%f",(sum {c in REGIONS, l in END_USES_TYPES_OF_CATEGORY["HEAT_LOW_T"]} (layers_in_out[i, l] * F_t [c, i, h, td])) > ( PathName & "/hourly_data_TD" & "/LTLayers_" & "ALL" & ".txt");
				else
					printf "\t%f",(sum {c in REGIONS, l in END_USES_TYPES_OF_CATEGORY["HEAT_LOW_T"]} (layers_in_out[i, l] * (R_t_local[c, i, h, td] + R_t_import[c, i, h, td] - (1 + exchange_losses[i]) * R_t_export[c, i, h, td] + R_t_exterior[c, i, h, td]))) > ( PathName & "/hourly_data_TD" & "/LTLayers_" & "ALL" & ".txt");
				}
				for {j in STORAGE_TECH }{
					printf "\t%f",sum {c in REGIONS, l in END_USES_TYPES_OF_CATEGORY["HEAT_LOW_T"]}(-Storage_in [c, j, l, h, td]) > ( PathName & "/hourly_data_TD" & "/LTLayers_" & "ALL" & ".txt");
					printf "\t%f",sum {c in REGIONS, l in END_USES_TYPES_OF_CATEGORY["HEAT_LOW_T"]} (Storage_out [c, j, l, h, td]) > ( PathName & "/hourly_data_TD" & "/LTLayers_" & "ALL" & ".txt");
				}
				printf "\t%f", sum {c in REGIONS, l in END_USES_TYPES_OF_CATEGORY["HEAT_LOW_T"]} (-End_uses [c, l, h, td])  > ( PathName & "/hourly_data_TD" & "/LTLayers_" & "ALL" & ".txt");
			}

			print "--------------SAVING HT Layer TD ALL -----------";

			printf "Td\tTime" > ( PathName & "/hourly_data_TD" & "/HTLayers_" & "ALL" & ".txt");
			for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH }{
				printf "\t%s",i > ( PathName & "/hourly_data_TD" & "/HTLayers_" & "ALL" & ".txt");
			}
			for {j in STORAGE_TECH }{
				printf "\t%s_Pin",j > ( PathName & "/hourly_data_TD" & "/HTLayers_" & "ALL" & ".txt");
				printf "\t%s_Pout",j > ( PathName & "/hourly_data_TD" & "/HTLayers_" & "ALL" & ".txt");
			}
			printf "\tEND_USE" > ( PathName & "/hourly_data_TD" & "/HTLayers_" & "ALL" & ".txt");

			for {td in TYPICAL_DAYS, h in HOURS}{
				printf "\n%d\t%d",td,h   > ( PathName & "/hourly_data_TD" & "/HTLayers_" & "ALL" & ".txt");
				for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH }{if i in TECHNOLOGIES
				then 
					printf "\t%f", sum{c in REGIONS} (layers_in_out[i, "HEAT_HIGH_T"] * F_t [c, i, h, td]) > ( PathName & "/hourly_data_TD" & "/HTLayers_" & "ALL" & ".txt");
				else
					printf "\t%f", sum{c in REGIONS} (layers_in_out[i, "HEAT_HIGH_T"] * (R_t_local[c, i, h, td] + R_t_import[c, i, h, td] - (1 + exchange_losses[i]) * R_t_export[c, i, h, td] + R_t_exterior[c, i, h, td])) > ( PathName & "/hourly_data_TD" & "/HTLayers_" & "ALL" & ".txt");
				}
				for {j in STORAGE_TECH }{
					printf "\t%f", sum{c in REGIONS} (-Storage_in [c, j, "HEAT_HIGH_T", h, td]) > ( PathName & "/hourly_data_TD" & "/HTLayers_" & "ALL" & ".txt");
					printf "\t%f", sum{c in REGIONS} (Storage_out [c, j, "HEAT_HIGH_T", h, td]) > ( PathName & "/hourly_data_TD" & "/HTLayers_" & "ALL" & ".txt");
				}
				printf "\t%f", sum{c in REGIONS} (-End_uses [c, "HEAT_HIGH_T", h, td])  > ( PathName & "/hourly_data_TD" & "/HTLayers_" & "ALL" & ".txt");
			}

			print "--------------SAVING PASSANGER Layer TD ALL -----------";

			printf "Td\tTime" > ( PathName & "/hourly_data_TD" & "/PASSANGERSLayers_" & "ALL" & ".txt");
			for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{
				printf "\t%s",i > ( PathName & "/hourly_data_TD" & "/PASSANGERSLayers_" & "ALL" & ".txt");
			}
			for {j in STORAGE_TECH }{
				printf "\t%s_Pin",j > ( PathName & "/hourly_data_TD" & "/PASSANGERSLayers_" & "ALL" & ".txt");
				printf "\t%s_Pout",j > ( PathName & "/hourly_data_TD" & "/PASSANGERSLayers_" & "ALL" & ".txt");
			}
			printf "\tEND_USE" > ( PathName & "/hourly_data_TD" & "/PASSANGERSLayers_" & "ALL" & ".txt");

			for {td in TYPICAL_DAYS, h in HOURS}{
				printf "\n%d\t%d",td,h   > ( PathName & "/hourly_data_TD" & "/PASSANGERSLayers_" & "ALL" & ".txt");
				for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{if i in TECHNOLOGIES
				then 
					printf "\t%f",(sum {c in REGIONS, l in END_USES_TYPES_OF_CATEGORY["MOBILITY_PASSENGER"]} (layers_in_out[i, l] * F_t [c, i, h, td])) > 
			( PathName & "/hourly_data_TD" & "/PASSANGERSLayers_" & "ALL" & ".txt");
				else
						printf "\t%f",(sum {c in REGIONS, l in END_USES_TYPES_OF_CATEGORY["MOBILITY_PASSENGER"]} (layers_in_out[i, l] * (R_t_local[c, i, h, td] + R_t_import[c, i, h, td] - (1 + exchange_losses[i]) * R_t_export[c, i, h, td] + R_t_exterior[c, i, h, td]))) > 
				( PathName & "/hourly_data_TD" & "/PASSANGERSLayers_" & "ALL" & ".txt");
				}
				for {j in STORAGE_TECH }{
					printf "\t%f",sum {c in REGIONS, l in END_USES_TYPES_OF_CATEGORY["MOBILITY_PASSENGER"]}(-Storage_in [c, j, l, h, td]) > ( PathName & "/hourly_data_TD" & "/PASSANGERSLayers_" & "ALL" & ".txt");
					printf "\t%f",sum {c in REGIONS, l in END_USES_TYPES_OF_CATEGORY["MOBILITY_PASSENGER"]}(-Storage_out[c, j, l, h, td]) > ( PathName & "/hourly_data_TD" & "/PASSANGERSLayers_" & "ALL" & ".txt");
				}
				printf "\t%f", sum {c in REGIONS, l in END_USES_TYPES_OF_CATEGORY["MOBILITY_PASSENGER"]} (-End_uses [c, l, h, td] ) > ( PathName & "/hourly_data_TD" & "/PASSANGERSLayers_" & "ALL" & ".txt");
			}

			
			
			print "--------------SAVING FREIGHT Layer TD ALL -----------";

			printf "Td\tTime" > ( PathName & "/hourly_data_TD" & "/FREIGHTLayers_" & "ALL" & ".txt");
			for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{
				printf "\t%s",i > ( PathName & "/hourly_data_TD" & "/FREIGHTLayers_" & "ALL" & ".txt");
			}
			for {j in STORAGE_TECH }{
				printf "\t%s_Pin",j > ( PathName & "/hourly_data_TD" & "/FREIGHTLayers_" & "ALL" & ".txt");
				printf "\t%s_Pout",j > ( PathName & "/hourly_data_TD" & "/FREIGHTLayers_" & "ALL" & ".txt");
			}
			printf "\tEND_USE" > ( PathName & "/hourly_data_TD" & "/FREIGHTLayers_" & "ALL" & ".txt");

			for {td in TYPICAL_DAYS, h in HOURS}{
				printf "\n%d\t%d",td,h   > ( PathName & "/hourly_data_TD" & "/FREIGHTLayers_" & "ALL" & ".txt");
				for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{if i in TECHNOLOGIES
				then 
					printf "\t%f",(sum {c in REGIONS, l in END_USES_TYPES_OF_CATEGORY["MOBILITY_FREIGHT"]} (layers_in_out[i, l] * F_t [c, i, h, td])) > 
			( PathName & "/hourly_data_TD" & "/FREIGHTLayers_" & "ALL" & ".txt");
			else
					printf "\t%f",(sum {c in REGIONS, l in END_USES_TYPES_OF_CATEGORY["MOBILITY_FREIGHT"]} (layers_in_out[i, l] * (R_t_local[c, i, h, td] + R_t_import[c, i, h, td] - (1 + exchange_losses[i]) * R_t_export[c, i, h, td] + R_t_exterior[c, i, h, td]))) > 
			( PathName & "/hourly_data_TD" & "/FREIGHTLayers_" & "ALL" & ".txt");
				}
				for {j in STORAGE_TECH }{
					printf "\t%f",sum {c in REGIONS, l in END_USES_TYPES_OF_CATEGORY["MOBILITY_FREIGHT"]}(-Storage_in [c, j, l, h, td]) > ( PathName & "/hourly_data_TD" & "/FREIGHTLayers_" & "ALL" & ".txt");
					printf "\t%f",sum {c in REGIONS, l in END_USES_TYPES_OF_CATEGORY["MOBILITY_FREIGHT"]}(-Storage_out[c, j, l, h, td]) > ( PathName & "/hourly_data_TD" & "/FREIGHTLayers_" & "ALL" & ".txt");
				}
				printf "\t%f", sum {c in REGIONS, l in END_USES_TYPES_OF_CATEGORY["MOBILITY_FREIGHT"]} (-End_uses [c, l, h, td] )  > ( PathName & "/hourly_data_TD" & "/FREIGHTLayers_" & "ALL" & ".txt");
			}
			
			
			print "--------------SAVING Cooling Layer TD ALL -----------";

			printf "Td\tTime" > ( PathName & "/hourly_data_TD" & "/CoolingLayers_" & "ALL" & ".txt");
			for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH }{
				printf "\t%s",i > ( PathName & "/hourly_data_TD" & "/CoolingLayers_" & "ALL" & ".txt");
			}
			for {j in STORAGE_TECH }{
				printf "\t%s_Pin",j > ( PathName & "/hourly_data_TD" & "/CoolingLayers_" & "ALL" & ".txt");
				printf "\t%s_Pout",j > ( PathName & "/hourly_data_TD" & "/CoolingLayers_" & "ALL" & ".txt");
			}
			printf "\tEND_USE" > ( PathName & "/hourly_data_TD" & "/CoolingLayers_" & "ALL" & ".txt");

			for {td in TYPICAL_DAYS, h in HOURS}{
				printf "\n%d\t%d",td,h   > ( PathName & "/hourly_data_TD" & "/CoolingLayers_" & "ALL" & ".txt");
				for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{if i in TECHNOLOGIES
				then
						printf "\t%f", sum{c in REGIONS} (layers_in_out[i, "SPACE_COOLING"] * F_t [c, i, h, td]) > ( PathName & "/hourly_data_TD" & "/CoolingLayers_" & "ALL" & ".txt");
				else
						printf "\t%f", sum{c in REGIONS} (layers_in_out[i, "SPACE_COOLING"] * (R_t_local[c, i, h, td] + R_t_import[c, i, h, td] - (1 + exchange_losses[i]) * R_t_export[c, i, h, td] + R_t_exterior[c, i, h, td])) > ( PathName & "/hourly_data_TD" & "/CoolingLayers_" & "ALL" & ".txt");
				}
				for {j in STORAGE_TECH}{
					printf "\t%f", sum{c in REGIONS} (-Storage_in [c, j, "SPACE_COOLING", h, td]) > ( PathName & "/hourly_data_TD" & "/CoolingLayers_" & "ALL" & ".txt");
					printf "\t%f", sum{c in REGIONS} (Storage_out [c, j, "SPACE_COOLING", h, td]) > ( PathName & "/hourly_data_TD" & "/CoolingLayers_" & "ALL" & ".txt");
				}
				printf "\t%f", sum{c in REGIONS} (-End_uses [c, "SPACE_COOLING", h, td])  > ( PathName & "/hourly_data_TD" & "/CoolingLayers_" & "ALL" & ".txt");
			}


			print "--------------SAVING H2Layer TD ALL -----------";

			printf "Td\tTime" > ( PathName & "/hourly_data_TD" & "/H2Layers_" & "ALL" & ".txt");
			for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{
				printf "\t%s",i > ( PathName & "/hourly_data_TD" & "/H2Layers_" & "ALL" & ".txt");
			}
			for {j in STORAGE_TECH }{
				printf "\t%s_Pin",j > ( PathName & "/hourly_data_TD" & "/H2Layers_" & "ALL" & ".txt");
				printf "\t%s_Pout",j > ( PathName & "/hourly_data_TD" & "/H2Layers_" & "ALL" & ".txt");
			}
			printf "\tEND_USE" > ( PathName & "/hourly_data_TD" & "/H2Layers_" & "ALL" & ".txt");

			for {td in TYPICAL_DAYS, h in HOURS}{
				printf "\n%d\t%d",td,h   > ( PathName & "/hourly_data_TD" & "/H2Layers_" & "ALL" & ".txt");
				for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{if i in TECHNOLOGIES
				then 
					printf "\t%f", sum{c in REGIONS} (layers_in_out[i, "H2"] * F_t [c, i, h, td]) > ( PathName & "/hourly_data_TD" & "/H2Layers_" & "ALL" & ".txt");
				else
					printf "\t%f", sum{c in REGIONS} (layers_in_out[i, "H2"] * (R_t_local[c, i, h, td] + R_t_import[c, i, h, td] - (1 + exchange_losses[i]) * R_t_export[c, i, h, td] + R_t_exterior[c, i, h, td])) > ( PathName & "/hourly_data_TD" & "/H2Layers_" & "ALL" & ".txt");
					
				}
				for {j in STORAGE_TECH }{
					printf "\t%f", sum{c in REGIONS} (-Storage_in [c, j, "H2", h, td]) > ( PathName & "/hourly_data_TD" & "/H2Layers_" & "ALL" & ".txt");
					printf "\t%f", sum{c in REGIONS} (Storage_out [c, j, "H2", h, td]) > ( PathName & "/hourly_data_TD" & "/H2Layers_" & "ALL" & ".txt");
				}
				printf "\t%f", sum{c in REGIONS} (-End_uses [c, "H2", h, td])  > ( PathName & "/hourly_data_TD" & "/H2Layers_" & "ALL" & ".txt");
			}

			

			print "--------------SAVING NGLayer TD ALL -----------";

			printf "Td\tTime" > ( PathName & "/hourly_data_TD" & "/NGLayers_" & "ALL" & ".txt");
			for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{
				printf "\t%s",i > ( PathName & "/hourly_data_TD" & "/NGLayers_" & "ALL" & ".txt");
			}
			for {j in STORAGE_TECH }{
				printf "\t%s_Pin",j > ( PathName & "/hourly_data_TD" & "/NGLayers_" & "ALL" & ".txt");
				printf "\t%s_Pout",j > ( PathName & "/hourly_data_TD" & "/NGLayers_" & "ALL" & ".txt");
			}
			printf "\tEND_USE" > ( PathName & "/hourly_data_TD" & "/NGLayers_" & "ALL" & ".txt");

			for {td in TYPICAL_DAYS, h in HOURS}{
				printf "\n%d\t%d",td,h   > ( PathName & "/hourly_data_TD" & "/NGLayers_" & "ALL" & ".txt");
				for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{if i in TECHNOLOGIES
				then 
					printf "\t%f", sum{c in REGIONS} (layers_in_out[i, "GAS"] * F_t [c, i, h, td]) > ( PathName & "/hourly_data_TD" & "/NGLayers_" & "ALL" & ".txt");
				else
					printf "\t%f", sum{c in REGIONS} (layers_in_out[i, "GAS"] * (R_t_local[c, i, h, td] + R_t_import[c, i, h, td] - (1 + exchange_losses[i]) * R_t_export[c, i, h, td] + R_t_exterior[c, i, h, td])) > ( PathName & "/hourly_data_TD" & "/NGLayers_" & "ALL" & ".txt");
					
				}
				for {j in STORAGE_TECH }{
					printf "\t%f", sum{c in REGIONS} (-Storage_in [c, j, "GAS", h, td]) > ( PathName & "/hourly_data_TD" & "/NGLayers_" & "ALL" & ".txt");
					printf "\t%f", sum{c in REGIONS} (Storage_out [c, j, "GAS", h, td]) > ( PathName & "/hourly_data_TD" & "/NGLayers_" & "ALL" & ".txt");
				}
				printf "\t%f", sum{c in REGIONS} (-End_uses [c, "GAS", h, td])  > ( PathName & "/hourly_data_TD" & "/NGLayers_" & "ALL" & ".txt");
			}
			
			
			
			print "--------------SAVING METHANOLLayer TD ALL -----------";

			printf "Td\tTime" > ( PathName & "/hourly_data_TD" & "/METHANOLLayers_" & "ALL" & ".txt");
			for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{
				printf "\t%s",i > ( PathName & "/hourly_data_TD" & "/METHANOLLayers_" & "ALL" & ".txt");
			}
			for {j in STORAGE_TECH }{
				printf "\t%s_Pin",j > ( PathName & "/hourly_data_TD" & "/METHANOLLayers_" & "ALL" & ".txt");
				printf "\t%s_Pout",j > ( PathName & "/hourly_data_TD" & "/METHANOLLayers_" & "ALL" & ".txt");
			}
			printf "\tEND_USE" > ( PathName & "/hourly_data_TD" & "/METHANOLLayers_" & "ALL" & ".txt");

			for {td in TYPICAL_DAYS, h in HOURS}{
				printf "\n%d\t%d",td,h   > ( PathName & "/hourly_data_TD" & "/METHANOLLayers_" & "ALL" & ".txt");
				for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{if i in TECHNOLOGIES
				then 
					printf "\t%f", sum{c in REGIONS} (layers_in_out[i, "METHANOL"] * F_t [c, i, h, td]) > ( PathName & "/hourly_data_TD" & "/METHANOLLayers_" & "ALL" & ".txt");
				else
					printf "\t%f", sum{c in REGIONS} (layers_in_out[i, "METHANOL"] * (R_t_local[c, i, h, td] + R_t_import[c, i, h, td] - (1 + exchange_losses[i]) * R_t_export[c, i, h, td] + R_t_exterior[c, i, h, td])) > ( PathName & "/hourly_data_TD" & "/METHANOLLayers_" & "ALL" & ".txt");
					
				}
				for {j in STORAGE_TECH }{
					printf "\t%f", sum{c in REGIONS} (-Storage_in [c, j, "METHANOL", h, td]) > ( PathName & "/hourly_data_TD" & "/METHANOLLayers_" & "ALL" & ".txt");
					printf "\t%f", sum{c in REGIONS} (Storage_out [c, j, "METHANOL", h, td]) > ( PathName & "/hourly_data_TD" & "/METHANOLLayers_" & "ALL" & ".txt");
				}
				printf "\t%f", sum{c in REGIONS} (-End_uses [c, "METHANOL", h, td])  > ( PathName & "/hourly_data_TD" & "/METHANOLLayers_" & "ALL" & ".txt");
			}
			
			print "--------------SAVING AMMONIALayer TD ALL -----------";

			printf "Td\tTime" > ( PathName & "/hourly_data_TD" & "/AMMONIALayers_" & "ALL" & ".txt");
			for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{
				printf "\t%s",i > ( PathName & "/hourly_data_TD" & "/AMMONIALayers_" & "ALL" & ".txt");
			}
			for {j in STORAGE_TECH }{
				printf "\t%s_Pin",j > ( PathName & "/hourly_data_TD" & "/AMMONIALayers_" & "ALL" & ".txt");
				printf "\t%s_Pout",j > ( PathName & "/hourly_data_TD" & "/AMMONIALayers_" & "ALL" & ".txt");
			}
			printf "\tEND_USE" > ( PathName & "/hourly_data_TD" & "/AMMONIALayers_" & "ALL" & ".txt");

			for {td in TYPICAL_DAYS, h in HOURS}{
				printf "\n%d\t%d",td,h   > ( PathName & "/hourly_data_TD" & "/AMMONIALayers_" & "ALL" & ".txt");
				for {i in RESOURCES union TECHNOLOGIES diff STORAGE_TECH}{if i in TECHNOLOGIES
				then 
					printf "\t%f", sum{c in REGIONS} (layers_in_out[i, "AMMONIA"] * F_t [c, i, h, td]) > ( PathName & "/hourly_data_TD" & "/AMMONIALayers_" & "ALL" & ".txt");
				else
					printf "\t%f", sum{c in REGIONS} (layers_in_out[i, "AMMONIA"] * (R_t_local[c, i, h, td] + R_t_import[c, i, h, td] - (1 + exchange_losses[i]) * R_t_export[c, i, h, td] + R_t_exterior[c, i, h, td])) > ( PathName & "/hourly_data_TD" & "/AMMONIALayers_" & "ALL" & ".txt");
					
				}
				for {j in STORAGE_TECH }{
					printf "\t%f", sum{c in REGIONS} (-Storage_in [c, j, "AMMONIA", h, td]) > ( PathName & "/hourly_data_TD" & "/AMMONIALayers_" & "ALL" & ".txt");
					printf "\t%f", sum{c in REGIONS} (Storage_out [c, j, "AMMONIA", h, td]) > ( PathName & "/hourly_data_TD" & "/AMMONIALayers_" & "ALL" & ".txt");
				}
				printf "\t%f", sum{c in REGIONS} (-End_uses [c, "AMMONIA", h, td])  > ( PathName & "/hourly_data_TD" & "/AMMONIALayers_" & "ALL" & ".txt");
			}
			
			#------------------------------------------
			# Exchanges losses printing
			#------------------------------------------
			print "--------- SAVING Exchanges Losses TD ALL --------";
			
			printf "Unit\t[GW]" > (PathName & "/hourly_data_TD" & "/exch_losses.txt");
			for {i in RESOURCES}{
				for {c in REGIONS}{
					printf "\t%s", i > (PathName & "/hourly_data_TD" & "/exch_losses.txt");
				}
			}
			printf "\n" > (PathName & "/hourly_data_TD" & "/exch_losses.txt");
			printf "Td\tTime" > (PathName & "/hourly_data_TD" & "/exch_losses.txt");
			for {i in RESOURCES}{
				for {c in REGIONS}{
						printf "\t%s", c > (PathName & "/hourly_data_TD" & "/exch_losses.txt");
				}
			}
			for {td in TYPICAL_DAYS, h in HOURS}{
				printf "\n%d\t%d",td,h   > (PathName & "/hourly_data_TD" & "/exch_losses.txt");
				for {i in RESOURCES}{
					for {c in REGIONS}{
						printf "\t%.6f",(R_t_export[c, i, h, td]*exchange_losses[i]) > (PathName & "/hourly_data_TD" & "/exch_losses.txt");
					}
				}	
			}
			
			
			
			
			#------------------------------------------
			# Resources balance
			#------------------------------------------
			print ("--------- SAVING Resources balance TD ALL --------");
			
			printf "Unit\t[GW]" > (PathName & "/hourly_data_TD" & "/resources_ALL.txt");
			for {i in RESOURCES}{
					printf "\t%s\t%s", i, i > (PathName & "/hourly_data_TD" & "/resources_ALL.txt");
			}
			printf "\n" > (PathName & "/hourly_data_TD" & "/resources_ALL.txt");
			printf "Td\tTime" > (PathName & "/hourly_data_TD" & "/resources_ALL.txt");
			for {i in RESOURCES}{
					printf "\tR_t_local\tR_t_exterior" > (PathName & "/hourly_data_TD" & "/resources_ALL.txt");
			}
			for {td in TYPICAL_DAYS, h in HOURS}{
				printf "\n%d\t%d",td,h   > (PathName & "/hourly_data_TD" & "/resources_ALL.txt");
				for {i in RESOURCES}{
					printf "\t%.6f\t%.6f", sum{c in REGIONS} R_t_local[c, i, h, td], sum{c in REGIONS} R_t_exterior[c, i, h, td] > (PathName & "/hourly_data_TD" & "/resources_ALL.txt");
				}
			}
		
			
			
			#------------------------------------------
			# Curtailement
			#------------------------------------------		
			
			printf "Country" > (PathName & "/Curt" & ".txt");
			for {c in REGIONS}{
			printf "\t%s", c > ( PathName & "/Curt" & ".txt"); }
			
			for {c in REGIONS}{
			printf "\nCurtailment\t%.2f",Curt[c] > ( PathName & "/Curt" & ".txt");
			}

			###############################################################################                                                    
			#																			  #
			#                     			  SHARE										  #                                                    
			#																			  #
			###############################################################################
			
			#first table
			printf "Country\tShare_heat_dhn\tShare_mobility_public\tShare_freight_train\tShare_freight_road\tShare_freight_boat\n" > ( PathName & "/Share" & ".txt"); 
			for {c in REGIONS}{
			printf "%s\t%.2f\t%.2f\t%.2f\t%.2f\t%.2f\n", c, Share_heat_dhn[c], Share_mobility_public[c], Share_freight_train[c], Share_freight_road[c], Share_freight_boat[c] > ( PathName & "/Share" & ".txt");
			}
			
			# second table
			printf "Country" > ( PathName & "/Share" & ".txt");
			for {i in TECHNOLOGIES_OF_END_USES_CATEGORY["MOBILITY_PASSENGER"]}{
				printf "\t%s",i > ( PathName & "/Share" & ".txt");
			}
			for {i in TECHNOLOGIES_OF_END_USES_CATEGORY["MOBILITY_FREIGHT"]}{
				printf "\t%s",i > ( PathName & "/Share" & ".txt");
			}
			for {i in TECHNOLOGIES_OF_END_USES_TYPE["HEAT_LOW_T_DECEN"] diff {"DEC_SOLAR"}}{
				printf "\t%s",i > ( PathName & "/Share" & ".txt");
			}
			
			for {c in REGIONS}{
				printf "\n%s",c > ( PathName & "/Share" & ".txt");
				
				for {i in TECHNOLOGIES_OF_END_USES_CATEGORY["MOBILITY_PASSENGER"]}{
					printf "\t%.4f", Shares_mobility_passenger[c,i] > ( PathName & "/Share" & ".txt");
				}
				
				for {i in TECHNOLOGIES_OF_END_USES_CATEGORY["MOBILITY_FREIGHT"]}{
					printf "\t%.4f", Shares_mobility_freight[c,i] > ( PathName & "/Share" & ".txt");
				}
				
				for {i in TECHNOLOGIES_OF_END_USES_TYPE["HEAT_LOW_T_DECEN"] diff {"DEC_SOLAR"}}{
					printf "%\t.4f", Shares_lowT_dec[c,i] > ( PathName & "/Share" & ".txt");
				}
			
			
			}




			################################################################################
			################################################################################                                                    
			##																			  ##
			##                     			    SANKEY 	     							  ##                                                    
			##																			  ##
			################################################################################
			################################################################################
			
			# For now:
				# neglect storage of fuels
				# BEV_BATT and PHEV_BATT
				# neglect dam storage
				# neglect CCS
				# neglect very small secondary consumption (often elec) of some processes (ex: SYN_METHANOLATION)
				
			
			
			###############################################################################                                                    
			#																			  #
			#                            OVERALL SYSTEM'S SANKEY            			  #                                                    
			#																			  #
			###############################################################################
		
			print "--------- SAVING SANKEY --------";

			## Generate CSV file to be used as input to Sankey diagram
			# Notes:
			# - Assuming that GAS_RE and BioOil are used in boilers
			printf "%s,%s,%s,%s,%s,%s\n", "source" , "target", "realValue", "layerID", "layerColor", "layerUnit" > ( PathName & "/input2sankey.csv");
			
			#------------------------------------------
			# SANKEY - RESOURCES
			#------------------------------------------
			## Gasoline
				#Gasoline imports --> Gasoline 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"GASOLINE", h, td] + R_t_local [c,"GASOLINE", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Gasoline imports" , "Gasoline", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]} (layers_in_out["GASOLINE","GASOLINE"] * R_t_exterior [c,"GASOLINE", h, td] + layers_in_out["GASOLINE","GASOLINE"] * R_t_local [c,"GASOLINE", h, td] ) / 1000 , 
			"Gasoline", "#808080", "TWh" > ( PathName & "/input2sankey.csv");
			
				# Gasoline --> Mob Priv
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
			((F_t [c,"CAR_GASOLINE", h, td] + F_t [c,"CAR_PHEV", h, td] + F_t [c,"CAR_HEV", h, td]) ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Gasoline" , "Mob priv",
			sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
			(-layers_in_out["CAR_GASOLINE","GASOLINE"] * F_t [c,"CAR_GASOLINE", h, td]
			- layers_in_out["CAR_PHEV","GASOLINE"] * F_t [c,"CAR_PHEV", h, td]
			- layers_in_out["CAR_HEV","GASOLINE"] * F_t [c,"CAR_HEV", h, td]  ) / 1000
			, "Gasoline", "#808080", "TWh" > ( PathName & "/input2sankey.csv");
			
				
			
			
			## Diesel
			
				#Diesel imports --> Diesel 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"DIESEL", h, td] + R_t_local [c,"DIESEL", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Diesel imports" , "Diesel", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]} (layers_in_out["DIESEL","DIESEL"] * R_t_exterior [c,"DIESEL", h, td] + layers_in_out["DIESEL","DIESEL"] * R_t_local [c,"DIESEL", h, td] ) / 1000 , "Diesel", "#D3D3D3", "TWh" > 
			( PathName & "/input2sankey.csv");
			
				#Diesel-->Mob Priv
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"CAR_DIESEL", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Diesel" , "Mob priv", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["CAR_DIESEL","DIESEL"] * F_t [c,"CAR_DIESEL", h, td]  ) / 1000 , "Diesel", 
			"#D3D3D3", "TWh" > ( PathName & "/input2sankey.csv");
				
				#Diesel-->Mob Pub
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((F_t [c,"BUS_COACH_DIESEL", h, td] + 
			F_t[c,"BUS_COACH_HYDIESEL", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Diesel" , "Mob public", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["BUS_COACH_DIESEL","DIESEL"] * F_t [c,"BUS_COACH_DIESEL", h, td]   - 
			layers_in_out["BUS_COACH_HYDIESEL","DIESEL"] * F_t [c,"BUS_COACH_HYDIESEL", h, td]   ) / 1000 , "Diesel", "#D3D3D3", "TWh" 
			> ( PathName & "/input2sankey.csv");
				
				#Diesel-->Freight
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((F_t [c,"TRUCK_DIESEL", h, td]+F_t [c,"BOAT_FREIGHT_DIESEL", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Diesel" , "Freight", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["TRUCK_DIESEL","DIESEL"] * F_t [c,"TRUCK_DIESEL", h, td] -layers_in_out["BOAT_FREIGHT_DIESEL","DIESEL"] * F_t [c,"BOAT_FREIGHT_DIESEL", h, td]  ) / 1000 , "Diesel", "#D3D3D3", "TWh" 
			> ( PathName & "/input2sankey.csv");
			
				

			
			## Bioethanol and Biodiesel
			#Bioethanol --> Gasoline 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"BIOETHANOL", h, td] + R_t_local [c,"BIOETHANOL", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Bioethanol" , "Gasoline", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]} (layers_in_out["BIOETHANOL","GASOLINE"] * R_t_exterior [c,"BIOETHANOL", h, td] + layers_in_out["BIOETHANOL","GASOLINE"] * R_t_local [c,"BIOETHANOL", h, td] ) / 1000 , 
			"Gasoline", "#808080", "TWh" > ( PathName & "/input2sankey.csv");
			
			#Biodiesel --> Diesel 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"BIODIESEL", h, td] + R_t_local [c,"BIODIESEL", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Biodiesel" , "Diesel", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]} (layers_in_out["BIODIESEL","DIESEL"] * R_t_exterior [c,"BIODIESEL", h, td] + layers_in_out["BIODIESEL","DIESEL"] * R_t_local [c,"BIODIESEL", h, td] ) / 1000 , "Diesel", "#D3D3D3", "TWh" > 
			( PathName & "/input2sankey.csv");
			
			## LFO
				#LFO imports --> LFO 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"LFO", h, td] + R_t_local [c,"LFO", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Oil imports" , "Oil", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]} (layers_in_out["LFO","LFO"] * R_t_exterior [c,"LFO", h, td] + layers_in_out["LFO","LFO"] * R_t_local [c,"LFO", h, td] ) / 1000 , 
			"Oil", "#8B008B", "TWh" > ( PathName & "/input2sankey.csv");
			
			
			## Gas
			
				#Gas Fossil extracted  --> Gas
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"GAS", h, td] + R_t_local [c,"GAS", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Gas Fossil" , "Gas", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["GAS","GAS"] * R_t_exterior [c,"GAS", h, td] + layers_in_out["GAS","GAS"] * R_t_local [c,"GAS", h, td] ) / 1000 , "Gas", "#FFD700", "TWh" 
			> ( PathName & "/input2sankey.csv");
			
				#GAS_RE  --> Gas
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"GAS_RE", h, td] + R_t_local [c,"GAS_RE", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "GAS_RE imports" , "Gas", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["GAS_RE","GAS"] * R_t_exterior [c,"GAS_RE", h, td] + layers_in_out["GAS_RE","GAS"] * R_t_local [c,"GAS_RE", h, td] ) / 1000 , "Gas", "#FFD700", "TWh" 
			> ( PathName & "/input2sankey.csv");
			
				#Gas --> Freight
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((F_t [c,"TRUCK_NG", h, td] + F_t [c,"BOAT_FREIGHT_NG", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Gas" , "Freight", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["TRUCK_NG","GAS"] * F_t [c,"TRUCK_NG", h, td] -layers_in_out["BOAT_FREIGHT_NG","GAS"] * F_t [c,"BOAT_FREIGHT_NG", h, td] ) / 1000 , "Gas", "#FFD700", "TWh" 
			> ( PathName & "/input2sankey.csv");
				
				#Gas --> Mob Priv
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"CAR_NG", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Gas" , "Mob priv", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["CAR_NG","GAS"] * F_t [c,"CAR_NG", h, td]  ) / 1000 , "Gas", "#FFD700", "TWh" > 
			( PathName & "/input2sankey.csv");
				
				#Gas --> Mob Pub
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"BUS_COACH_CNG_STOICH", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Gas" , "Mob public", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["BUS_COACH_CNG_STOICH","GAS"] * F_t [c,"BUS_COACH_CNG_STOICH", h, td]  ) / 1000 , 
			"Gas", "#FFD700", "TWh" > ( PathName & "/input2sankey.csv");
				
				#Gas --> H2
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"SMR", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Gas" , "H2", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["SMR","GAS"] * F_t [c,"SMR", h, td]  ) / 1000 , "Gas", "#FFD700", "TWh" > 
			( PathName & "/input2sankey.csv");
			
				#Gas --> METHANOL
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"METHANE_TO_METHANOL", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Gas" , "Methanol", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["METHANE_TO_METHANOL","GAS"] * F_t [c,"METHANE_TO_METHANOL", h, td]  ) / 1000 , "Gas", "#FFD700", "TWh" > 
			( PathName & "/input2sankey.csv");
		
				#Gas --> CCGT
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"CCGT", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Gas" , "CCGT", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["CCGT","GAS"] * F_t [c,"CCGT", h, td]  ) / 1000 , "Gas", "#FFD700", "TWh" > 
			( PathName & "/input2sankey.csv");
			
				#CCGT --> Elec
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"CCGT", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "CCGT" , "Elec", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["CCGT","ELECTRICITY"] * F_t [c,"CCGT", h, td]  ) / 1000 , "Electricity", "#00BFFF", "TWh" > 
			( PathName & "/input2sankey.csv");
			
				#Gas --> CHP
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"IND_COGEN_GAS", h, td] + F_t [c,"DHN_COGEN_GAS", h, 
			td] + F_t [c,"DEC_COGEN_GAS", h, td] + F_t [c,"DEC_ADVCOGEN_GAS", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Gas" , "CHP", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["IND_COGEN_GAS","GAS"] * F_t [c,"IND_COGEN_GAS", h, td]   - 
			layers_in_out["DHN_COGEN_GAS","GAS"] * F_t [c,"DHN_COGEN_GAS", h, td]   - layers_in_out["DEC_COGEN_GAS","GAS"] * F_t 
			[c,"DEC_COGEN_GAS", h, td]   - layers_in_out["DEC_ADVCOGEN_GAS","GAS"] * F_t [c,"DEC_ADVCOGEN_GAS", h, td]  ) / 
			1000 , "Gas", "#FFD700", "TWh" > ( PathName & "/input2sankey.csv");
				#Gas --> HP
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"DEC_THHP_GAS", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Gas" , "HPs", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["DEC_THHP_GAS","GAS"] * F_t [c,"DEC_THHP_GAS", h, td]  ) / 1000 , "Gas", "#FFD700", 
			"TWh" > ( PathName & "/input2sankey.csv");
				#Gas --> Boilers 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"IND_BOILER_GAS", h, td] + F_t [c,"DHN_BOILER_GAS", 
			h, td] + F_t [c,"DEC_BOILER_GAS", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Gas" , "Boilers", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["IND_BOILER_GAS","GAS"] * F_t [c,"IND_BOILER_GAS", h, td]   - 
			layers_in_out["DHN_BOILER_GAS","GAS"] * F_t [c,"DHN_BOILER_GAS", h, td]   - layers_in_out["DEC_BOILER_GAS","GAS"] * F_t 
			[c,"DEC_BOILER_GAS", h, td]  ) / 1000 , "Gas", "#FFD700", "TWh" > ( PathName & "/input2sankey.csv");

			
			
			## Ammonia
			
				#AMMONIA imports  --> AMMONIA
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"AMMONIA", h, td] + R_t_local [c,"AMMONIA", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Ammonia imports" , "Ammonia", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["AMMONIA","AMMONIA"] * R_t_exterior [c,"AMMONIA", h, td] + layers_in_out["AMMONIA","AMMONIA"] * R_t_local [c,"AMMONIA", h, td] ) / 1000 ,
			"Ammonia", "#000ECD", "TWh" 
			> ( PathName & "/input2sankey.csv");
			
				#AMMONIA RE  --> AMMONIA
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"AMMONIA_RE", h, td] + R_t_local [c,"AMMONIA_RE", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Ammonia RE" , "Ammonia", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["AMMONIA_RE","AMMONIA"] * R_t_exterior [c,"AMMONIA_RE", h, td] + layers_in_out["AMMONIA_RE","AMMONIA"] * R_t_local [c,"AMMONIA_RE", h, td] ) / 1000 ,
			"Ammonia", "#000ECD", "TWh" 
			> ( PathName & "/input2sankey.csv");
			
				# HABER_BOSCH
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (F_t [c, "HABER_BOSCH", h, td]  ) > 10 then {
				printf "%s,%s,%.2f,%s,%s,%s\n", "H2" , "Haber-Bosch", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										(-layers_in_out["HABER_BOSCH","H2"] * F_t [c, "HABER_BOSCH", h, td]  ) / 1000 , "H2", 
				"#FF00FF", "TWh" >> (PathName & "/input2sankey.csv");
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Haber-Bosch", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										(-layers_in_out["HABER_BOSCH","ELECTRICITY"] * F_t [c, "HABER_BOSCH", h, td]  ) / 1000 , "Electricity", 
				"#00BFFF", "TWh" >> (PathName & "/input2sankey.csv");
				printf "%s,%s,%.2f,%s,%s,%s\n", "Haber-Bosch" , "DHN", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										(layers_in_out["HABER_BOSCH","HEAT_LOW_T_DHN"] * F_t [c, "HABER_BOSCH", h, td]  ) / 1000 , "DHN", 
				"#FA8072", "TWh" >> (PathName & "/input2sankey.csv");
				printf "%s,%s,%.2f,%s,%s,%s\n", "Haber-Bosch" , "Ammonia", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										(layers_in_out["HABER_BOSCH","AMMONIA"] * F_t [c, "HABER_BOSCH", h, td]  ) / 1000 , "Ammonia", 
				"#000ECD", "TWh" >> (PathName & "/input2sankey.csv");
			}
			
				# AMMONIA to CCGT_AMMONIA
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (F_t [c, "CCGT_AMMONIA", h, td]  ) > 10 then {
				printf "%s,%s,%.2f,%s,%s,%s\n", "Ammonia" , "CCGT", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										(-layers_in_out["CCGT_AMMONIA","AMMONIA"] * F_t [c, "CCGT_AMMONIA", h, td]  ) / 1000 , "Ammonia", 
				"#000ECD", "TWh" >> (PathName & "/input2sankey.csv");
			}	
			
				# CCGT_AMMONIA to ELEC
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (F_t [c, "CCGT_AMMONIA", h, td]  ) > 10 then {
				printf "%s,%s,%.2f,%s,%s,%s\n", "CCGT" , "Elec", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										(layers_in_out["CCGT_AMMONIA","ELECTRICITY"] * F_t [c, "CCGT_AMMONIA", h, td]  ) / 1000 , "Electricity", 
				"#00BFFF", "TWh" >> (PathName & "/input2sankey.csv");
			}
			
				# AMMONIA to H2
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (F_t [c, "AMMONIA_TO_H2", h, td]  ) > 10 then {
				printf "%s,%s,%.2f,%s,%s,%s\n", "Ammonia" , "H2", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										(-layers_in_out["AMMONIA_TO_H2","AMMONIA"] * F_t [c, "AMMONIA_TO_H2", h, td]  ) / 1000 , "H2",
				"#FF00FF", "TWh" >> (PathName & "/input2sankey.csv");
			}
			
				# AMMONIA to NED
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (End_uses [c, "AMMONIA", h, td]  ) > 10 then {
				printf "%s,%s,%.2f,%s,%s,%s\n", "Ammonia" , "Non-energy demand", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										End_uses [c, "AMMONIA", h, td]   / 1000 , "Ammonia", 
				"#000ECD", "TWh" >> (PathName & "/input2sankey.csv");
			}
			
			## Methanol
			
				#METHANOL imports  --> METHANOL
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"METHANOL", h, td] + R_t_local [c,"METHANOL", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Methanol imports" , "Methanol", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["METHANOL","METHANOL"] * R_t_exterior [c,"METHANOL", h, td] + layers_in_out["METHANOL","METHANOL"] * R_t_local [c,"METHANOL", h, td] ) / 1000 , 
			"Methanol", "#CC0066", "TWh" 
			> ( PathName & "/input2sankey.csv");
			
				#METHANOL RE  --> METHANOL
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"METHANOL_RE", h, td] + R_t_local [c,"METHANOL_RE", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Methanol RE" , "Methanol", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["METHANOL_RE","METHANOL"] * R_t_exterior [c,"METHANOL_RE", h, td] + layers_in_out["METHANOL_RE","METHANOL"] * R_t_local [c,"METHANOL_RE", h, td] ) / 1000 , 
			"Methanol", "#CC0066", "TWh" 
			> ( PathName & "/input2sankey.csv");
			
				# METHANOL_TO_NED
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (End_uses [c, "METHANOL", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Methanol" , "Non-energy demand", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										End_uses [c, "METHANOL", h, td]   / 1000 , "Methanol", 
				"#CC0066", "TWh" >> (PathName & "/input2sankey.csv");
			
				# Methanol -> Mob priv
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
			(F_t [c, "CAR_METHANOL", h, td] ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Methanol" , "Mob priv",
				sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
				(-layers_in_out["CAR_METHANOL","METHANOL"] * F_t [c, "CAR_METHANOL", h, td]) / 1000
				, "Methanol", "#CC0066", "TWh" >> (PathName & "/input2sankey.csv");
				
				# Methanol --> Freight
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
			((F_t [c, "BOAT_FREIGHT_METHANOL", h, td] + F_t [c, "TRUCK_METHANOL", h, td])) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Methanol" , "Freight",
				sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
				(-layers_in_out["BOAT_FREIGHT_METHANOL","METHANOL"] * F_t [c, "BOAT_FREIGHT_METHANOL", h, td]
				- layers_in_out["TRUCK_METHANOL","METHANOL"] * F_t [c, "TRUCK_METHANOL", h, td]) / 1000
				, "Methanol", "#CC0066", "TWh" > (PathName & "/input2sankey.csv");

			
			## HVC
			
				# OIL_TO_HVC
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (F_t [c, "OIL_TO_HVC", h, td]  ) > 10 then {
				printf "%s,%s,%.2f,%s,%s,%s\n", "Oil", "NSC", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										(-layers_in_out["OIL_TO_HVC","LFO"] * F_t [c, "OIL_TO_HVC", h, td]  ) / 1000 , "Naphtha", 
				"#8B008B", "TWh" >> (PathName & "/input2sankey.csv");
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "NSC", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										(-layers_in_out["OIL_TO_HVC","ELECTRICITY"] * F_t [c, "OIL_TO_HVC", h, td]  ) / 1000 , "Electricity", 
				"#00BFFF", "TWh" >> (PathName & "/input2sankey.csv");
				printf "%s,%s,%.2f,%s,%s,%s\n", "Heat HT" , "NSC", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
					TYPICAL_DAY_OF_PERIOD[t]}(- layers_in_out["OIL_TO_HVC","HEAT_HIGH_T"] * F_t [c, "OIL_TO_HVC", h, td]  ) / 1000 ,
					"Heat HT", "#DC143C", "TWh" >> (PathName & "/input2sankey.csv");
				printf "%s,%s,%.2f,%s,%s,%s\n", "NSC", "HVC", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										(layers_in_out["OIL_TO_HVC","HVC"] * F_t [c, "OIL_TO_HVC", h, td]  ) / 1000 , "HVC", 
				"#00FFFF", "TWh" >> (PathName & "/input2sankey.csv");
				}

				# GAS_TO_HVC
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c, "GAS_TO_HVC", h, td]  ) > 10 then {
				printf "%s,%s,%.2f,%s,%s,%s\n", "Gas" , "OCM", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
					TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["GAS_TO_HVC","GAS"] * F_t [c, "GAS_TO_HVC", h, td]  ) / 1000 , "Gas", "#FFD700", "TWh" >> 
					(PathName & "/input2sankey.csv");
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "OCM", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
					TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["GAS_TO_HVC","ELECTRICITY"] * F_t [c, "GAS_TO_HVC", h, td]  ) / 1000 , "Electricity", "#00BFFF", "TWh" >> 
					(PathName & "/input2sankey.csv");
				printf "%s,%s,%.2f,%s,%s,%s\n", "OCM" , "HVC", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
					TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["GAS_TO_HVC","HVC"] * F_t [c, "GAS_TO_HVC", h, td]  ) / 1000 , "HVC", "#00FFFF", "TWh" >> 
					(PathName & "/input2sankey.csv");
				}
				
				# BIOMASS_TO_HVC
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c, "BIOMASS_TO_HVC", h, td]  ) > 10 then {
				printf "%s,%s,%.2f,%s,%s,%s\n", "Wood" , "Gasifi. to HVC", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
					TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["BIOMASS_TO_HVC","WOOD"] * F_t [c, "BIOMASS_TO_HVC", h, td]  ) / 1000 , "Wood", "#CD853F", "TWh" >> 
					(PathName & "/input2sankey.csv");
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Gasifi. to HVC", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
					TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["BIOMASS_TO_HVC","ELECTRICITY"] * F_t [c, "BIOMASS_TO_HVC", h, td]  ) / 1000 , "Electricity", "#00BFFF", "TWh" >> 
					(PathName & "/input2sankey.csv");
				printf "%s,%s,%.2f,%s,%s,%s\n", "Heat HT" , "Gasifi. to HVC", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
					TYPICAL_DAY_OF_PERIOD[t]}(- layers_in_out["BIOMASS_TO_HVC","HEAT_HIGH_T"] * F_t [c, "BIOMASS_TO_HVC", h, td]  ) / 1000 ,
					"Heat HT", "#DC143C", "TWh" >> (PathName & "/input2sankey.csv");
				printf "%s,%s,%.2f,%s,%s,%s\n", "Gasifi. to HVC" , "HVC", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
					TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["BIOMASS_TO_HVC","HVC"] * F_t [c, "BIOMASS_TO_HVC", h, td]  ) / 1000 , "HVC", "#00FFFF", "TWh" >> 
					(PathName & "/input2sankey.csv");
				}

				# METHANOL_TO_HVC
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c, "METHANOL_TO_HVC", h, td]  ) > 10 then {
				printf "%s,%s,%.2f,%s,%s,%s\n", "Methanol" , "MTO", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
					TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["METHANOL_TO_HVC","METHANOL"] * F_t [c, "METHANOL_TO_HVC", h, td]  ) / 1000 , "Methanol", "#CC0066", "TWh" >> 
					(PathName & "/input2sankey.csv");
				printf "%s,%s,%.2f,%s,%s,%s\n", "Heat HT" , "MTO", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
					TYPICAL_DAY_OF_PERIOD[t]}(- layers_in_out["METHANOL_TO_HVC","HEAT_HIGH_T"] * F_t [c, "METHANOL_TO_HVC", h, td]  ) / 1000 ,
					"Heat HT", "#DC143C", "TWh" >> (PathName & "/input2sankey.csv");
				printf "%s,%s,%.2f,%s,%s,%s\n", "MTO" , "HVC", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
					TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["METHANOL_TO_HVC","HVC"] * F_t [c, "METHANOL_TO_HVC", h, td]  ) / 1000 , "HVC", "#00FFFF", "TWh" >> 
					(PathName & "/input2sankey.csv");
				}
				
				# HVC_TO_NED
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (End_uses [c, "HVC", h, td]  ) > 10 then {
				printf "%s,%s,%.2f,%s,%s,%s\n", "HVC" , "Non-energy demand", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										End_uses [c, "HVC", h, td]   / 1000 , "HVC", "#00FFFF", "TWh"
				>> (PathName & "/input2sankey.csv");
			}
		
			
			## Electricity production
			
				#Elec import from outside system
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(R_t_exterior [c,"ELECTRICITY", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec. import" , "Elec", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["ELECTRICITY","ELECTRICITY"] * R_t_exterior [c,"ELECTRICITY", h, td]  ) / 1000 , 
			"Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey.csv");
				
				#Uranium --> Elec
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"NUCLEAR", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Nuclear" , "Elec", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["NUCLEAR","ELECTRICITY"] * F_t [c,"NUCLEAR", h, td]  ) / 1000 , "Nuclear", 
			"#FFC0CB", "TWh" > ( PathName & "/input2sankey.csv");
			
				#WindOn --> Elec
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F[c,"WIND_ONSHORE"]*c_p_t["WIND_ONSHORE",c,h,td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Wind Onshore" , "Elec", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["WIND_ONSHORE","ELECTRICITY"] * F[c,"WIND_ONSHORE"]*c_p_t["WIND_ONSHORE",c,h,td]  ) / 1000 , "Wind Onshore", "#27AE34", "TWh" 
			> ( PathName & "/input2sankey.csv");
				
				#WindOff --> Elec
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F[c,"WIND_OFFSHORE"]*c_p_t["WIND_OFFSHORE",c,h,td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Wind Offshore" , "Elec", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["WIND_OFFSHORE","ELECTRICITY"] * F[c,"WIND_OFFSHORE"]*c_p_t["WIND_OFFSHORE",c,h,td]  ) / 1000 , "Wind Offshore", "#27AE34", "TWh" 
			> ( PathName & "/input2sankey.csv");
				
				#HydroDam --> Dam Sto
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"HYDRO_DAM", h, td] )  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Hydro Dams" , "Dam Sto", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["HYDRO_DAM","ELECTRICITY"] * F_t [c,"HYDRO_DAM", h, td]  ) / 1000 , "Hydro Dam", "#00CED1", "TWh" > 
			( PathName & "/input2sankey.csv");
			
				#Dam Sto --> Elec
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"HYDRO_DAM", h, td] )  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Dam Sto" , "Elec", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(Storage_out[c, "DAM_STORAGE", "ELECTRICITY", h, td] / storage_eff_out ["DAM_STORAGE", "ELECTRICITY"]) / 1000 , "Hydro Dam", "#00CED1", "TWh" > 
			( PathName & "/input2sankey.csv");
				
				#HydroRiver --> Elec
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"HYDRO_RIVER", h, td] )  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Hydro River" , "Elec", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["HYDRO_RIVER","ELECTRICITY"] * F_t [c,"HYDRO_RIVER", h, td]   ) / 1000 , "Hydro River", "#0000FF", 
			"TWh" > ( PathName & "/input2sankey.csv");
				
				#Ocean --> Elec
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
			(F_t [c,"NEW_TIDAL_STREAM", h, td] + F_t [c,"TIDAL_STREAM", h, td] + F_t [c,"TIDAL_RANGE", h, td] + F_t [c,"WAVE", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Ocean" , "Elec",
				sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
				(layers_in_out["NEW_TIDAL_STREAM","ELECTRICITY"] * F_t [c,"NEW_TIDAL_STREAM", h, td]
				+ layers_in_out["TIDAL_STREAM","ELECTRICITY"] * F_t [c,"TIDAL_STREAM", h, td]
				+ layers_in_out["TIDAL_RANGE","ELECTRICITY"] * F_t [c,"TIDAL_RANGE", h, td]
				+ layers_in_out["WAVE","ELECTRICITY"] * F_t [c,"WAVE", h, td]) / 1000 ,
				"Ocean", " #2549a3", "TWh" > ( PathName & "/input2sankey.csv");
				
				#Coal --> Elec
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"COAL_US", h, td] + F_t [c,"COAL_IGCC", h, td]) ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Coal" , "Elec", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["COAL_US","COAL"] * F_t [c,"COAL_US", h, td]   - layers_in_out["COAL_IGCC","COAL"] 
			* F_t [c,"COAL_IGCC", h, td]  ) / 1000 , "Coal", "#A0522D", "TWh" > ( PathName & "/input2sankey.csv");
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"IND_BOILER_COAL", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Coal" , "Boilers", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["IND_BOILER_COAL","COAL"] * F_t [c,"IND_BOILER_COAL", h, td]  ) / 1000 , "Coal", 
			"#A0522D", "TWh" > ( PathName & "/input2sankey.csv");
			
				# Solar PV --> Elec
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F [c,"PV"] *c_p_t["PV",c,h,td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Solar PV" , "Elec", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["PV","ELECTRICITY"] * F [c,"PV"] *c_p_t["PV",c,h,td] ) / 1000 , "Solar", "#FFFF00", "TWh" > 
			( PathName & "/input2sankey.csv");
				
				# Solar --> CSP Sto.
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
			(Storage_in[c, "PT_STORAGE", "PT_HEAT", h, td] + Storage_in[c, "ST_STORAGE", "ST_HEAT", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Solar" , "CSP Sto.",
				sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
				(Storage_in[c, "PT_STORAGE", "PT_HEAT", h, td] + Storage_in[c, "ST_STORAGE", "ST_HEAT", h, td])/ 1000
				, "Solar", "#FFFF00", "TWh" > ( PathName & "/input2sankey.csv");
			
				# Solar --> CSP (power block)
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
			(F [c,"PT_COLLECTOR"] *c_p_t["PT_COLLECTOR",c,h,td] + F [c,"ST_COLLECTOR"] *c_p_t["ST_COLLECTOR",c,h,td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Solar" , "CSP",
				sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
				((F [c,"PT_COLLECTOR"] *c_p_t["PT_COLLECTOR",c,h,td] + F [c,"ST_COLLECTOR"] *c_p_t["ST_COLLECTOR",c,h,td])
				- (Storage_in[c, "PT_STORAGE", "PT_HEAT", h, td] + Storage_in[c, "ST_STORAGE", "ST_HEAT", h, td]))/ 1000
				,"Solar", "#FFFF00", "TWh" > ( PathName & "/input2sankey.csv");
				
				# CSP Sto. --> CSP power block 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
			(Storage_out[c, "PT_STORAGE", "PT_HEAT", h, td] + Storage_out[c, "ST_STORAGE", "ST_HEAT", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "CSP Sto." , "CSP",
				sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
				(Storage_out[c, "PT_STORAGE", "PT_HEAT", h, td] / storage_eff_out ["PT_STORAGE", "PT_HEAT"] 
				+ Storage_out[c, "ST_STORAGE", "ST_HEAT", h, td] / storage_eff_out ["ST_STORAGE", "ST_HEAT"])/ 1000
				, "Solar", "#FFFF00", "TWh" > ( PathName & "/input2sankey.csv");
				
				# CSP Sto. --> Loss
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
			(Storage_in[c, "PT_STORAGE", "PT_HEAT", h, td] + Storage_in[c, "ST_STORAGE", "ST_HEAT", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "CSP Sto." , "Loss",
				sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
				(((Storage_in[c, "PT_STORAGE", "PT_HEAT", h, td]) - (Storage_out[c, "PT_STORAGE", "PT_HEAT", h, td] / storage_eff_out ["PT_STORAGE", "PT_HEAT"]))
				+ ((Storage_in[c, "ST_STORAGE", "ST_HEAT", h, td]) - (Storage_out[c, "ST_STORAGE", "ST_HEAT", h, td] / storage_eff_out ["ST_STORAGE", "ST_HEAT"])))/ 1000
				, "Solar", "#FFFF00", "TWh" > ( PathName & "/input2sankey.csv");

				# CSP (power block) --> Electricity
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
			(F_t [c, "PT_POWER_BLOCK", h, td] + F_t [c, "ST_POWER_BLOCK", h, td] + F_t [c, "STIRLING_DISH", h, td] ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "CSP" , "Elec",
				sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
				( layers_in_out["PT_POWER_BLOCK","ELECTRICITY"] * F_t [c, "PT_POWER_BLOCK", h, td] 
				+ layers_in_out["ST_POWER_BLOCK","ELECTRICITY"] * F_t [c, "ST_POWER_BLOCK", h, td] 
				+ layers_in_out["STIRLING_DISH","ELECTRICITY"] * F_t [c, "STIRLING_DISH", h, td])/ 1000
				, "Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey.csv");
				
			
				# Solar --> Heat LT Dec 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"DEC_SOLAR", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Solar" , "Heat LT Dec", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
					(layers_in_out["DEC_SOLAR","HEAT_LOW_T_DECEN"] * (F_t [c,"DEC_SOLAR", h, td])# SUPPRESSED # - Solar_excess [ h, td] ) 
					-((max(Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_DIRECT_ELEC"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_HP_ELEC"      ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_THHP_GAS"     ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_BOILER_GAS"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_BOILER_WOOD"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_BOILER_OIL"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_COGEN_GAS"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_ADVCOGEN_GAS" ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_COGEN_OIL"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_ADVCOGEN_H2"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] )))
					)/ 1000
					, "Solar", "#FFFF00", "TWh" > ( PathName & "/input2sankey.csv");
				
				# Solar --> Dec Sto.
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"DEC_SOLAR", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Solar" , "Dec. Sto", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
					((max(Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_DIRECT_ELEC"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_HP_ELEC"      ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_THHP_GAS"     ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_BOILER_GAS"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_BOILER_WOOD"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_BOILER_OIL"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_COGEN_GAS"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_ADVCOGEN_GAS" ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_COGEN_OIL"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_ADVCOGEN_H2"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] ))
					)/ 1000
					, "Solar", "#FFFF00", "TWh" > ( PathName & "/input2sankey.csv");
			
				#Solar --> DHN
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"DHN_SOLAR", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Solar" , "DHN", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["DHN_SOLAR","HEAT_LOW_T_DHN"] * F [c,"DHN_SOLAR"] * c_p_t["DHN_SOLAR",c,h,td]  ) / 1000 , "Solar", "#FFFF00", "TWh" > #From F_t -> F <=> taking into account curtailment
			(PathName & "/input2sankey.csv");
			
			
				# Geothermal --> Elec
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"GEOTHERMAL", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Geothermal" , "Elec", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["GEOTHERMAL","ELECTRICITY"] * F_t [c,"GEOTHERMAL", h, td]  ) / 1000 , "Geothermal", 
			"#FF0000", "TWh" > ( PathName & "/input2sankey.csv");
				
				# Geothermal --> DHN
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"DHN_DEEP_GEO", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Geothermal" , "DHN", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["DHN_DEEP_GEO","HEAT_LOW_T_DHN"] * F_t [c,"DHN_DEEP_GEO", h, td]  ) / 1000 , 
			"Geothermal", "#FF0000", "TWh" > ( PathName & "/input2sankey.csv");
			
				# Waste --> CHP
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"IND_COGEN_WASTE", h, td] + F_t 
			[c,"DHN_COGEN_WASTE", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Waste" , "CHP", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["IND_COGEN_WASTE","WASTE"] * F_t [c,"IND_COGEN_WASTE", h, td]   
			-layers_in_out["DHN_COGEN_WASTE","WASTE"] * F_t [c,"DHN_COGEN_WASTE", h, td]  ) / 1000 , "Waste", "#808000", "TWh" > 
			( PathName & "/input2sankey.csv");
				
				# Waste --> Boilers	
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"IND_BOILER_WASTE", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Waste" , "Boilers", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["IND_BOILER_WASTE","WASTE"] * F_t [c,"IND_BOILER_WASTE", h, td]  ) / 1000 , 
			"Waste", "#808000", "TWh" > ( PathName & "/input2sankey.csv");
			
				#Wet biomass --> CHP
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"DHN_COGEN_WET_BIOMASS", h, td]) + (F_t [c,"DHN_COGEN_BIO_HYDROLYSIS", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Wet Biomass" , "CHP", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["DHN_COGEN_WET_BIOMASS","WET_BIOMASS"] * F_t [c,"DHN_COGEN_WET_BIOMASS", h, td] -layers_in_out["DHN_COGEN_BIO_HYDROLYSIS","WET_BIOMASS"] * F_t [c,"DHN_COGEN_BIO_HYDROLYSIS", h, td]  ) / 1000 , "Wet Biomass", "#336600", "TWh" > 
			( PathName & "/input2sankey.csv");
			
				#Wet biomass --> GAS_RE
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"BIOMETHANATION", h, td] + F_t [c,"BIO_HYDROLYSIS", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Wet Biomass" , "Gas", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["BIOMETHANATION","WET_BIOMASS"] * F_t [c,"BIOMETHANATION", h, td] -layers_in_out["BIO_HYDROLYSIS","WET_BIOMASS"] * F_t [c,"BIO_HYDROLYSIS", h, td]   ) / 1000 , "Wet Biomass", "#336600", "TWh" > 
			( PathName & "/input2sankey.csv");
			
			
				# Oil --> CHP
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"DEC_COGEN_OIL", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Oil" , "CHP", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["DEC_COGEN_OIL","LFO"] * F_t [c,"DEC_COGEN_OIL", h, td]  ) / 1000 , "Oil", 
			"#8B008B", "TWh" > ( PathName & "/input2sankey.csv");
				
				# Oil --> Boilers 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"IND_BOILER_OIL", h, td] + F_t [c,"DHN_BOILER_OIL", 
			h, td] + F_t [c,"DEC_BOILER_OIL", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Oil" , "Boilers", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["IND_BOILER_OIL","LFO"] * F_t [c,"IND_BOILER_OIL", h, td]   - 
			layers_in_out["DHN_BOILER_OIL","LFO"] * F_t [c,"DHN_BOILER_OIL", h, td]   - layers_in_out["DEC_BOILER_OIL","LFO"] * 
			F_t [c,"DEC_BOILER_OIL", h, td]  ) / 1000 , "Oil", "#8B008B", "TWh" > ( PathName & "/input2sankey.csv");
			
				# Wood --> H2
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"H2_BIOMASS", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Wood" , "H2", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["H2_BIOMASS","WOOD"] * F_t [c,"H2_BIOMASS", h, td]  ) / 1000 , "Wood", "#CD853F", 
			"TWh" > ( PathName & "/input2sankey.csv");
			
				# Wood --> GAS_RE
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"GASIFICATION_SNG", h, td] )  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Wood" , "Gas", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["GASIFICATION_SNG","WOOD"] * F_t [c,"GASIFICATION_SNG", h, td]) / 1000 , "Wood", "#CD853F", "TWh" > 
			( PathName & "/input2sankey.csv");
			
				# Wood --> LFO
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"PYROLYSIS_TO_LFO", h, 
			td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Wood" , "Oil", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}( -layers_in_out["PYROLYSIS_TO_LFO","WOOD"] * F_t [c,"PYROLYSIS_TO_LFO", h, td]  ) / 1000 , "Wood", "#CD853F", "TWh" > 
			( PathName & "/input2sankey.csv");	
			
				# Wood --> DIESEL (only the share of wood that produces diesel)
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"PYROLYSIS_TO_FUELS", h, 
			td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Wood" , "DIESEL", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}( -layers_in_out["PYROLYSIS_TO_FUELS","WOOD"] *
			(layers_in_out["PYROLYSIS_TO_FUELS","DIESEL"]/(layers_in_out["PYROLYSIS_TO_FUELS","DIESEL"] + layers_in_out["PYROLYSIS_TO_FUELS","GASOLINE"]))
			* F_t [c,"PYROLYSIS_TO_FUELS", h, td]  ) / 1000 , "Wood", "#CD853F", "TWh" > 
			( PathName & "/input2sankey.csv");
			
				# Wood --> GASOLINE (only gasoline share of wood)
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"PYROLYSIS_TO_FUELS", h, 
			td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Wood" , "GASOLINE", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}( -layers_in_out["PYROLYSIS_TO_FUELS","WOOD"] *
			(layers_in_out["PYROLYSIS_TO_FUELS","GASOLINE"]/(layers_in_out["PYROLYSIS_TO_FUELS","DIESEL"] + layers_in_out["PYROLYSIS_TO_FUELS","GASOLINE"]))
			* F_t [c,"PYROLYSIS_TO_FUELS", h, td]  ) / 1000 , "Wood", "#CD853F", "TWh" > 
			( PathName & "/input2sankey.csv");		
			
				# Wood --> METHANOL
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"BIOMASS_TO_METHANOL", h, 
			td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Wood" , "Methanol", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}( -layers_in_out["BIOMASS_TO_METHANOL","WOOD"] * F_t [c,"BIOMASS_TO_METHANOL", h, td]  ) / 1000 , "Wood", "#CD853F", "TWh" > 
			( PathName & "/input2sankey.csv");				
			
			
				# Wood --> CHP
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"IND_COGEN_WOOD", h, td] + F_t [c,"DHN_COGEN_WOOD", 
			h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Wood" , "CHP", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["IND_COGEN_WOOD","WOOD"] * F_t [c,"IND_COGEN_WOOD", h, td]   - 
			layers_in_out["DHN_COGEN_WOOD","WOOD"] * F_t [c,"DHN_COGEN_WOOD", h, td]  ) / 1000 , "Wood", "#CD853F", "TWh" > 
			( PathName & "/input2sankey.csv");
				
				# Wood --> Boilers 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"IND_BOILER_WOOD", h, td] + F_t 
			[c,"DHN_BOILER_WOOD", h, td] + F_t [c,"DEC_BOILER_WOOD", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Wood" , "Boilers", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["IND_BOILER_WOOD","WOOD"] * F_t [c,"IND_BOILER_WOOD", h, td]   - 
			layers_in_out["DHN_BOILER_WOOD","WOOD"] * F_t [c,"DHN_BOILER_WOOD", h, td]   - layers_in_out["DEC_BOILER_WOOD","WOOD"] * 
			F_t [c,"DEC_BOILER_WOOD", h, td]  ) / 1000 , "Wood", "#CD853F", "TWh" > ( PathName & "/input2sankey.csv");
			
			
			#------------------------------------------
			# SANKEY - Electricity use
			#------------------------------------------
				#Elec --> EVs batt
			if sum{c in REGIONS, i in EVs_BATT, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Storage_in[c, i, "ELECTRICITY", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "EVs batt",
				sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
				(sum {i in EVs_BATT} (Storage_in[c, i, "ELECTRICITY", h, td])) / 1000
				, "Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey.csv");
			
				#EVs batt --> Mob Priv 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"CAR_PHEV", h, td] + F_t [c,"CAR_BEV", h, td]) ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "EVs batt" , "Mob priv", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["CAR_PHEV","ELECTRICITY"] * F_t [c,"CAR_PHEV", h, td]   - 
			layers_in_out["CAR_BEV","ELECTRICITY"] * F_t [c,"CAR_BEV", h, td]  ) / 1000 , "Electricity", "#00BFFF", "TWh" > 
			( PathName & "/input2sankey.csv");
			
				#EVs batt --> Elec Demand
			if sum{c in REGIONS, i in EVs_BATT, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Storage_in[c, i, "ELECTRICITY", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "EVs batt" , "Elec demand",
				sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
				(sum {i in EVs_BATT} (Storage_out[c, i, "ELECTRICITY", h, td] / storage_eff_out [i, "ELECTRICITY"])
				-(-layers_in_out["CAR_PHEV","ELECTRICITY"] * F_t [c,"CAR_PHEV", h, td] -layers_in_out["CAR_BEV","ELECTRICITY"] * F_t [c,"CAR_BEV", h, td])) / 1000
				, "Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey.csv");
				
				#EVS batt --> Loss
			if sum{c in REGIONS, i in EVs_BATT, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Storage_in[c, i, "ELECTRICITY", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "EVs batt" , "Loss", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
				(sum {i in EVs_BATT}((Storage_in[c, i, "ELECTRICITY", h, td])- (Storage_out[c, i, "ELECTRICITY", h, td] / storage_eff_out [i,"ELECTRICITY"])))/ 1000
				, "Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey.csv");
				
				#Elec --> Mob Pub 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"TRAIN_PUB", h, td] + F_t [c,"TRAMWAY_TROLLEY", h, 
			td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Mob public", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["TRAIN_PUB","ELECTRICITY"] * F_t [c,"TRAIN_PUB", h, td]   - 
			layers_in_out["TRAMWAY_TROLLEY","ELECTRICITY"] * F_t [c,"TRAMWAY_TROLLEY", h, td]  ) / 1000 , "Electricity", "#00BFFF", 
			"TWh" > ( PathName & "/input2sankey.csv");
				
				#Elec --> Freight 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"TRAIN_FREIGHT", h, td] + F_t [c,"TRUCK_ELEC", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Freight", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["TRAIN_FREIGHT","ELECTRICITY"] * F_t [c,"TRAIN_FREIGHT", h, td] -layers_in_out["TRUCK_ELEC","ELECTRICITY"] * F_t [c,"TRUCK_ELEC", h, td]  ) / 1000 , 
			"Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey.csv");
				
				#Elec --> Loss
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Network_losses [c,"ELECTRICITY", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Loss", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Network_losses 
			[c,"ELECTRICITY", h, td]    ) / 1000 
			, "Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey.csv");
				
				#Elec --> Elec Demand 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(End_uses [c,"ELECTRICITY", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Elec demand", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((End_uses 
			[c,"ELECTRICITY", h, td]  - Network_losses [c,"ELECTRICITY", h, td] - sum {i in STORAGE_OF_END_USES_TYPE["ELECTRICITY"]} (Storage_out[c, i, "ELECTRICITY", h, td] / storage_eff_out [i, "ELECTRICITY"])
			- sum {i in EVs_BATT} (Storage_out[c, i, "ELECTRICITY", h, td] / storage_eff_out [i, "ELECTRICITY"]))   
			)/ 1000 , "Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey.csv");
				
# Neglected because very small
#				#Elec --> METHANOL	
#			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"SYN_METHANOLATION", h, td]  ) > 10 then
#				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Methanol", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
#			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["SYN_METHANOLATION","ELECTRICITY"] * F_t [c,"SYN_METHANOLATION", h, td]   ) / 1000 , 
#			"Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey.csv");
			
			
			#New boxes for Space Cooling and Process Cooling	
			
				#Elec --> Cold 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"BIG_SPLIT", h, td]   ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Cold", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["BIG_SPLIT","ELECTRICITY"] * F_t [c,"BIG_SPLIT", h, td] ) / 1000 , 
			"Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey.csv");
			
				#Elec --> Chiller
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"CHILLER_WC",h,td]  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Chiller", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["CHILLER_WC","ELECTRICITY"] * F_t [c,"CHILLER_WC", h, td] ) / 1000 , 
			"Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey.csv");		
				
				
				# Elec --> Storage 
			if sum{c in REGIONS, i in STORAGE_OF_END_USES_TYPE["ELECTRICITY"], t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Storage_in[c, i, "ELECTRICITY", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Storage", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}       (sum {i 
			in STORAGE_OF_END_USES_TYPE["ELECTRICITY"] }(Storage_in[c, i, "ELECTRICITY", h, td]             
			)                                                                                         )/ 1000 , "Electricity", "#00BFFF", 
			"TWh" > ( PathName & "/input2sankey.csv");
				
				# Storage --> Elec Demand 
			if sum{c in REGIONS, i in STORAGE_OF_END_USES_TYPE["ELECTRICITY"], t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Storage_in[c, i, "ELECTRICITY", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Storage" , "Elec demand", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(sum {i 
			in STORAGE_OF_END_USES_TYPE["ELECTRICITY"] } (Storage_out[c, i, "ELECTRICITY", h, td] / storage_eff_out [i, "ELECTRICITY"])  )/ 1000 , "Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey.csv");
				
				#Storage --> Loss
			if sum{c in REGIONS, i in STORAGE_OF_END_USES_TYPE["ELECTRICITY"], t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Storage_in[c, i, "ELECTRICITY", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Storage" , "Loss", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (sum {i 
			in STORAGE_OF_END_USES_TYPE["ELECTRICITY"] }((Storage_in[c, i, "ELECTRICITY", h, td])- (Storage_out[c, i, "ELECTRICITY", h, td] / storage_eff_out [i, 
			"ELECTRICITY"]))  )/ 1000 , "Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey.csv");

				#Elec --> HP 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"DHN_HP_ELEC", h, td] + F_t [c,"DEC_HP_ELEC", h, 
			td]) ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "HPs", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["DHN_HP_ELEC","ELECTRICITY"] * F_t [c,"DHN_HP_ELEC", h, td]   - 
			layers_in_out["DEC_HP_ELEC","ELECTRICITY"] * F_t [c,"DEC_HP_ELEC", h, td]  ) / 1000 , "Electricity", "#00BFFF", "TWh" > 
			( PathName & "/input2sankey.csv");
				
				#Elec --> H2 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"H2_ELECTROLYSIS", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "H2", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["H2_ELECTROLYSIS","ELECTRICITY"] * F_t [c,"H2_ELECTROLYSIS", h, td]  ) / 1000 , 
			"Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey.csv");
				
				#Elec --> Heat LT Dec 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"DEC_DIRECT_ELEC", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Heat LT Dec", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["DEC_DIRECT_ELEC","HEAT_LOW_T_DECEN"] * F_t [c,"DEC_DIRECT_ELEC", h, td]  
					- ((max(Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_DIRECT_ELEC"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] )))) / 1000 
			, "Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey.csv");
				
				#Elec --> Dec Sto. 
			if sum {c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]: Storage_in[c,"TS_DEC_DIRECT_ELEC", "HEAT_LOW_T_DECEN", h, td] > Storage_out[c,"TS_DEC_DIRECT_ELEC", "HEAT_LOW_T_DECEN", h, td] } 
			    	((Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td])*(1-F_t_solar[c,"DEC_DIRECT_ELEC"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] ))) >10 then
						printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Dec. Sto", 		 
							sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} 
							((max(Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_DIRECT_ELEC"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] ))) / 1000 
						, "Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey.csv");		
				
				#Elec --> HT Heat 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"IND_DIRECT_ELEC", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Heat HT", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["IND_DIRECT_ELEC","HEAT_HIGH_T"] * F_t [c,"IND_DIRECT_ELEC", h, td]  ) / 1000 , 
			"Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey.csv");
			
				# Elec --> CCS
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"ATM_CCS", h, td] + F_t [c,"INDUSTRY_CCS", h, td]) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "CCS",
			sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in	TYPICAL_DAY_OF_PERIOD[t]}
			(-layers_in_out["ATM_CCS","ELECTRICITY"] * F_t [c,"ATM_CCS", h, td] - layers_in_out["ATM_CCS","ELECTRICITY"] * F_t [c,"ATM_CCS", h, td]) / 1000 , 
			"Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey.csv");
			
			
			## H2 imports
				#H2 imports  --> H2
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"H2", h, td] + R_t_local [c,"H2", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "H2 imports" , "H2", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["H2","H2"] * R_t_exterior [c,"H2", h, td] + layers_in_out["H2","H2"] * R_t_local [c,"H2", h, td] ) / 1000 , "H2", 
			"#FF00FF", "TWh" > ( PathName & "/input2sankey.csv");
			
				#H2 RE  --> H2
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"H2_RE", h, td] + R_t_local [c,"H2_RE", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "H2 RE" , "H2", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["H2_RE","H2"] * R_t_exterior [c,"H2_RE", h, td] + layers_in_out["H2_RE","H2"] * R_t_local [c,"H2_RE", h, td] ) / 1000 , "H2", 
			"#FF00FF", "TWh" > ( PathName & "/input2sankey.csv");
			
			
			## H2 use
			
				#H2 --> Freight
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"TRUCK_FUEL_CELL", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "H2" , "Freight", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["TRUCK_FUEL_CELL","H2"] * F_t [c,"TRUCK_FUEL_CELL", h, td]  ) / 1000 , "H2", 
			"#FF00FF", "TWh" > ( PathName & "/input2sankey.csv");
				
				#H2 --> CHP 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"DEC_ADVCOGEN_H2", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "H2" , "CHP", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["DEC_ADVCOGEN_H2","H2"] * F_t [c,"DEC_ADVCOGEN_H2", h, td]  ) / 1000 , "H2", 
			"#FF00FF", "TWh" > ( PathName & "/input2sankey.csv");
				
				#H2 --> Mob Priv
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"CAR_FUEL_CELL", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "H2" , "Mob priv", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["CAR_FUEL_CELL","H2"] * F_t [c,"CAR_FUEL_CELL", h, td]  ) / 1000 , "H2", 
			"#FF00FF", "TWh" > ( PathName & "/input2sankey.csv");
				
				#H2 --> Mob Pub 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"BUS_COACH_FC_HYBRIDH2", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "H2" , "Mob public", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["BUS_COACH_FC_HYBRIDH2","H2"] * F_t [c,"BUS_COACH_FC_HYBRIDH2", h, td]  ) / 1000 , 
			"H2", "#FF00FF", "TWh" > ( PathName & "/input2sankey.csv");
			
				#H2 --> GAS_RE
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"SYN_METHANATION", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "H2" , "Gas", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["SYN_METHANATION","H2"] * F_t [c,"SYN_METHANATION", h, td]   ) / 1000 , "H2", "#FF00FF", "TWh" > 
			( PathName & "/input2sankey.csv");
			
				#H2 --> METHANOL
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"SYN_METHANOLATION", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "H2" , "Methanol", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["SYN_METHANOLATION","H2"] * F_t [c,"SYN_METHANOLATION", h, td]  ) / 1000 , "H2", "#FF00FF", "TWh" > 
			( PathName & "/input2sankey.csv");			
			
			
			#------------------------------------------
			# SANKEY - HEATING
			#------------------------------------------
			
			## CHP
			#CHP --> Elec 
			if sum{c in REGIONS, i in COGEN, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [ c, i, h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "CHP" , "Elec", sum{c in REGIONS, i in COGEN, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out[i,"ELECTRICITY"] * F_t [c, i, h, td]  ) / 1000 , "Electricity", "#00BFFF", "TWh" > 
			( PathName & "/input2sankey.csv");
			#CHP --> Heat LT Dec 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"DEC_COGEN_GAS", h, td] + F_t [c,"DEC_COGEN_OIL", h, 
			td] + F_t [c,"DEC_ADVCOGEN_GAS", h, td] + F_t [c,"DEC_ADVCOGEN_H2", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "CHP" , "Heat LT Dec", 
					sum{c in REGIONS, i in COGEN, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
						(layers_in_out[i,"HEAT_LOW_T_DECEN"] * F_t [c, i, h, td]  
						 -((max(Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_COGEN_GAS"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] ))+
							(max(Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_ADVCOGEN_GAS" ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] ))+
							(max(Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_COGEN_OIL"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] ))+
							(max(Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_ADVCOGEN_H2"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] )))
						) / 1000 
						, "Heat LT", "#FA8072", "TWh" > ( PathName & "/input2sankey.csv");
			#CHP --> Dec. Sto 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} 
								    ((max(Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_COGEN_GAS"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] ))+
								     (max(Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_ADVCOGEN_GAS" ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] ))+
								     (max(Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_COGEN_OIL"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] ))+
								     (max(Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_ADVCOGEN_H2"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] )))> 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "CHP" , "Dec. Sto", 
					sum{c in REGIONS, i in COGEN, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
						((max(Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_COGEN_GAS"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] ))+
							(max(Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_ADVCOGEN_GAS" ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] ))+
							(max(Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_COGEN_OIL"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] ))+
							(max(Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_ADVCOGEN_H2"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] ))
						) / 1000 
						, "Heat LT", "#FA8072", "TWh" > ( PathName & "/input2sankey.csv");
			#CHP --> DHN 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"DHN_COGEN_GAS", h, td] + F_t [c,"DHN_COGEN_WOOD", 
			h, td] + F_t [c,"DHN_COGEN_WASTE", h, td] + F_t [c,"DHN_COGEN_WET_BIOMASS", h, td] + F_t [c,"DHN_COGEN_BIO_HYDROLYSIS", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "CHP" , "DHN", sum{c in REGIONS, i in COGEN, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out[i,"HEAT_LOW_T_DHN"] * F_t [c, i, h, td]  ) / 1000 , "Heat LT", "#FA8072", "TWh" > 
			( PathName & "/input2sankey.csv");
			
			#CHP --> Heat HT 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"IND_COGEN_GAS", h, td] + F_t [c,"IND_COGEN_WOOD", 
			h, td] + F_t [c,"IND_COGEN_WASTE", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "CHP" , "Heat HT", sum{c in REGIONS, i in COGEN, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out[i,"HEAT_HIGH_T"] * F_t [c, i, h, td]  ) / 1000 , "Heat HT", "#DC143C", "TWh" > 
			( PathName & "/input2sankey.csv");
			
			# HP --> Heat LT Dec. 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"DEC_HP_ELEC", h, td] + F_t [c,"DEC_THHP_GAS", h, 
			td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "HPs" , "Heat LT Dec", 
					sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
					((layers_in_out["DEC_HP_ELEC","HEAT_LOW_T_DECEN"] * F_t [c,"DEC_HP_ELEC", h, td]   +
					layers_in_out["DEC_THHP_GAS","HEAT_LOW_T_DECEN"] * F_t [c,"DEC_THHP_GAS", h, td]  
					-((max(Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_HP_ELEC"      ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] ))+
			     	  (max(Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_THHP_GAS"     ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] )))
					) / 1000 ) 
					, "Heat LT", "#FA8072", "TWh" > ( PathName & "/input2sankey.csv");
			#HP --> DHN 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"DHN_HP_ELEC", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "HPs" , "DHN", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}((layers_in_out["DHN_HP_ELEC","HEAT_LOW_T_DHN"] * F_t [c,"DHN_HP_ELEC", h, td]  ) / 1000  - ( 
			(Storage_in [c,"TS_DEC_HP_ELEC", "ELECTRICITY", h, td]) )/ 1000), "Heat LT", "#FA8072", "TWh" > ( PathName & "/input2sankey.csv");
			# HP --> Dec Sto.
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} 
			    		((max(Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_HP_ELEC"      ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] ))+
			     	    (max(Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_THHP_GAS"     ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] ))) >10 then
						printf "%s,%s,%.2f,%s,%s,%s\n", "HPs" , "Dec. Sto", 		 
							sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} 
							((max(Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_HP_ELEC"      ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] ))+
							 (max(Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_THHP_GAS"     ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] )))/1000
							,"Heat LT", "#FA8072", "TWh" > ( PathName & "/input2sankey.csv");	
			
			
			
			
			## Biofuels

# Neglected because very small amount			
#			#WOOD --> Elec 
#			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"PYROLYSIS_TO_FUELS", h, td] + F_t [c,"PYROLYSIS_TO_LFO", h, td]  ) > 10 then
#				printf "%s,%s,%.2f,%s,%s,%s\n", "WOOD" , "Elec", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
#			TYPICAL_DAY_OF_PERIOD[t]}( layers_in_out["PYROLYSIS_TO_FUELS","ELECTRICITY"] * F_t [c,"PYROLYSIS_TO_FUELS", h, td]
#			+ layers_in_out["PYROLYSIS_TO_LFO","ELECTRICITY"] * F_t [c,"PYROLYSIS_TO_LFO", h, td]  ) / 1000 , "Electricity", "#00BFFF", "TWh" > 
#			( PathName & "/input2sankey.csv");
#			
#			# /!\ NOT UP TO DATE /!\		WET_BIO --> Elec 
#			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"GASIFICATION_SNG", h, td] + F_t [c,"BIO_HYDROLYSIS", h, td] )  ) > 10 then
#				printf "%s,%s,%.2f,%s,%s,%s\n", "Gas" , "Elec", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
#			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["GASIFICATION_SNG","ELECTRICITY"] * F_t [c,"GASIFICATION_SNG", h, td] + layers_in_out["BIO_HYDROLYSIS","ELECTRICITY"] * F_t [c,"BIO_HYDROLYSIS", h, td]    ) / 1000 , "Electricity", "#00BFFF", "TWh" > 
#			( PathName & "/input2sankey.csv");			
			
			
			
			#GAS_RE --> DHN 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"GASIFICATION_SNG", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Gas" , "DHN", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["GASIFICATION_SNG","HEAT_LOW_T_DHN"] * F_t [c,"GASIFICATION_SNG", h, td]  ) / 1000, 
			"Heat LT", "#FA8072", "TWh" > ( PathName & "/input2sankey.csv");
			
			# Boilers--> Heat LT Dec 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"DEC_BOILER_GAS", h, td] + F_t [c,"DEC_BOILER_WOOD", 
			h, td] + F_t [c,"DEC_BOILER_OIL", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Boilers" , "Heat LT Dec", 
							sum{c in REGIONS, i in BOILERS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
							   (layers_in_out[i,"HEAT_LOW_T_DECEN"] * F_t [c, i, h, td]  
							    -((max(Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_BOILER_GAS"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] ))+
								  (max(Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_BOILER_WOOD"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] ))+
								  (max(Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_BOILER_OIL"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] )))
									 ) / 1000 ,
						"Heat LT", "#FA8072", "TWh" > ( PathName & "/input2sankey.csv");
						
				#Boilers --> Dec. Sto. 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} 
								    ((max(Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_BOILER_GAS"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] ))+
								     (max(Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_BOILER_WOOD"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] ))+
								     (max(Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_BOILER_OIL"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] ))) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Boilers" , "Dec. Sto", 
								sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} 
								    ((max(Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_BOILER_GAS"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] ))+
								     (max(Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_BOILER_WOOD"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] ))+
								     (max(Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_BOILER_OIL"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] ))
								 ) / 1000 ,
						"Heat LT", "#FA8072", "TWh" > ( PathName & "/input2sankey.csv");
			
				
				#Boilers --> DHN 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"DHN_BOILER_GAS", h, td] + F_t [c,"DHN_BOILER_WOOD", 
			h, td] + F_t [c,"DHN_BOILER_OIL", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Boilers" , "DHN", sum{c in REGIONS, i in BOILERS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out[i,"HEAT_LOW_T_DHN"] * F_t [c, i, h, td]  ) / 1000 , "Heat LT", "#FA8072", "TWh" > 
			( PathName & "/input2sankey.csv");
				
				#Boilers --> Heat HT
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"IND_BOILER_GAS", h, td] + F_t [c,"IND_BOILER_WOOD", 
			h, td] + F_t [c,"IND_BOILER_OIL", h, td] + F_t [c,"IND_BOILER_COAL", h, td] + F_t [c,"IND_BOILER_WASTE", h, td])  ) > 10 
			then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Boilers" , "Heat HT", sum{c in REGIONS, i in BOILERS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out[i,"HEAT_HIGH_T"] * F_t [c, i, h, td]  ) / 1000 , "Heat HT", "#DC143C", "TWh" > 
			( PathName & "/input2sankey.csv");
			
				#Dec Sto. --> Heat LT Dec 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t], i in STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DECEN"]: Storage_in[c, i, "HEAT_LOW_T_DECEN", h, td] < Storage_out[c, i, "HEAT_LOW_T_DECEN", h, td] } 
									(Storage_out[c, i , "HEAT_LOW_T_DECEN", h, td] - Storage_in[c, i , "HEAT_LOW_T_DECEN", h, td]) > 10 then
			   printf "%s,%s,%.2f,%s,%s,%s\n", "Dec. Sto" , "Heat LT Dec",
			   sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t], i in STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DECEN"]: Storage_in[c, i, "HEAT_LOW_T_DECEN", h, td] < Storage_out[c, i, "HEAT_LOW_T_DECEN", h, td] } 
									(Storage_out[c, i , "HEAT_LOW_T_DECEN", h, td] - Storage_in[c, i , "HEAT_LOW_T_DECEN", h, td])/1000 , "Heat LT", "#FA8072", "TWh" > ( PathName & "/input2sankey.csv");
			
				# DHN --> Heat LT DHN 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(End_uses[c,"HEAT_LOW_T_DHN", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "DHN" , "Heat LT DHN", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} 
				(sum {i in TECHNOLOGIES diff STORAGE_TECH } (layers_in_out[i, "HEAT_LOW_T_DHN"] * F_t [c, i, h, td]  ) 
				- Network_losses [c,"HEAT_LOW_T_DHN", h, td]   
				- sum {i in STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"]} (Storage_in  [c, i, "HEAT_LOW_T_DHN", h, td])) / 1000
				, "Heat LT", "#FA8072", "TWh" > ( PathName & "/input2sankey.csv");
				
			#DHN --> DHN Loss 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Network_losses [c,"HEAT_LOW_T_DHN", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "DHN" , "Loss DHN", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Network_losses 
			[c, "HEAT_LOW_T_DHN", h, td]  ) / 1000 , "Heat LT", "#FA8072", "TWh" > ( PathName & "/input2sankey.csv");
			
			
			# DHN --> DHN storage :
			# Sto in  : sum {i in STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"],t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (Storage_in  [i, "HEAT_LOW_T_DHN", h, td])
			# Sto out : sum {i in STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"],t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (Storage_out[c, i, "HEAT_LOW_T_DHN", h, td])
			
			if sum {c in REGIONS, i in STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"],t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Storage_in  [c, i, "HEAT_LOW_T_DHN", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "DHN" , "DHN Sto", sum {c in REGIONS, i in STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"],t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (Storage_in  [c, i, "HEAT_LOW_T_DHN", h, td])/1000
				, "Heat LT", "#FA8072", "TWh" > ( PathName & "/input2sankey.csv");
			#DHN Sto. --> Heat LT DHN 
			if sum {c in REGIONS, i in STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"],t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Storage_out  [c, i, "HEAT_LOW_T_DHN", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "DHN Sto" , "Heat LT DHN", sum {c in REGIONS, i in STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"],t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (Storage_out  [c, i, "HEAT_LOW_T_DHN", h, td])/1000
				, "Heat LT", "#FA8072", "TWh" > ( PathName & "/input2sankey.csv");
					
			
				# Heat HT --> HT Storage 
			if sum{c in REGIONS, i in STORAGE_OF_END_USES_TYPE["HEAT_HIGH_T"], t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Storage_in[c, i, "HEAT_HIGH_T", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Heat HT" , "HT Storage", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}       (sum {i 
			in STORAGE_OF_END_USES_TYPE["HEAT_HIGH_T"] }(Storage_in[c, i, "HEAT_HIGH_T", h, td] ))/ 1000 , "Heat HT", "#DC143C", 
			"TWh" > ( PathName & "/input2sankey.csv");
			
			#HT Storage --> Ind Heat Demand  
			if sum{c in REGIONS, i in STORAGE_OF_END_USES_TYPE["HEAT_HIGH_T"], t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Storage_in[c, i, "HEAT_HIGH_T", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "HT Storage" , "Ind Heat Demand", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(sum {i 
			in STORAGE_OF_END_USES_TYPE["HEAT_HIGH_T"] }  (Storage_out[c, i, "HEAT_HIGH_T", h, td]  )  )/ 1000 , "Heat HT", "#DC143C", "TWh" > ( PathName & "/input2sankey.csv");
			
			#HT Storage --> Loss
			#if sum{c in REGIONS, i in STORAGE_OF_END_USES_TYPE["HEAT_HIGH_T"], t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Storage_in[c, i, "HEAT_HIGH_T", h, td]) > 10 then
			#	printf "%s,%s,%.2f,%s,%s,%s\n", "HT Storage" , "Loss", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (sum {i 
			#in STORAGE_OF_END_USES_TYPE["HEAT_HIGH_T"] }((Storage_in[c, i, "HEAT_HIGH_T", h, td])- (Storage_out[c, i, "HEAT_HIGH_T", h, td] / storage_eff_out [i, 
			#"HEAT_HIGH_T"]))  )/ 1000 , "Heat HT", "#DC143C", "TWh" > ( PathName & "/input2sankey.csv");

				#Heat HT --> Ind Heat Demand 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(End_uses [c,"HEAT_HIGH_T", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Heat HT" , "Ind Heat Demand", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((End_uses 
			[c,"HEAT_HIGH_T", h, td] - sum {i in STORAGE_OF_END_USES_TYPE["HEAT_HIGH_T"]} (Storage_out[c, i, "HEAT_HIGH_T", h, td]))   
			)/ 1000 , "Heat HT", "#DC143C", "TWh" > ( PathName & "/input2sankey.csv");
			
			
				# Cold --> Cold Storage 
			if sum{c in REGIONS, i in STORAGE_OF_END_USES_TYPE["SPACE_COOLING"], t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
			(Storage_in[c, i, "SPACE_COOLING", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Cold" , "Cold Storage",
				sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
				(sum {i in STORAGE_OF_END_USES_TYPE["SPACE_COOLING"] }(Storage_in[c, i, "SPACE_COOLING", h, td]))/ 1000
				, "Cold", "#00CED1", "TWh" > ( PathName & "/input2sankey.csv");
			
				# Cold Storage --> Space Cooling
			if sum{c in REGIONS, i in STORAGE_OF_END_USES_TYPE["SPACE_COOLING"], t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
			(Storage_out[c, i, "SPACE_COOLING", h, td]) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Cold Storage" , "Space Cooling",
			sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
			(sum {i in STORAGE_OF_END_USES_TYPE["SPACE_COOLING"]} (Storage_out[c, i, "SPACE_COOLING", h, td]))/ 1000
			, "Cold", "#00CED1", "TWh" > ( PathName & "/input2sankey.csv");
			
				# Cold Storage --> Loss
			#if sum{c in REGIONS, i in STORAGE_OF_END_USES_TYPE["SPACE_COOLING"], t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Storage_in[c, i, "SPACE_COOLING", h, td]) > 10 then
			#	printf "%s,%s,%.2f,%s,%s,%s\n", "Cold Storage" , "Cold Loss", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (sum {i 
			#in STORAGE_OF_END_USES_TYPE["SPACE_COOLING"] }((Storage_in[c, i, "SPACE_COOLING", h, td])- (Storage_out[c, i, "SPACE_COOLING", h, td] / storage_eff_out [i, 
			#"SPACE_COOLING"]))  )/ 1000 , "Cold", "#00CED1", "TWh" > ( PathName & "/input2sankey.csv");

				#Cold  --> Space Cooling 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(End_uses [c,"SPACE_COOLING", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Cold" , "Space Cooling",
				sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
				((End_uses [c,"SPACE_COOLING", h, td] - sum {i in STORAGE_OF_END_USES_TYPE["SPACE_COOLING"]} (Storage_out[c, i, "SPACE_COOLING", h, td]) ))  / 1000
				, "Cold", "#00CED1", "TWh" > ( PathName & "/input2sankey.csv");
		
				#Chiller  --> Process Cooling 
			if sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(End_uses [c,"PROCESS_COOLING", h, td]  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Chiller" , "Process Cooling", sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(( End_uses 
			[c,"PROCESS_COOLING", h, td]))  / 1000 , "Cold", "#00CED1", "TWh" > ( PathName & "/input2sankey.csv");
		
				#Elec --> Curt
			if sum{c in REGIONS} (Curt [c])  > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Curt", sum{c in REGIONS} (Curt [c]) / 1000 , "Electricity", "#00BFFF", "TWh" > 
			( PathName & "/input2sankey.csv");
			
			#Elec --> Interconnection
			
			#Interconnection --> 
			
			
			#STORAGE DECENTRALISED :
			# inputs : 
			#     -Direct elec : sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} 
			#						((max(Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_DIRECT_ELEC"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] )))
			#     -HPs         : sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}         
			#						((max(Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_HP_ELEC"      ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_THHP_GAS"     ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] )))
			#     -Boilers     : sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} 
			#					    ((max(Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_BOILER_GAS"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_BOILER_WOOD"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_BOILER_OIL"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] )))
			#	  -CHP_dec     : sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} 
			#					    ((max(Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_COGEN_GAS"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_ADVCOGEN_GAS" ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_COGEN_OIL"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_ADVCOGEN_H2"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] )))
			#     -DEC_SOLAR   : sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} 
			#						((max(Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_DIRECT_ELEC"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] ))+
			#						 (max(Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_HP_ELEC"      ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_THHP_GAS"     ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_BOILER_GAS"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_BOILER_WOOD"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_BOILER_OIL"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_COGEN_GAS"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_ADVCOGEN_GAS" ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_COGEN_OIL"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_ADVCOGEN_H2"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] )))
			# outputs :
			# 	  -Storage_out     : sum{c in REGIONS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t], i in TS_DEC} 
			#						(max{0,Storage_out[c, i , "HEAT_LOW_T_DECEN", h, td] - Storage_in[c, i , "HEAT_LOW_T_DECEN", h, td]})



			
			###############################################################################                                                    
			#																			  #
			#                            LOCAL SYSTEMS' SANKEYS             			  #                                                    
			#																			  #
			###############################################################################

			for {c in REGIONS}{
			print "--------- SAVING SANKEY --------";

			## Generate CSV file to be used as input to Sankey diagram
			# Notes:
			# - Assuming that GAS_RE and BioOil are used in boilers
			printf "%s,%s,%s,%s,%s,%s\n", "source" , "target", "realValue", "layerID", "layerColor", "layerUnit" > ( PathName & "/input2sankey" & c & ".csv");
			
			#------------------------------------------
			# SANKEY - RESOURCES
			#------------------------------------------
			## Gasoline
				#Gasoline imports --> Gasoline 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"GASOLINE", h, td] + R_t_local [c,"GASOLINE", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Gasoline imports" , "Gasoline", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]} (layers_in_out["GASOLINE","GASOLINE"] * R_t_exterior [c,"GASOLINE", h, td] + layers_in_out["GASOLINE","GASOLINE"] * R_t_local [c,"GASOLINE", h, td] ) / 1000 , 
			"Gasoline", "#808080", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
				# Gasoline --> Mob Priv
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
			((F_t [c,"CAR_GASOLINE", h, td] + F_t [c,"CAR_PHEV", h, td] + F_t [c,"CAR_HEV", h, td]) ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Gasoline" , "Mob priv",
			sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in	TYPICAL_DAY_OF_PERIOD[t]}
			(- layers_in_out["CAR_GASOLINE","GASOLINE"] * F_t [c,"CAR_GASOLINE", h, td]
			- layers_in_out["CAR_PHEV","GASOLINE"] * F_t [c,"CAR_PHEV", h, td]
			- layers_in_out["CAR_HEV","GASOLINE"] * F_t [c,"CAR_HEV", h, td]) / 1000
			, "Gasoline", "#808080", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
				
			
			
			## Diesel
			
				#Diesel-->Mob Priv
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"CAR_DIESEL", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Diesel" , "Mob priv", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["CAR_DIESEL","DIESEL"] * F_t [c,"CAR_DIESEL", h, td]  ) / 1000 , "Diesel", 
			"#D3D3D3", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
				#Diesel-->Mob Pub
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((F_t [c,"BUS_COACH_DIESEL", h, td] + 
			F_t[c,"BUS_COACH_HYDIESEL", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Diesel" , "Mob public", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["BUS_COACH_DIESEL","DIESEL"] * F_t [c,"BUS_COACH_DIESEL", h, td]   - 
			layers_in_out["BUS_COACH_HYDIESEL","DIESEL"] * F_t [c,"BUS_COACH_HYDIESEL", h, td]   ) / 1000 , "Diesel", "#D3D3D3", "TWh" 
			> ( PathName & "/input2sankey" & c & ".csv");
				#Diesel-->Freight
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((F_t [c,"TRUCK_DIESEL", h, td]+F_t [c,"BOAT_FREIGHT_DIESEL", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Diesel" , "Freight", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["TRUCK_DIESEL","DIESEL"] * F_t [c,"TRUCK_DIESEL", h, td] -layers_in_out["BOAT_FREIGHT_DIESEL","DIESEL"] * F_t [c,"BOAT_FREIGHT_DIESEL", h, td]  ) / 1000 , "Diesel", "#D3D3D3", "TWh" 
			> ( PathName & "/input2sankey" & c & ".csv");
			
				#Diesel imports --> Diesel 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"DIESEL", h, td] + R_t_local [c,"DIESEL", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Diesel imports" , "Diesel", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]} (layers_in_out["DIESEL","DIESEL"] * R_t_exterior [c,"DIESEL", h, td] + layers_in_out["DIESEL","DIESEL"] * R_t_local [c,"DIESEL", h, td] ) / 1000 , "Diesel", "#D3D3D3", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");
			

			
			## Bioethanol and Biodiesel
			#Bioethanol --> Gasoline 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"BIOETHANOL", h, td] + R_t_local [c,"BIOETHANOL", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Bioethanol" , "Gasoline", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]} (layers_in_out["BIOETHANOL","GASOLINE"] * R_t_exterior [c,"BIOETHANOL", h, td] + layers_in_out["BIOETHANOL","GASOLINE"] * R_t_local [c,"BIOETHANOL", h, td] ) / 1000 ,  "Gasoline", "#808080", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");
			
			#Biodiesel --> Diesel 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"BIODIESEL", h, td] + R_t_local [c,"BIODIESEL", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Biodiesel" , "Diesel", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]} (layers_in_out["BIODIESEL","DIESEL"] * R_t_exterior [c,"BIODIESEL", h, td] + layers_in_out["BIODIESEL","DIESEL"] * R_t_local [c,"BIODIESEL", h, td] ) / 1000 , "Diesel", "#D3D3D3", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");
			
			## LFO
				#LFO imports --> LFO 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"LFO", h, td] + R_t_local [c,"LFO", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Oil imports" , "Oil", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]} (layers_in_out["LFO","LFO"] * R_t_exterior [c,"LFO", h, td] + layers_in_out["LFO","LFO"] * R_t_local [c,"LFO", h, td] ) / 1000 , 
			"Oil", "#8B008B", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
			## Gas
			
			#Gas Fossil extracted  --> Gas
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"GAS", h, td] + R_t_local [c,"GAS", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Gas Fossil" , "Gas", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["GAS","GAS"] * R_t_exterior [c,"GAS", h, td] + layers_in_out["GAS","GAS"] * R_t_local [c,"GAS", h, td] ) / 1000 , "Gas", "#FFD700", "TWh" 
			> ( PathName & "/input2sankey" & c & ".csv");
			
			#GAS_RE  --> Gas
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"GAS_RE", h, td] + R_t_local [c,"GAS_RE", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Gas RE" , "Gas", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["GAS_RE","GAS"] * R_t_exterior [c,"GAS_RE", h, td] + layers_in_out["GAS_RE","GAS"] * R_t_local [c,"GAS_RE", h, td] ) / 1000 , "Gas", "#FFD700", "TWh" 
			> ( PathName & "/input2sankey" & c & ".csv");
			
			
			
			#Gas --> Freight
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((F_t [c,"TRUCK_NG", h, td] + F_t [c,"BOAT_FREIGHT_NG", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Gas" , "Freight", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["TRUCK_NG","GAS"] * F_t [c,"TRUCK_NG", h, td] -layers_in_out["BOAT_FREIGHT_NG","GAS"] * F_t [c,"BOAT_FREIGHT_NG", h, td] ) / 1000 , "Gas", "#FFD700", "TWh" 
			> ( PathName & "/input2sankey" & c & ".csv");
				
				#Gas --> Mob Priv
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"CAR_NG", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Gas" , "Mob priv", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["CAR_NG","GAS"] * F_t [c,"CAR_NG", h, td]  ) / 1000 , "Gas", "#FFD700", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");
				
				#Gas --> Mob Pub
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"BUS_COACH_CNG_STOICH", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Gas" , "Mob public", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["BUS_COACH_CNG_STOICH","GAS"] * F_t [c,"BUS_COACH_CNG_STOICH", h, td]  ) / 1000 , 
			"Gas", "#FFD700", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
				
				#Gas --> H2
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"SMR", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Gas" , "H2", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["SMR","GAS"] * F_t [c,"SMR", h, td]  ) / 1000 , "Gas", "#FFD700", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");
				
				#Gas --> METHANOL
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"METHANE_TO_METHANOL", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Gas" , "Methanol", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["METHANE_TO_METHANOL","GAS"] * F_t [c,"METHANE_TO_METHANOL", h, td]  ) / 1000 , "Gas", "#FFD700", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");
			
				#Gas --> CCGT
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"CCGT", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Gas" , "CCGT", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["CCGT","GAS"] * F_t [c,"CCGT", h, td]  ) / 1000 , "Gas", "#FFD700", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");
			
				#CCGT --> Elec
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"CCGT", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "CCGT" , "Elec", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["CCGT","ELECTRICITY"] * F_t [c,"CCGT", h, td]  ) / 1000 , "Electricity", "#00BFFF", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");
			
			
			#Gas --> CHP
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"IND_COGEN_GAS", h, td] + F_t [c,"DHN_COGEN_GAS", h, 
			td] + F_t [c,"DEC_COGEN_GAS", h, td] + F_t [c,"DEC_ADVCOGEN_GAS", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Gas" , "CHP", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["IND_COGEN_GAS","GAS"] * F_t [c,"IND_COGEN_GAS", h, td]   - 
			layers_in_out["DHN_COGEN_GAS","GAS"] * F_t [c,"DHN_COGEN_GAS", h, td]   - layers_in_out["DEC_COGEN_GAS","GAS"] * F_t 
			[c,"DEC_COGEN_GAS", h, td]   - layers_in_out["DEC_ADVCOGEN_GAS","GAS"] * F_t [c,"DEC_ADVCOGEN_GAS", h, td]  ) / 
			1000 , "Gas", "#FFD700", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
				#Gas --> HP
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"DEC_THHP_GAS", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Gas" , "HPs", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["DEC_THHP_GAS","GAS"] * F_t [c,"DEC_THHP_GAS", h, td]  ) / 1000 , "Gas", "#FFD700", 
			"TWh" > ( PathName & "/input2sankey" & c & ".csv");
				#Gas --> Boilers 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"IND_BOILER_GAS", h, td] + F_t [c,"DHN_BOILER_GAS", 
			h, td] + F_t [c,"DEC_BOILER_GAS", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Gas" , "Boilers", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["IND_BOILER_GAS","GAS"] * F_t [c,"IND_BOILER_GAS", h, td]   - 
			layers_in_out["DHN_BOILER_GAS","GAS"] * F_t [c,"DHN_BOILER_GAS", h, td]   - layers_in_out["DEC_BOILER_GAS","GAS"] * F_t 
			[c,"DEC_BOILER_GAS", h, td]  ) / 1000 , "Gas", "#FFD700", "TWh" > ( PathName & "/input2sankey" & c & ".csv");

			
			## Ammonia
				#AMMONIA imports  --> AMMONIA
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"AMMONIA", h, td] + R_t_local [c,"AMMONIA", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Ammonia imports" , "Ammonia", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["AMMONIA","AMMONIA"] * R_t_exterior [c,"AMMONIA", h, td] + layers_in_out["AMMONIA","AMMONIA"] * R_t_local [c,"AMMONIA", h, td] ) / 1000 ,
			"Ammonia", "#000ECD", "TWh" 
			> ( PathName & "/input2sankey" & c & ".csv");
			
				#AMMONIA RE  --> AMMONIA
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"AMMONIA_RE", h, td] + R_t_local [c,"AMMONIA_RE", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Ammonia RE" , "Ammonia", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["AMMONIA_RE","AMMONIA"] * R_t_exterior [c,"AMMONIA_RE", h, td] + layers_in_out["AMMONIA_RE","AMMONIA"] * R_t_local [c,"AMMONIA_RE", h, td] ) / 1000 ,
			"Ammonia", "#000ECD", "TWh" 
			> ( PathName & "/input2sankey" & c & ".csv");
			
				# HABER_BOSCH
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (F_t [c, "HABER_BOSCH", h, td]  ) > 10 then {
				printf "%s,%s,%.2f,%s,%s,%s\n", "H2" , "Haber-Bosch", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										(-layers_in_out["HABER_BOSCH","H2"] * F_t [c, "HABER_BOSCH", h, td]  ) / 1000 , "H2", 
				"#FF00FF", "TWh" >> (PathName & "/input2sankey" & c & ".csv");
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Haber-Bosch", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										(-layers_in_out["HABER_BOSCH","ELECTRICITY"] * F_t [c, "HABER_BOSCH", h, td]  ) / 1000 , "Electricity", 
				"#00BFFF", "TWh" >> (PathName & "/input2sankey" & c & ".csv");
				printf "%s,%s,%.2f,%s,%s,%s\n", "Haber-Bosch" , "DHN", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										(layers_in_out["HABER_BOSCH","HEAT_LOW_T_DHN"] * F_t [c, "HABER_BOSCH", h, td]  ) / 1000 , "DHN", 
				"#FA8072", "TWh" >> (PathName & "/input2sankey" & c & ".csv");
				printf "%s,%s,%.2f,%s,%s,%s\n", "Haber-Bosch" , "Ammonia", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										(layers_in_out["HABER_BOSCH","AMMONIA"] * F_t [c, "HABER_BOSCH", h, td]  ) / 1000 , "Ammonia", 
				"#000ECD", "TWh" >> (PathName & "/input2sankey" & c & ".csv");
			}	
			
				# AMMONIA to CCGT_AMMONIA
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (F_t [c, "CCGT_AMMONIA", h, td]  ) > 10 then {
				printf "%s,%s,%.2f,%s,%s,%s\n", "Ammonia" , "CCGT", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										(-layers_in_out["CCGT_AMMONIA","AMMONIA"] * F_t [c, "CCGT_AMMONIA", h, td]  ) / 1000 , "Ammonia", 
				"#000ECD", "TWh" >> (PathName & "/input2sankey" & c & ".csv");
			}	
			
				# CCGT_AMMONIA to ELEC
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (F_t [c, "CCGT_AMMONIA", h, td]  ) > 10 then {
				printf "%s,%s,%.2f,%s,%s,%s\n", "CCGT" , "Elec", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										(layers_in_out["CCGT_AMMONIA","ELECTRICITY"] * F_t [c, "CCGT_AMMONIA", h, td]  ) / 1000 , "Electricity", 
				"#00BFFF", "TWh" >> (PathName & "/input2sankey" & c & ".csv");
			}
			
				# AMMONIA to H2
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (F_t [c, "AMMONIA_TO_H2", h, td]  ) > 10 then {
				printf "%s,%s,%.2f,%s,%s,%s\n", "Ammonia" , "H2", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										(-layers_in_out["AMMONIA_TO_H2","AMMONIA"] * F_t [c, "AMMONIA_TO_H2", h, td]  ) / 1000 , "H2",
				"#FF00FF", "TWh" >> (PathName & "/input2sankey" & c & ".csv");
			}
			
				# AMMONIA to NED
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (End_uses [c, "AMMONIA", h, td]  ) > 10 then {
				printf "%s,%s,%.2f,%s,%s,%s\n", "Ammonia" , "Non-energy demand", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										End_uses [c, "AMMONIA", h, td]   / 1000 , "Ammonia", 
				"#000ECD", "TWh" >> (PathName & "/input2sankey" & c & ".csv");
			}
			
			
			## Methanol
				#METHANOL imports  --> METHANOL
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"METHANOL", h, td] + R_t_local [c,"METHANOL", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Methanol imports" , "Methanol", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["METHANOL","METHANOL"] * R_t_exterior [c,"METHANOL", h, td] + layers_in_out["METHANOL","METHANOL"] * R_t_local [c,"METHANOL", h, td] ) / 1000 ,
			"Methanol", "#CC0066", "TWh" 
			> ( PathName & "/input2sankey" & c & ".csv");
			
				#METHANOL RE  --> METHANOL
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"METHANOL_RE", h, td] + R_t_local [c,"METHANOL_RE", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Methanol RE" , "Methanol", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["METHANOL_RE","METHANOL"] * R_t_exterior [c,"METHANOL_RE", h, td] + layers_in_out["METHANOL_RE","METHANOL"] * R_t_local [c,"METHANOL_RE", h, td] ) / 1000 , 
			"Methanol", "#CC0066", "TWh" 
			> ( PathName & "/input2sankey" & c & ".csv");
			
				# METHANOL_TO_NED
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (End_uses [c, "METHANOL", h, td]  ) > 10 then {
				printf "%s,%s,%.2f,%s,%s,%s\n", "Methanol" , "Non-energy demand", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										End_uses [c, "METHANOL", h, td]   / 1000 , "Methanol", 
				"#CC0066", "TWh" >> (PathName & "/input2sankey" & c & ".csv");
				
				# Methanol -> Mob priv
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
			(F_t [c, "CAR_METHANOL", h, td] ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Methanol" , "Mob priv",
				sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
				(-layers_in_out["CAR_METHANOL","METHANOL"] * F_t [c, "CAR_METHANOL", h, td]) / 1000
				, "Methanol", "#CC0066", "TWh" >> (PathName & "/input2sankey" & c & ".csv");
				
				# Methanol --> Freight
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
			((F_t [c, "BOAT_FREIGHT_METHANOL", h, td] + F_t [c, "TRUCK_METHANOL", h, td])) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Methanol" , "Freight",
				sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
				(-layers_in_out["BOAT_FREIGHT_METHANOL","METHANOL"] * F_t [c, "BOAT_FREIGHT_METHANOL", h, td]
				- layers_in_out["TRUCK_METHANOL","METHANOL"] * F_t [c, "TRUCK_METHANOL", h, td]) / 1000
				, "Methanol", "#CC0066", "TWh" > (PathName & "/input2sankey" & c & ".csv");

			
			## HVC
				# OIL_TO_HVC
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (F_t [c, "OIL_TO_HVC", h, td]  ) > 10 then {
				printf "%s,%s,%.2f,%s,%s,%s\n", "Oil", "NSC", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										(-layers_in_out["OIL_TO_HVC","LFO"] * F_t [c, "OIL_TO_HVC", h, td]  ) / 1000 , "Naphtha", 
				"#8B008B", "TWh" >> (PathName & "/input2sankey" & c & ".csv");
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "NSC", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										(-layers_in_out["OIL_TO_HVC","ELECTRICITY"] * F_t [c, "OIL_TO_HVC", h, td]  ) / 1000 , "Electricity", 
				"#00BFFF", "TWh" >> (PathName & "/input2sankey" & c & ".csv");
				printf "%s,%s,%.2f,%s,%s,%s\n", "Heat HT" , "NSC", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
					TYPICAL_DAY_OF_PERIOD[t]}(- layers_in_out["OIL_TO_HVC","HEAT_HIGH_T"] * F_t [c, "OIL_TO_HVC", h, td]  ) / 1000 ,
					"Heat HT", "#DC143C", "TWh" >> (PathName & "/input2sankey" & c & ".csv");
				printf "%s,%s,%.2f,%s,%s,%s\n", "NSC", "HVC", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										(layers_in_out["OIL_TO_HVC","HVC"] * F_t [c, "OIL_TO_HVC", h, td]  ) / 1000 , "HVC", 
				"#00FFFF", "TWh" >> (PathName & "/input2sankey" & c & ".csv");
				}

				# GAS_TO_HVC
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c, "GAS_TO_HVC", h, td]  ) > 10 then {
				printf "%s,%s,%.2f,%s,%s,%s\n", "Gas" , "OCM", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
					TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["GAS_TO_HVC","GAS"] * F_t [c, "GAS_TO_HVC", h, td]  ) / 1000 , "Gas", "#FFD700", "TWh" >> 
					(PathName & "/input2sankey" & c & ".csv");
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "OCM", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
					TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["GAS_TO_HVC","ELECTRICITY"] * F_t [c, "GAS_TO_HVC", h, td]  ) / 1000 , "Electricity", "#00BFFF", "TWh" >> 
					(PathName & "/input2sankey" & c & ".csv");
				printf "%s,%s,%.2f,%s,%s,%s\n", "OCM" , "HVC", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
					TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["GAS_TO_HVC","HVC"] * F_t [c, "GAS_TO_HVC", h, td]  ) / 1000 , "HVC", "#00FFFF", "TWh" >> 
					(PathName & "/input2sankey" & c & ".csv");
				}
				
				# BIOMASS_TO_HVC
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c, "BIOMASS_TO_HVC", h, td]  ) > 10 then {
				printf "%s,%s,%.2f,%s,%s,%s\n", "Wood" , "Gasifi. to HVC", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
					TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["BIOMASS_TO_HVC","WOOD"] * F_t [c, "BIOMASS_TO_HVC", h, td]  ) / 1000 , "Wood", "#CD853F", "TWh" >> 
					(PathName & "/input2sankey" & c & ".csv");
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Gasifi. to HVC", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
					TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["BIOMASS_TO_HVC","ELECTRICITY"] * F_t [c, "BIOMASS_TO_HVC", h, td]  ) / 1000 , "Electricity", "#00BFFF", "TWh" >> 
					(PathName & "/input2sankey" & c & ".csv");
				printf "%s,%s,%.2f,%s,%s,%s\n", "Heat HT" , "Gasifi. to HVC", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
					TYPICAL_DAY_OF_PERIOD[t]}(- layers_in_out["BIOMASS_TO_HVC","HEAT_HIGH_T"] * F_t [c, "BIOMASS_TO_HVC", h, td]  ) / 1000 ,
					"Heat HT", "#DC143C", "TWh" >> (PathName & "/input2sankey" & c & ".csv");
				printf "%s,%s,%.2f,%s,%s,%s\n", "Gasifi. to HVC" , "HVC", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
					TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["BIOMASS_TO_HVC","HVC"] * F_t [c, "BIOMASS_TO_HVC", h, td]  ) / 1000 , "HVC", "#00FFFF", "TWh" >> 
					(PathName & "/input2sankey" & c & ".csv");
				}

				# METHANOL_TO_HVC
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c, "METHANOL_TO_HVC", h, td]  ) > 10 then {
				printf "%s,%s,%.2f,%s,%s,%s\n", "Methanol" , "MTO", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
					TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["METHANOL_TO_HVC","METHANOL"] * F_t [c, "METHANOL_TO_HVC", h, td]  ) / 1000 , "Methanol", "#CC0066", "TWh" >> 
					(PathName & "/input2sankey" & c & ".csv");
				printf "%s,%s,%.2f,%s,%s,%s\n", "Heat HT" , "MTO", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
					TYPICAL_DAY_OF_PERIOD[t]}(- layers_in_out["METHANOL_TO_HVC","HEAT_HIGH_T"] * F_t [c, "METHANOL_TO_HVC", h, td]  ) / 1000 ,
					"Heat HT", "#DC143C", "TWh" >> (PathName & "/input2sankey" & c & ".csv");
				printf "%s,%s,%.2f,%s,%s,%s\n", "MTO" , "HVC", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
					TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["METHANOL_TO_HVC","HVC"] * F_t [c, "METHANOL_TO_HVC", h, td]  ) / 1000 , "HVC", "#00FFFF", "TWh" >> 
					(PathName & "/input2sankey" & c & ".csv");
				}
				
				
				# HVC_TO_NED
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (End_uses [c, "HVC", h, td]  ) > 10 then {
				printf "%s,%s,%.2f,%s,%s,%s\n", "HVC" , "Non-energy demand", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
										End_uses [c, "HVC", h, td]   / 1000 , "HVC", "#00FFFF", "TWh"
				>> (PathName & "/input2sankey" & c & ".csv");
			}
			
			## Electricity production
			
			#Elec import from outside system
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(R_t_exterior [c,"ELECTRICITY", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Electricity" , "Elec", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["ELECTRICITY","ELECTRICITY"] * R_t_exterior [c,"ELECTRICITY", h, td]  ) / 1000 , 
			"Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
				
				#Uranium --> Elec
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"NUCLEAR", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Nuclear" , "Elec", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["NUCLEAR","ELECTRICITY"] * F_t [c,"NUCLEAR", h, td]  ) / 1000 , "Nuclear", 
			"#FFC0CB", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
				
				#WindOn --> Elec
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F[c,"WIND_ONSHORE"]*c_p_t["WIND_ONSHORE",c,h,td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Wind Onshore" , "Elec", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["WIND_ONSHORE","ELECTRICITY"] * F[c,"WIND_ONSHORE"]*c_p_t["WIND_ONSHORE",c,h,td]  ) / 1000 , "Wind Onshore", "#27AE34", "TWh" 
			> ( PathName & "/input2sankey" & c & ".csv");
				
				#WindOff --> Elec
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F[c,"WIND_OFFSHORE"]*c_p_t["WIND_OFFSHORE",c,h,td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Wind Offshore" , "Elec", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["WIND_OFFSHORE","ELECTRICITY"] * F[c,"WIND_OFFSHORE"]*c_p_t["WIND_OFFSHORE",c,h,td]  ) / 1000 , "Wind Offshore", "#27AE34", "TWh" 
			> ( PathName & "/input2sankey" & c & ".csv");
			
				#HydroDam --> Dam Sto
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"HYDRO_DAM", h, td] )  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Hydro Dams" , "Dam Sto", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["HYDRO_DAM","ELECTRICITY"] * F_t [c,"HYDRO_DAM", h, td]  ) / 1000 , "Hydro Dam", "#00CED1", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");
			
				#Dam Sto --> Elec
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"HYDRO_DAM", h, td] )  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Dam Sto" , "Elec", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(Storage_out[c, "DAM_STORAGE", "ELECTRICITY", h, td] / storage_eff_out ["DAM_STORAGE", "ELECTRICITY"]) / 1000 , "Hydro Dam", "#00CED1", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");
				
				#HydroRiver --> Elec
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"HYDRO_RIVER", h, td] )  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Hydro River" , "Elec", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["HYDRO_RIVER","ELECTRICITY"] * F_t [c,"HYDRO_RIVER", h, td]   ) / 1000 , "Hydro River", "#0000FF", 
			"TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
				#Ocean --> Elec
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
			(F_t [c,"NEW_TIDAL_STREAM", h, td] + F_t [c,"TIDAL_STREAM", h, td] + F_t [c,"TIDAL_RANGE", h, td] + F_t [c,"WAVE", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Ocean" , "Elec",
				sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
				(layers_in_out["NEW_TIDAL_STREAM","ELECTRICITY"] * F_t [c,"NEW_TIDAL_STREAM", h, td]
				+ layers_in_out["TIDAL_STREAM","ELECTRICITY"] * F_t [c,"TIDAL_STREAM", h, td]
				+ layers_in_out["TIDAL_RANGE","ELECTRICITY"] * F_t [c,"TIDAL_RANGE", h, td]
				+ layers_in_out["WAVE","ELECTRICITY"] * F_t [c,"WAVE", h, td]) / 1000 ,
				"Ocean", " #2549a3", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
				
				#Coal --> Elec
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"COAL_US", h, td] + F_t [c,"COAL_IGCC", h, td]) ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Coal" , "Elec", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["COAL_US","COAL"] * F_t [c,"COAL_US", h, td]   - layers_in_out["COAL_IGCC","COAL"] 
			* F_t [c,"COAL_IGCC", h, td]  ) / 1000 , "Coal", "#A0522D", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"IND_BOILER_COAL", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Coal" , "Boilers", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["IND_BOILER_COAL","COAL"] * F_t [c,"IND_BOILER_COAL", h, td]  ) / 1000 , "Coal", 
			"#A0522D", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
				# Solar --> Elec
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F [c,"PV"] *c_p_t["PV",c,h,td] ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Solar PV" , "Elec", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["PV","ELECTRICITY"] * F [c,"PV"] *c_p_t["PV",c,h,td] ) / 1000 , "Solar", "#FFFF00", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");
				
				
				# Solar --> CSP Sto.
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
			(Storage_in[c, "PT_STORAGE", "PT_HEAT", h, td] + Storage_in[c, "ST_STORAGE", "ST_HEAT", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Solar" , "CSP Sto.",
				sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
				(Storage_in[c, "PT_STORAGE", "PT_HEAT", h, td] + Storage_in[c, "ST_STORAGE", "ST_HEAT", h, td])/ 1000
				, "Solar", "#FFFF00", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
				# Solar --> CSP (power block)
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
			(F [c,"PT_COLLECTOR"] *c_p_t["PT_COLLECTOR",c,h,td] + F [c,"ST_COLLECTOR"] *c_p_t["ST_COLLECTOR",c,h,td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Solar" , "CSP",
				sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
				((F [c,"PT_COLLECTOR"] *c_p_t["PT_COLLECTOR",c,h,td] + F [c,"ST_COLLECTOR"] *c_p_t["ST_COLLECTOR",c,h,td])
				- (Storage_in[c, "PT_STORAGE", "PT_HEAT", h, td] + Storage_in[c, "ST_STORAGE", "ST_HEAT", h, td]))/ 1000
				,"Solar", "#FFFF00", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
				
				# CSP Sto. --> CSP power block 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
			(Storage_out[c, "PT_STORAGE", "PT_HEAT", h, td] + Storage_out[c, "ST_STORAGE", "ST_HEAT", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "CSP Sto." , "CSP",
				sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
				(Storage_out[c, "PT_STORAGE", "PT_HEAT", h, td] / storage_eff_out ["PT_STORAGE", "PT_HEAT"] 
				+ Storage_out[c, "ST_STORAGE", "ST_HEAT", h, td] / storage_eff_out ["ST_STORAGE", "ST_HEAT"])/ 1000
				, "Solar", "#FFFF00", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
				
				# CSP Sto. --> Loss
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
			(Storage_in[c, "PT_STORAGE", "PT_HEAT", h, td] + Storage_in[c, "ST_STORAGE", "ST_HEAT", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "CSP Sto." , "Loss",
				sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
				(((Storage_in[c, "PT_STORAGE", "PT_HEAT", h, td]) - (Storage_out[c, "PT_STORAGE", "PT_HEAT", h, td] / storage_eff_out ["PT_STORAGE", "PT_HEAT"]))
				+ ((Storage_in[c, "ST_STORAGE", "ST_HEAT", h, td]) - (Storage_out[c, "ST_STORAGE", "ST_HEAT", h, td] / storage_eff_out ["ST_STORAGE", "ST_HEAT"])))/ 1000
				, "Solar", "#FFFF00", "TWh" > ( PathName & "/input2sankey" & c & ".csv");

				# CSP (power block) --> Electricity
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
			(F_t [c, "PT_POWER_BLOCK", h, td] + F_t [c, "ST_POWER_BLOCK", h, td] + F_t [c, "STIRLING_DISH", h, td] ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "CSP" , "Elec",
				sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
				( layers_in_out["PT_POWER_BLOCK","ELECTRICITY"] * F_t [c, "PT_POWER_BLOCK", h, td] 
				+ layers_in_out["ST_POWER_BLOCK","ELECTRICITY"] * F_t [c, "ST_POWER_BLOCK", h, td] 
				+ layers_in_out["STIRLING_DISH","ELECTRICITY"] * F_t [c, "STIRLING_DISH", h, td])/ 1000
				, "Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
				
				# Solar --> Heat LT Dec 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"DEC_SOLAR", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Solar" , "Heat LT Dec", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
					(layers_in_out["DEC_SOLAR","HEAT_LOW_T_DECEN"] * (F_t [c,"DEC_SOLAR", h, td])# SUPPRESSED # - Solar_excess [ h, td] ) 
					-((max(Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_DIRECT_ELEC"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_HP_ELEC"      ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_THHP_GAS"     ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_BOILER_GAS"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_BOILER_WOOD"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_BOILER_OIL"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_COGEN_GAS"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_ADVCOGEN_GAS" ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_COGEN_OIL"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_ADVCOGEN_H2"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] )))
					)/ 1000
					, "Solar", "#FFFF00", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			# Solar --> Dec Sto.
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"DEC_SOLAR", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Solar" , "Dec. Sto", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
					((max(Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_DIRECT_ELEC"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_HP_ELEC"      ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_THHP_GAS"     ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_BOILER_GAS"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_BOILER_WOOD"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_BOILER_OIL"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_COGEN_GAS"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_ADVCOGEN_GAS" ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_COGEN_OIL"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] ))+
					  (max(Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_ADVCOGEN_H2"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] ))
					)/ 1000
					, "Solar", "#FFFF00", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
			#Solar --> DHN 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c, "DHN_SOLAR", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Solar" , "DHN", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["DHN_SOLAR","HEAT_LOW_T_DHN"] * F [c, "DHN_SOLAR"] * c_p_t["DHN_SOLAR",c, h,td]  ) / 1000 , "Solar", "#FFFF00", "TWh" > #From F_t -> F <=> taking into account curtailment
			( PathName & "/input2sankey" & c & ".csv");
			
			
			# Geothermal --> Elec
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"GEOTHERMAL", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Geothermal" , "Elec", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["GEOTHERMAL","ELECTRICITY"] * F_t [c,"GEOTHERMAL", h, td]  ) / 1000 , "Geothermal", 
			"#FF0000", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			# Geothermal --> DHN
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"DHN_DEEP_GEO", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Geothermal" , "DHN", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["DHN_DEEP_GEO","HEAT_LOW_T_DHN"] * F_t [c,"DHN_DEEP_GEO", h, td]  ) / 1000 , 
			"Geothermal", "#FF0000", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
			# Waste --> CHP
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"IND_COGEN_WASTE", h, td] + F_t 
			[c,"DHN_COGEN_WASTE", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Waste" , "CHP", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["IND_COGEN_WASTE","WASTE"] * F_t [c,"IND_COGEN_WASTE", h, td]   
			-layers_in_out["DHN_COGEN_WASTE","WASTE"] * F_t [c,"DHN_COGEN_WASTE", h, td]  ) / 1000 , "Waste", "#808000", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");
			# Waste --> Boilers	
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"IND_BOILER_WASTE", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Waste" , "Boilers", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["IND_BOILER_WASTE","WASTE"] * F_t [c,"IND_BOILER_WASTE", h, td]  ) / 1000 , 
			"Waste", "#808000", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
			#Wet biomass --> CHP
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"DHN_COGEN_WET_BIOMASS", h, td] + F_t [c,"DHN_COGEN_BIO_HYDROLYSIS", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Wet Biomass" , "CHP", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["DHN_COGEN_WET_BIOMASS","WET_BIOMASS"] * F_t [c,"DHN_COGEN_WET_BIOMASS", h, td] -layers_in_out["DHN_COGEN_BIO_HYDROLYSIS","WET_BIOMASS"] * F_t [c,"DHN_COGEN_BIO_HYDROLYSIS", h, td]  ) / 1000 , "Wet Biomass", "#336600", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");
			
			#Wet biomass --> GAS_RE
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"BIOMETHANATION", h, td] + F_t [c,"BIO_HYDROLYSIS", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Wet Biomass" , "Gas", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["BIOMETHANATION","WET_BIOMASS"] * F_t [c,"BIOMETHANATION", h, td] -layers_in_out["BIO_HYDROLYSIS","WET_BIOMASS"] * F_t [c,"BIO_HYDROLYSIS", h, td]) / 1000 , "Wet Biomass", "#336600", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");
			
			
			# Oil --> CHP
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"DEC_COGEN_OIL", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Oil" , "CHP", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["DEC_COGEN_OIL","LFO"] * F_t [c,"DEC_COGEN_OIL", h, td]  ) / 1000 , "Oil", 
			"#8B008B", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			# Oil --> Boilers 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"IND_BOILER_OIL", h, td] + F_t [c,"DHN_BOILER_OIL", 
			h, td] + F_t [c,"DEC_BOILER_OIL", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Oil" , "Boilers", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["IND_BOILER_OIL","LFO"] * F_t [c,"IND_BOILER_OIL", h, td]   - 
			layers_in_out["DHN_BOILER_OIL","LFO"] * F_t [c,"DHN_BOILER_OIL", h, td]   - layers_in_out["DEC_BOILER_OIL","LFO"] * 
			F_t [c,"DEC_BOILER_OIL", h, td]  ) / 1000 , "Oil", "#8B008B", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			#Oil --> Non-Energy
			
			
			# Wood --> H2
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"H2_BIOMASS", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Wood" , "H2", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["H2_BIOMASS","WOOD"] * F_t [c,"H2_BIOMASS", h, td]  ) / 1000 , "Wood", "#CD853F", 
			"TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
			# Wood --> GAS_RE
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"GASIFICATION_SNG", h, td] )  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Wood" , "Gas", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["GASIFICATION_SNG","WOOD"] * F_t [c,"GASIFICATION_SNG", h, td]) / 1000 , "Wood", "#CD853F", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");	
			
			# Wood --> LFO
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"PYROLYSIS_TO_LFO", h, 
			td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Wood" , "Oil", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}( -layers_in_out["PYROLYSIS_TO_LFO","WOOD"] * F_t [c,"PYROLYSIS_TO_LFO", h, td]  ) / 1000 , "Wood", "#CD853F", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");	
			
			# Wood --> DIESEL (only the share of wood that produces diesel)
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"PYROLYSIS_TO_FUELS", h, 
			td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Wood" , "DIESEL", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}( -layers_in_out["PYROLYSIS_TO_FUELS","WOOD"] *
			(layers_in_out["PYROLYSIS_TO_FUELS","DIESEL"]/(layers_in_out["PYROLYSIS_TO_FUELS","DIESEL"] + layers_in_out["PYROLYSIS_TO_FUELS","GASOLINE"]))
			* F_t [c,"PYROLYSIS_TO_FUELS", h, td]  ) / 1000 , "Wood", "#CD853F", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");
			
			# Wood --> GASOLINE (only gasoline share of wood)
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"PYROLYSIS_TO_FUELS", h, 
			td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Wood" , "GASOLINE", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}( -layers_in_out["PYROLYSIS_TO_FUELS","WOOD"] *
			(layers_in_out["PYROLYSIS_TO_FUELS","GASOLINE"]/(layers_in_out["PYROLYSIS_TO_FUELS","DIESEL"] + layers_in_out["PYROLYSIS_TO_FUELS","GASOLINE"]))
			* F_t [c,"PYROLYSIS_TO_FUELS", h, td]  ) / 1000 , "Wood", "#CD853F", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");		
			
			# Wood --> METHANOL
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"BIOMASS_TO_METHANOL", h, 
			td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Wood" , "Methanol", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}( -layers_in_out["BIOMASS_TO_METHANOL","WOOD"] * F_t [c,"BIOMASS_TO_METHANOL", h, td]  ) / 1000 , "Wood", "#CD853F", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");		
			
			
			# Wood --> CHP
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"IND_COGEN_WOOD", h, td] + F_t [c,"DHN_COGEN_WOOD", 
			h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Wood" , "CHP", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["IND_COGEN_WOOD","WOOD"] * F_t [c,"IND_COGEN_WOOD", h, td]   - 
			layers_in_out["DHN_COGEN_WOOD","WOOD"] * F_t [c,"DHN_COGEN_WOOD", h, td]  ) / 1000 , "Wood", "#CD853F", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");
			# Wood --> Boilers 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"IND_BOILER_WOOD", h, td] + F_t 
			[c,"DHN_BOILER_WOOD", h, td] + F_t [c,"DEC_BOILER_WOOD", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Wood" , "Boilers", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["IND_BOILER_WOOD","WOOD"] * F_t [c,"IND_BOILER_WOOD", h, td]   - 
			layers_in_out["DHN_BOILER_WOOD","WOOD"] * F_t [c,"DHN_BOILER_WOOD", h, td]   - layers_in_out["DEC_BOILER_WOOD","WOOD"] * 
			F_t [c,"DEC_BOILER_WOOD", h, td]  ) / 1000 , "Wood", "#CD853F", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
			
			#------------------------------------------
			# SANKEY - Electricity use
			#------------------------------------------
				#Elec --> EVs batt
			if sum{i in EVs_BATT, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Storage_in[c, i, "ELECTRICITY", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "EVs batt",
				sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
				(sum {i in EVs_BATT} (Storage_in[c, i, "ELECTRICITY", h, td])) / 1000
				, "Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
				#EVs batt --> Mob Priv 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"CAR_PHEV", h, td] + F_t [c,"CAR_BEV", h, td]) ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "EVs batt" , "Mob priv", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["CAR_PHEV","ELECTRICITY"] * F_t [c,"CAR_PHEV", h, td]   - 
			layers_in_out["CAR_BEV","ELECTRICITY"] * F_t [c,"CAR_BEV", h, td]  ) / 1000 , "Electricity", "#00BFFF", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");
			
				#EVs batt --> Elec Demand
			if sum{i in EVs_BATT, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Storage_in[c, i, "ELECTRICITY", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "EVs batt" , "Elec demand",
				sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
				(sum {i in EVs_BATT} (Storage_out[c, i, "ELECTRICITY", h, td] / storage_eff_out [i, "ELECTRICITY"])
				-(-layers_in_out["CAR_PHEV","ELECTRICITY"] * F_t [c,"CAR_PHEV", h, td]- layers_in_out["CAR_BEV","ELECTRICITY"] * F_t [c,"CAR_BEV", h, td])) / 1000
				, "Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
				
				#EVS batt --> Loss
			if sum{i in EVs_BATT, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Storage_in[c, i, "ELECTRICITY", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "EVs batt" , "Loss", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
				(sum {i in EVs_BATT}((Storage_in[c, i, "ELECTRICITY", h, td])- (Storage_out[c, i, "ELECTRICITY", h, td] / storage_eff_out [i,"ELECTRICITY"])))/ 1000
				, "Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
				
				#Elec --> Mob Pub 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"TRAIN_PUB", h, td] + F_t [c,"TRAMWAY_TROLLEY", h, 
			td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Mob public", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["TRAIN_PUB","ELECTRICITY"] * F_t [c,"TRAIN_PUB", h, td]   - 
			layers_in_out["TRAMWAY_TROLLEY","ELECTRICITY"] * F_t [c,"TRAMWAY_TROLLEY", h, td]  ) / 1000 , "Electricity", "#00BFFF", 
			"TWh" > ( PathName & "/input2sankey" & c & ".csv");
				
				#Elec --> Freight 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"TRAIN_FREIGHT", h, td] + F_t [c,"TRUCK_ELEC", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Freight", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["TRAIN_FREIGHT","ELECTRICITY"] * F_t [c,"TRAIN_FREIGHT", h, td] -layers_in_out["TRUCK_ELEC","ELECTRICITY"] * F_t [c,"TRUCK_ELEC", h, td] ) / 1000 , 
			"Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
				
				#Elec --> Loss
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Network_losses [c,"ELECTRICITY", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Loss", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Network_losses 
			[c,"ELECTRICITY", h, td]    ) / 1000 
			, "Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
				
				#Elec --> Elec Demand 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(End_uses [c,"ELECTRICITY", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Elec demand", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((End_uses 
			[c,"ELECTRICITY", h, td]  - Network_losses [c,"ELECTRICITY", h, td] - sum {i in STORAGE_OF_END_USES_TYPE["ELECTRICITY"]} (Storage_out[c, i, "ELECTRICITY", h, td]))   
			)/ 1000 , "Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey" & c & ".csv");

# Neglected because very small	
			#/!\ NOT UP TO DATE /!\
#				#Elec --> SLF	
#			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"SYN_METHANOLATION", h, td]  ) > 10 then
#				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "SLF", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
#			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["SYN_METHANOLATION","ELECTRICITY"] * F_t [c,"SYN_METHANOLATION", h, td]   ) / 1000 , 
#			"Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey" & c & ".csv");	
			
			
			#New boxes for Space Cooling and Process Cooling	
			
				#Elec --> Cold 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"BIG_SPLIT", h, td]   ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Cold", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["BIG_SPLIT","ELECTRICITY"] * F_t [c,"BIG_SPLIT", h, td] ) / 1000 , 
			"Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
				#Elec --> Chiller
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"CHILLER_WC",h,td]  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Chiller", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["CHILLER_WC","ELECTRICITY"] * F_t [c,"CHILLER_WC", h, td] ) / 1000 , 
			"Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey" & c & ".csv");		
				
				
				# Elec --> Storage 
			if sum{i in STORAGE_OF_END_USES_TYPE["ELECTRICITY"], t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Storage_in[c, i, "ELECTRICITY", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Storage", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
				(sum {i in STORAGE_OF_END_USES_TYPE["ELECTRICITY"] }(Storage_in[c, i, "ELECTRICITY", h, td]))/ 1000
			, "Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
				
				# Storage --> Elec Demand 
			if sum{i in STORAGE_OF_END_USES_TYPE["ELECTRICITY"], t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Storage_in[c, i, "ELECTRICITY", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Storage" , "Elec demand", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(sum {i 
			in STORAGE_OF_END_USES_TYPE["ELECTRICITY"] }                                                        (Storage_out[c, i, "ELECTRICITY", h, td] / storage_eff_out [i, 
			"ELECTRICITY"])  )/ 1000 , "Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
				
				#Storage --> Loss
			if sum{i in STORAGE_OF_END_USES_TYPE["ELECTRICITY"], t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Storage_in[c, i, "ELECTRICITY", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Storage" , "Loss", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (sum {i 
			in STORAGE_OF_END_USES_TYPE["ELECTRICITY"] }((Storage_in[c, i, "ELECTRICITY", h, td])- (Storage_out[c, i, "ELECTRICITY", h, td] / storage_eff_out [i, 
			"ELECTRICITY"]))  )/ 1000 , "Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey" & c & ".csv");

				#Elec --> HP 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"DHN_HP_ELEC", h, td] + F_t [c,"DEC_HP_ELEC", h, 
			td]) ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "HPs", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["DHN_HP_ELEC","ELECTRICITY"] * F_t [c,"DHN_HP_ELEC", h, td]   - 
			layers_in_out["DEC_HP_ELEC","ELECTRICITY"] * F_t [c,"DEC_HP_ELEC", h, td]  ) / 1000 , "Electricity", "#00BFFF", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");
				
				#Elec --> H2 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"H2_ELECTROLYSIS", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "H2", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["H2_ELECTROLYSIS","ELECTRICITY"] * F_t [c,"H2_ELECTROLYSIS", h, td]  ) / 1000 , 
			"Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
				
				#Elec --> Heat LT Dec 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"DEC_DIRECT_ELEC", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Heat LT Dec", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["DEC_DIRECT_ELEC","HEAT_LOW_T_DECEN"] * F_t [c,"DEC_DIRECT_ELEC", h, td]  
					- ((max(Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_DIRECT_ELEC"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] )))) / 1000 
			, "Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
				
				#Elec --> Dec Sto. 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]: Storage_in[c,"TS_DEC_DIRECT_ELEC", "HEAT_LOW_T_DECEN", h, td] > Storage_out[c,"TS_DEC_DIRECT_ELEC", "HEAT_LOW_T_DECEN", h, td] } 
			    	((Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td])*(1-F_t_solar[c,"DEC_DIRECT_ELEC"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] ))) >10 then
						printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Dec. Sto", 		 
							sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} 
							((max(Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_DIRECT_ELEC"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] ))) / 1000 
						, "Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey" & c & ".csv");		
				
				#Elec --> HT Heat 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"IND_DIRECT_ELEC", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Heat HT", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["IND_DIRECT_ELEC","HEAT_HIGH_T"] * F_t [c,"IND_DIRECT_ELEC", h, td]  ) / 1000 , 
			"Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
				# Elec --> CCS
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"ATM_CCS", h, td] + F_t [c,"INDUSTRY_CCS", h, td]) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "CCS",
			sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in	TYPICAL_DAY_OF_PERIOD[t]}
			(-layers_in_out["ATM_CCS","ELECTRICITY"] * F_t [c,"ATM_CCS", h, td] - layers_in_out["ATM_CCS","ELECTRICITY"] * F_t [c,"ATM_CCS", h, td]) / 1000 , 
			"Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
			## H2 imports
				#H2 imports  --> H2
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"H2", h, td] + R_t_local [c,"H2", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "H2 imports" , "H2", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["H2","H2"] * R_t_exterior [c,"H2", h, td] + layers_in_out["H2","H2"] * R_t_local [c,"H2", h, td] ) / 1000 , "H2", 
			"#FF00FF", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
				#H2 RE  --> H2
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"H2_RE", h, td] + R_t_local [c,"H2_RE", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "H2 RE" , "H2", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["H2_RE","H2"] * R_t_exterior [c,"H2_RE", h, td] + layers_in_out["H2_RE","H2"] * R_t_local [c,"H2_RE", h, td] ) / 1000 , "H2", 
			"#FF00FF", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
			
			## H2 use
			
				#H2 --> Freight
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"TRUCK_FUEL_CELL", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "H2" , "Freight", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["TRUCK_FUEL_CELL","H2"] * F_t [c,"TRUCK_FUEL_CELL", h, td]  ) / 1000 , "H2", 
			"#FF00FF", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
				
				#H2 --> CHP 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"DEC_ADVCOGEN_H2", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "H2" , "CHP", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["DEC_ADVCOGEN_H2","H2"] * F_t [c,"DEC_ADVCOGEN_H2", h, td]  ) / 1000 , "H2", 
			"#FF00FF", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
				
				#H2 --> Mob Priv
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"CAR_FUEL_CELL", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "H2" , "Mob priv", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["CAR_FUEL_CELL","H2"] * F_t [c,"CAR_FUEL_CELL", h, td]  ) / 1000 , "H2", 
			"#FF00FF", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
				
				#H2 --> Mob Pub 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"BUS_COACH_FC_HYBRIDH2", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "H2" , "Mob public", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["BUS_COACH_FC_HYBRIDH2","H2"] * F_t [c,"BUS_COACH_FC_HYBRIDH2", h, td]  ) / 1000 , 
			"H2", "#FF00FF", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
				#H2 --> GAS_RE
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"SYN_METHANATION", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "H2" , "Gas", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["SYN_METHANATION","H2"] * F_t [c,"SYN_METHANATION", h, td]   ) / 1000 , "H2", "#FF00FF", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");
			
				#H2 --> METHANOL
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"SYN_METHANOLATION", h, td])  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "H2" , "Methanol", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(-layers_in_out["SYN_METHANOLATION","H2"] * F_t [c,"SYN_METHANOLATION", h, td]  ) / 1000 , "H2", "#FF00FF", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");			
			
			
			#------------------------------------------
			# SANKEY - HEATING
			#------------------------------------------
			
			## CHP
			#CHP --> Elec 
			if sum{i in COGEN, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [ c, i, h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "CHP" , "Elec", sum{i in COGEN, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out[i,"ELECTRICITY"] * F_t [c, i, h, td]  ) / 1000 , "Electricity", "#00BFFF", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");
			#CHP --> Heat LT Dec 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"DEC_COGEN_GAS", h, td] + F_t [c,"DEC_COGEN_OIL", h, 
			td] + F_t [c,"DEC_ADVCOGEN_GAS", h, td] + F_t [c,"DEC_ADVCOGEN_H2", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "CHP" , "Heat LT Dec", 
					sum{i in COGEN, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
						(layers_in_out[i,"HEAT_LOW_T_DECEN"] * F_t [c, i, h, td]  
						 -((max(Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_COGEN_GAS"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] ))+
							(max(Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_ADVCOGEN_GAS" ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] ))+
							(max(Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_COGEN_OIL"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] ))+
							(max(Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_ADVCOGEN_H2"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] )))
						) / 1000 
						, "Heat LT", "#FA8072", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
				#CHP --> Dec. Sto 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} 
								    ((max(Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_COGEN_GAS"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] ))+
								     (max(Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_ADVCOGEN_GAS" ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] ))+
								     (max(Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_COGEN_OIL"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] ))+
								     (max(Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_ADVCOGEN_H2"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] )))> 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "CHP" , "Dec. Sto", 
					sum{i in COGEN, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
						((max(Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_COGEN_GAS"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] ))+
							(max(Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_ADVCOGEN_GAS" ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] ))+
							(max(Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_COGEN_OIL"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] ))+
							(max(Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_ADVCOGEN_H2"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] ))
						) / 1000 
						, "Heat LT", "#FA8072", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
				#CHP --> DHN 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"DHN_COGEN_GAS", h, td] + F_t [c,"DHN_COGEN_WOOD", 
			h, td] + F_t [c,"DHN_COGEN_WASTE", h, td] + F_t [c,"DHN_COGEN_WET_BIOMASS", h, td] + F_t [c,"DHN_COGEN_BIO_HYDROLYSIS", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "CHP" , "DHN", sum{i in COGEN, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out[i,"HEAT_LOW_T_DHN"] * F_t [c, i, h, td]  ) / 1000 , "Heat LT", "#FA8072", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");
			
				#CHP --> Heat HT 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"IND_COGEN_GAS", h, td] + F_t [c,"IND_COGEN_WOOD", 
			h, td] + F_t [c,"IND_COGEN_WASTE", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "CHP" , "Heat HT", sum{i in COGEN, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out[i,"HEAT_HIGH_T"] * F_t [c, i, h, td]  ) / 1000 , "Heat HT", "#DC143C", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");
			
				# HP --> Heat LT Dec. 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"DEC_HP_ELEC", h, td] + F_t [c,"DEC_THHP_GAS", h, 
			td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "HPs" , "Heat LT Dec", 
					sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
					((layers_in_out["DEC_HP_ELEC","HEAT_LOW_T_DECEN"] * F_t [c,"DEC_HP_ELEC", h, td]   +
					layers_in_out["DEC_THHP_GAS","HEAT_LOW_T_DECEN"] * F_t [c,"DEC_THHP_GAS", h, td]  
					-((max(Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_HP_ELEC"      ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] ))+
			     	  (max(Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_THHP_GAS"     ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] )))
					) / 1000 ) 
					, "Heat LT", "#FA8072", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
				#HP --> DHN 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(F_t [c,"DHN_HP_ELEC", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "HPs" , "DHN", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}((layers_in_out["DHN_HP_ELEC","HEAT_LOW_T_DHN"] * F_t [c,"DHN_HP_ELEC", h, td]  ) / 1000  - ( 
			(Storage_in [c,"TS_DEC_HP_ELEC", "ELECTRICITY", h, td]) )/ 1000), "Heat LT", "#FA8072", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
				# HP --> Dec Sto.
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} 
			    		((max(Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_HP_ELEC"      ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] ))+
			     	    (max(Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_THHP_GAS"     ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] ))) >10 then
						printf "%s,%s,%.2f,%s,%s,%s\n", "HPs" , "Dec. Sto", 		 
							sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} 
							((max(Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_HP_ELEC"      ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] ))+
							 (max(Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_THHP_GAS"     ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] )))/1000
							,"Heat LT", "#FA8072", "TWh" > ( PathName & "/input2sankey" & c & ".csv");	
			
			
			
			
			## Biofuels

# NEglected because very small
# /!\ NOT UP TO DATE /!\			
#			#SLF --> Elec 
#			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"PYROLYSIS", h, 
#			td])  ) > 10 then
#				printf "%s,%s,%.2f,%s,%s,%s\n", "SLF" , "Elec", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
#			TYPICAL_DAY_OF_PERIOD[t]}( layers_in_out["PYROLYSIS","ELECTRICITY"] * F_t [c,"PYROLYSIS", h, td]  ) / 1000 , "Electricity", "#00BFFF", "TWh" > 
#			( PathName & "/input2sankey" & c & ".csv");
#			
#			#GAS_RE --> Elec 
#			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"GASIFICATION_SNG", h, td] + F_t [c,"BIO_HYDROLYSIS", h, td] )  ) > 10 then
#				printf "%s,%s,%.2f,%s,%s,%s\n", "Gas" , "Elec", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
#			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["GASIFICATION_SNG","ELECTRICITY"] * F_t [c,"GASIFICATION_SNG", h, td] + layers_in_out["BIO_HYDROLYSIS","ELECTRICITY"] * F_t [c,"BIO_HYDROLYSIS", h, td]   ) / 1000 , "Electricity", "#00BFFF", "TWh" > 
#			( PathName & "/input2sankey" & c & ".csv");			
			
			
			
			#GAS_RE --> DHN 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"GASIFICATION_SNG", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Gas" , "DHN", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["GASIFICATION_SNG","HEAT_LOW_T_DHN"] * F_t [c,"GASIFICATION_SNG", h, td]  ) / 1000, 
			"Heat LT", "#FA8072", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
			# Boilers--> Heat LT Dec 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"DEC_BOILER_GAS", h, td] + F_t [c,"DEC_BOILER_WOOD", 
			h, td] + F_t [c,"DEC_BOILER_OIL", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Boilers" , "Heat LT Dec", 
							sum{i in BOILERS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}
							   (layers_in_out[i,"HEAT_LOW_T_DECEN"] * F_t [c, i, h, td]  
							    -((max(Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_BOILER_GAS"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] ))+
								  (max(Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_BOILER_WOOD"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] ))+
								  (max(Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_BOILER_OIL"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] )))
									 ) / 1000 ,
						"Heat LT", "#FA8072", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
						
			#Boilers --> Dec. Sto. 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} 
								    ((max(Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_BOILER_GAS"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] ))+
								     (max(Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_BOILER_WOOD"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] ))+
								     (max(Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_BOILER_OIL"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] ))) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Boilers" , "Dec. Sto", 
								sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} 
								    ((max(Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_BOILER_GAS"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] ))+
								     (max(Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_BOILER_WOOD"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] ))+
								     (max(Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_BOILER_OIL"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] ))
								 ) / 1000 ,
						"Heat LT", "#FA8072", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
			#Boilers --> DHN 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"DHN_BOILER_GAS", h, td] + F_t [c,"DHN_BOILER_WOOD", 
			h, td] + F_t [c,"DHN_BOILER_OIL", h, td])  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Boilers" , "DHN", sum{i in BOILERS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out[i,"HEAT_LOW_T_DHN"] * F_t [c, i, h, td]  ) / 1000 , "Heat LT", "#FA8072", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");
			#Boilers --> Heat HT
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((F_t [c,"IND_BOILER_GAS", h, td] + F_t [c,"IND_BOILER_WOOD", 
			h, td] + F_t [c,"IND_BOILER_OIL", h, td] + F_t [c,"IND_BOILER_COAL", h, td] + F_t [c,"IND_BOILER_WASTE", h, td])  ) > 10 
			then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Boilers" , "Heat HT", sum{i in BOILERS, t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out[i,"HEAT_HIGH_T"] * F_t [c, i, h, td]  ) / 1000 , "Heat HT", "#DC143C", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");
			
			#Dec Sto. --> Heat LT Dec 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t], i in STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DECEN"]: Storage_in[c, i, "HEAT_LOW_T_DECEN", h, td] < Storage_out[c, i, "HEAT_LOW_T_DECEN", h, td] } 
									(Storage_out[c, i , "HEAT_LOW_T_DECEN", h, td] - Storage_in[c, i , "HEAT_LOW_T_DECEN", h, td]) > 10 then
			   printf "%s,%s,%.2f,%s,%s,%s\n", "Dec. Sto" , "Heat LT Dec", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t], i in STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DECEN"]: Storage_in[c, i, "HEAT_LOW_T_DECEN", h, td] < Storage_out[c, i, "HEAT_LOW_T_DECEN", h, td] } 
									(Storage_out[c, i , "HEAT_LOW_T_DECEN", h, td] - Storage_in[c, i , "HEAT_LOW_T_DECEN", h, td])/1000 , "Heat LT", "#FA8072", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
			# DHN --> Heat LT DHN 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(End_uses[c,"HEAT_LOW_T_DHN", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "DHN" , "Heat LT DHN", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} 
				(sum {i in TECHNOLOGIES diff STORAGE_TECH } (layers_in_out[i, "HEAT_LOW_T_DHN"] * F_t [c, i, h, td]  ) 
				- Network_losses [c,"HEAT_LOW_T_DHN", h, td]   
				- sum {i in STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"]} (Storage_in  [c, i, "HEAT_LOW_T_DHN", h, td])) / 1000
				, "Heat LT", "#FA8072", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
				
			#DHN --> DHN Loss 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Network_losses [c,"HEAT_LOW_T_DHN", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "DHN" , "Loss DHN", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Network_losses 
			[c, "HEAT_LOW_T_DHN", h, td]  ) / 1000 , "Heat LT", "#FA8072", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
			
			# DHN --> DHN storage :
			# Sto in  : sum {i in STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"],t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (Storage_in  [i, "HEAT_LOW_T_DHN", h, td])
			# Sto out : sum {i in STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"],t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (Storage_out[c, i, "HEAT_LOW_T_DHN", h, td])
			
			if sum{i in STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"],t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Storage_in  [c, i, "HEAT_LOW_T_DHN", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "DHN" , "DHN Sto", sum{i in STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"],t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (Storage_in  [c, i, "HEAT_LOW_T_DHN", h, td])/1000
				, "Heat LT", "#FA8072", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			#DHN Sto. --> Heat LT DHN 
			if sum{i in STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"],t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Storage_out  [c, i, "HEAT_LOW_T_DHN", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "DHN Sto" , "Heat LT DHN", sum{i in STORAGE_OF_END_USES_TYPE["HEAT_LOW_T_DHN"],t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (Storage_out  [c, i, "HEAT_LOW_T_DHN", h, td])/1000
				, "Heat LT", "#FA8072", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
				# Heat HT --> HT Storage 
			if sum{i in STORAGE_OF_END_USES_TYPE["HEAT_HIGH_T"], t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Storage_in[c, i, "HEAT_HIGH_T", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Heat HT" , "HT Storage", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}       (sum {i 
			in STORAGE_OF_END_USES_TYPE["HEAT_HIGH_T"] }(Storage_in[c, i, "HEAT_HIGH_T", h, td] ))/ 1000 , "Heat HT", "#DC143C", 
			"TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
			#HT Storage --> Ind Heat Demand  
			if sum{i in STORAGE_OF_END_USES_TYPE["HEAT_HIGH_T"], t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Storage_in[c, i, "HEAT_HIGH_T", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "HT Storage" , "Ind Heat Demand", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(sum {i 
			in STORAGE_OF_END_USES_TYPE["HEAT_HIGH_T"] }  (Storage_out[c, i, "HEAT_HIGH_T", h, td]  )  )/ 1000 , "Heat HT", "#DC143C", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
			#HT Storage --> Loss
			#if sum{i in STORAGE_OF_END_USES_TYPE["HEAT_HIGH_T"], t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Storage_in[c, i, "HEAT_HIGH_T", h, td]) > 10 then
			#	printf "%s,%s,%.2f,%s,%s,%s\n", "HT Storage" , "Loss", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (sum {i 
			#in STORAGE_OF_END_USES_TYPE["HEAT_HIGH_T"] }((Storage_in[c, i, "HEAT_HIGH_T", h, td])- (Storage_out[c, i, "HEAT_HIGH_T", h, td] / storage_eff_out [i, 
			#"HEAT_HIGH_T"]))  )/ 1000 , "Heat HT", "#DC143C", "TWh" > ( PathName & "/input2sankey" & c & ".csv");

			#Heat HT --> Ind Heat Demand 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(End_uses [c,"HEAT_HIGH_T", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Heat HT" , "Ind Heat Demand", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((End_uses 
			[c,"HEAT_HIGH_T", h, td] - sum {i in STORAGE_OF_END_USES_TYPE["HEAT_HIGH_T"]} (Storage_out[c, i, "HEAT_HIGH_T", h, td]))   
			)/ 1000 , "Heat HT", "#DC143C", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
			
			# Cold --> Cold Storage 
			if sum{i in STORAGE_OF_END_USES_TYPE["SPACE_COOLING"], t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Storage_in[c, i, "SPACE_COOLING", h, td]) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Cold" , "Cold Storage", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}       (sum {i 
			in STORAGE_OF_END_USES_TYPE["SPACE_COOLING"] }(Storage_in[c, i, "SPACE_COOLING", h, td]             
			)                                                                                         )/ 1000 , "Cold", "#00CED1", 
			"TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
			# Cold Storage --> Space Cooling 
			if sum{i in STORAGE_OF_END_USES_TYPE["SPACE_COOLING"], t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Storage_out[c, i, "SPACE_COOLING", h, td]) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Cold Storage" , "Space Cooling", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(sum {i 
			in STORAGE_OF_END_USES_TYPE["SPACE_COOLING"] } (Storage_out[c, i, "SPACE_COOLING", h, td]  )  )/ 1000 , "Cold", "#00CED1", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
			# Cold Storage --> Loss
			#if sum{i in STORAGE_OF_END_USES_TYPE["SPACE_COOLING"], t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(Storage_in[c, i, "SPACE_COOLING", h, td]) > 10 then
			#	printf "%s,%s,%.2f,%s,%s,%s\n", "Cold Storage" , "Cold Loss", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} (sum {i 
			#in STORAGE_OF_END_USES_TYPE["SPACE_COOLING"] }((Storage_in[c, i, "SPACE_COOLING", h, td])- (Storage_out[c, i, "SPACE_COOLING", h, td] / storage_eff_out [i, 
			#"SPACE_COOLING"]))  )/ 1000 , "Cold", "#00CED1", "TWh" > ( PathName & "/input2sankey" & c & ".csv");

			#Cold  --> Space Cooling 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(End_uses [c,"SPACE_COOLING", h, td] ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Cold" , "Space Cooling", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}((End_uses 
			[c,"SPACE_COOLING", h, td] - sum {i in STORAGE_OF_END_USES_TYPE["SPACE_COOLING"]} (Storage_out[c, i, "SPACE_COOLING", h, td]) ))  / 1000 , "Cold", "#00CED1", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
		

			#Chiller  --> Process Cooling 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(End_uses [c,"PROCESS_COOLING", h, td]  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Chiller" , "Process Cooling", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(( End_uses 
			[c,"PROCESS_COOLING", h, td]))  / 1000 , "Cold", "#00CED1", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
		
			#Elec --> Curt
			if Curt [c]  > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Curt", Curt [c] / 1000 , "Electricity", "#00BFFF", "TWh" > 
			( PathName & "/input2sankey" & c & ".csv");
			
			
			## IMPORTS 
			
			#Elec import --> Elec 
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(R_t_import [c,"ELECTRICITY", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec Import" , "Elec", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(R_t_import [c,"ELECTRICITY", h, td]  ) / 1000 , 
			"Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
			#Gas Import --> Gas
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(R_t_import [c,"GAS", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Gas Import" , "Gas", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(R_t_import [c,"GAS", h, td]  ) / 1000 , 
			"Gas", "#FFD700", "TWh" > ( PathName & "/input2sankey" & c & ".csv");

			#METHANOL Import --> METHANOL
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(R_t_import [c,"METHANOL", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Methanol Import" , "Methanol", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(R_t_import [c,"METHANOL", h, td]  ) / 1000 , 
			"Methanol", "#CC0066", "TWh" > ( PathName & "/input2sankey" & c & ".csv");

			#AMMONIA Import --> Gas
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(R_t_import [c,"AMMONIA", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Ammonia Import" , "Ammonia", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(R_t_import [c,"AMMONIA", h, td]  ) / 1000 , 
			"Ammonia", "#000ECD", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
			#Wood Import --> Wood
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(R_t_import [c,"WOOD", h, td]  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Wood Import" , "Wood", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(R_t_import [c,"WOOD", h, td]  ) / 1000 , 
			"Wood", "#CD853F", "TWh" > ( PathName & "/input2sankey" & c & ".csv");	
			
			#Waste Import --> Waste
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(R_t_import [c,"WASTE", h, td]  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Waste Import" , "Waste", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(R_t_import [c,"WASTE", h, td]  ) / 1000 , 
			"Waste", "#808000", "TWh" > ( PathName & "/input2sankey" & c & ".csv");	

			##LOCAL & EXTERIOR
			
			
				#Wood local extracted  --> Wood
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_local [c,"WOOD", h, td] )  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Local Wood" , "Wood", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["WOOD","WOOD"] * R_t_local [c,"WOOD", h, td] ) / 1000 , "Wood", "#CD853F", "TWh" 
			> ( PathName & "/input2sankey" & c & ".csv");

				#Waste local  --> Waste
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_local [c,"WASTE", h, td] )  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Local Waste" , "Waste", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["WASTE","WASTE"] * R_t_local [c,"WASTE", h, td] ) / 1000 , "Waste", "#808000", "TWh" 
			> ( PathName & "/input2sankey" & c & ".csv");
			
				#Wood exterior  --> Wood
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"WOOD", h, td] )  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Ext. Wood" , "Wood", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["WOOD","WOOD"] * R_t_exterior [c,"WOOD", h, td] ) / 1000 , "Wood", "#CD853F", "TWh" 
			> ( PathName & "/input2sankey" & c & ".csv");

				#Waste exterior  --> Wood
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} ((R_t_exterior [c,"WASTE", h, td] )  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Ext. Waste" , "Waste", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(layers_in_out["WASTE","WASTE"] * R_t_exterior [c,"WASTE", h, td] ) / 1000 , "Waste", "#808000", "TWh" 
			> ( PathName & "/input2sankey" & c & ".csv");
			
			## EXPORTS
			
				#Elec exports
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(R_t_export [c,"ELECTRICITY", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Elec" , "Elec Export", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(R_t_export [c,"ELECTRICITY", h, td]  ) / 1000 , 
			"Electricity", "#00BFFF", "TWh" > ( PathName & "/input2sankey" & c & ".csv"); 
			
			#Gas Export --> Gas
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(R_t_export [c,"GAS", h, td]  ) > 10 then
				printf "%s,%s,%.2f,%s,%s,%s\n", "Gas", "Gas Export" , sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(R_t_export[c,"GAS", h, td]  ) / 1000 , 
			"Gas", "#FFD700", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
	
				#METHANOL Export --> METHANOL
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(R_t_export [c,"METHANOL", h, td]  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Methanol", "Methanol Export" , sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(R_t_export[c,"METHANOL", h, td]  ) / 1000 , 
			"Methanol", "#CC0066", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
				#AMMONIA Export --> AMMONIA
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(R_t_export [c,"AMMONIA", h, td]  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Ammonia", "Ammonia Export" , sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(R_t_export[c,"AMMONIA", h, td]  ) / 1000 , 
			"Ammonia", "#000ECD", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
				#Wood Export --> Wood
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(R_t_export [c,"WOOD", h, td]  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Wood", "Wood Export" , sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(R_t_export[c,"WOOD", h, td]  ) / 1000 , 
			"Wood", "#CD853F", "TWh" > ( PathName & "/input2sankey" & c & ".csv");
			
			
				#Waste Export --> Waste
			if sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}(R_t_export [c,"WASTE", h, td]  ) > 10 then
			printf "%s,%s,%.2f,%s,%s,%s\n", "Waste" , "Waste Export", sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in 
			TYPICAL_DAY_OF_PERIOD[t]}(R_t_export [c,"WASTE", h, td]  ) / 1000 , 
			"Waste", "#808000", "TWh" > ( PathName & "/input2sankey" & c & ".csv");	
			

			
			
			
			#STORAGE DECENTRALISED :
			# inputs : 
			#     -Direct elec : sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} 
			#						((max(Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_DIRECT_ELEC"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] )))
			#     -HPs         : sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]}         
			#						((max(Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_HP_ELEC"      ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_THHP_GAS"     ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] )))
			#     -Boilers     : sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} 
			#					    ((max(Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_BOILER_GAS"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_BOILER_WOOD"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_BOILER_OIL"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] )))
			#	  -CHP_dec     : sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} 
			#					    ((max(Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_COGEN_GAS"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_ADVCOGEN_GAS" ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_COGEN_OIL"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td],0))*(1-F_t_solar[c,"DEC_ADVCOGEN_H2"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] )))
			#     -DEC_SOLAR   : sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t]} 
			#						((max(Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_DIRECT_ELEC"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_DIRECT_ELEC" , "HEAT_LOW_T_DECEN", h, td] ))+
			#						 (max(Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_HP_ELEC"      ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_HP_ELEC"     , "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_THHP_GAS"     ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_THHP_GAS"    , "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_BOILER_GAS"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_GAS"  , "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_BOILER_WOOD"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_WOOD" , "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_BOILER_OIL"   ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_BOILER_OIL"  , "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_COGEN_GAS"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_GAS"   , "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_ADVCOGEN_GAS" ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_GAS", "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_COGEN_OIL"    ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_COGEN_OIL"   , "HEAT_LOW_T_DECEN", h, td] ))+
			#					     (max(Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] - Storage_out[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td],0))*(  F_t_solar[c,"DEC_ADVCOGEN_H2"  ,h,td]  /max(0.0001,Storage_in[c,"TS_DEC_ADVCOGEN_H2" , "HEAT_LOW_T_DECEN", h, td] )))
			# outputs :
			# 	  -Storage_out     : sum{t in PERIODS, h in HOUR_OF_PERIOD[t], td in TYPICAL_DAY_OF_PERIOD[t], i in TS_DEC} 
			#						(max{0,Storage_out[c, i , "HEAT_LOW_T_DECEN", h, td] - Storage_in[c, i , "HEAT_LOW_T_DECEN", h, td]})

		
			}


		}# END SAVING
	}
